KIDS Distribution saved on May 30, 2021@17:32:55
Patch 12
**KIDS**:SAMI*18.0*12^

**INSTALL NAME**
SAMI*18.0*12
"BLD",11510,0)
SAMI*18.0*12^SAMI^0^3210530^y
"BLD",11510,4,0)
^9.64PA^311.14^2
"BLD",11510,4,311.12,0)
311.12
"BLD",11510,4,311.12,222)
y^y^f^^^^n
"BLD",11510,4,311.14,0)
311.14
"BLD",11510,4,311.14,222)
y^y^f^^n^^y^o^n
"BLD",11510,4,"B",311.12,311.12)

"BLD",11510,4,"B",311.14,311.14)

"BLD",11510,6.3)
1
"BLD",11510,"KRN",0)
^9.67PA^1.5^25
"BLD",11510,"KRN",.4,0)
.4
"BLD",11510,"KRN",.401,0)
.401
"BLD",11510,"KRN",.402,0)
.402
"BLD",11510,"KRN",.403,0)
.403
"BLD",11510,"KRN",.5,0)
.5
"BLD",11510,"KRN",.84,0)
.84
"BLD",11510,"KRN",1.5,0)
1.5
"BLD",11510,"KRN",1.6,0)
1.6
"BLD",11510,"KRN",1.61,0)
1.61
"BLD",11510,"KRN",1.62,0)
1.62
"BLD",11510,"KRN",3.6,0)
3.6
"BLD",11510,"KRN",3.8,0)
3.8
"BLD",11510,"KRN",9.2,0)
9.2
"BLD",11510,"KRN",9.8,0)
9.8
"BLD",11510,"KRN",9.8,"NM",0)
^9.68A^5^5
"BLD",11510,"KRN",9.8,"NM",1,0)
SAMIHOM3^^0^B136076586
"BLD",11510,"KRN",9.8,"NM",2,0)
SAMIHOM4^^0^B741921644
"BLD",11510,"KRN",9.8,"NM",3,0)
SAMIJS1^^0^B19204155
"BLD",11510,"KRN",9.8,"NM",4,0)
SAMIJS2^^0^B35653444
"BLD",11510,"KRN",9.8,"NM",5,0)
SAMIUR^^0^B560761257
"BLD",11510,"KRN",9.8,"NM","B","SAMIHOM3",1)

"BLD",11510,"KRN",9.8,"NM","B","SAMIHOM4",2)

"BLD",11510,"KRN",9.8,"NM","B","SAMIJS1",3)

"BLD",11510,"KRN",9.8,"NM","B","SAMIJS2",4)

"BLD",11510,"KRN",9.8,"NM","B","SAMIUR",5)

"BLD",11510,"KRN",19,0)
19
"BLD",11510,"KRN",19.1,0)
19.1
"BLD",11510,"KRN",101,0)
101
"BLD",11510,"KRN",409.61,0)
409.61
"BLD",11510,"KRN",771,0)
771
"BLD",11510,"KRN",779.2,0)
779.2
"BLD",11510,"KRN",870,0)
870
"BLD",11510,"KRN",8989.51,0)
8989.51
"BLD",11510,"KRN",8989.52,0)
8989.52
"BLD",11510,"KRN",8993,0)
8993
"BLD",11510,"KRN",8994,0)
8994
"BLD",11510,"KRN","B",.4,.4)

"BLD",11510,"KRN","B",.401,.401)

"BLD",11510,"KRN","B",.402,.402)

"BLD",11510,"KRN","B",.403,.403)

"BLD",11510,"KRN","B",.5,.5)

"BLD",11510,"KRN","B",.84,.84)

"BLD",11510,"KRN","B",1.5,1.5)

"BLD",11510,"KRN","B",1.6,1.6)

"BLD",11510,"KRN","B",1.61,1.61)

"BLD",11510,"KRN","B",1.62,1.62)

"BLD",11510,"KRN","B",3.6,3.6)

"BLD",11510,"KRN","B",3.8,3.8)

"BLD",11510,"KRN","B",9.2,9.2)

"BLD",11510,"KRN","B",9.8,9.8)

"BLD",11510,"KRN","B",19,19)

"BLD",11510,"KRN","B",19.1,19.1)

"BLD",11510,"KRN","B",101,101)

"BLD",11510,"KRN","B",409.61,409.61)

"BLD",11510,"KRN","B",771,771)

"BLD",11510,"KRN","B",779.2,779.2)

"BLD",11510,"KRN","B",870,870)

"BLD",11510,"KRN","B",8989.51,8989.51)

"BLD",11510,"KRN","B",8989.52,8989.52)

"BLD",11510,"KRN","B",8993,8993)

"BLD",11510,"KRN","B",8994,8994)

"DATA",311.14,1,0)
Non VA
"DATA",311.14,1,1,0)
^311.141^5^5
"DATA",311.14,1,1,1,0)
socialSecurityNumber^Patient ID
"DATA",311.14,1,1,2,0)
socialSecurityNumber.short^PID
"DATA",311.14,1,1,3,0)
socialSecurityNumber.mask
"DATA",311.14,1,1,4,0)
socialSecurityNumber.regex
"DATA",311.14,1,1,5,0)
matchingReportEnabled^false
"DATA",311.14,2,0)
VHA
"DATA",311.14,2,1,0)
^311.141^5^5
"DATA",311.14,2,1,1,0)
socialSecurityNumber^Social Security Number
"DATA",311.14,2,1,2,0)
socialSecurityNumber.short^SSN
"DATA",311.14,2,1,3,0)
socialSecurityNumber.mask^000-00-0000
"DATA",311.14,2,1,4,0)
socialSecurityNumber.regex^`(?!(000|666|9(?!99)))\d{3}-(?!00)\d{2}-(?!0000)\d{4}$
"DATA",311.14,2,1,5,0)
matchingReportEnabled^false
"FIA",311.12)
SAMI SITE
"FIA",311.12,0)
^SAMI(311.12,
"FIA",311.12,0,0)
311.12PI
"FIA",311.12,0,1)
y^y^f^^^^n
"FIA",311.12,0,10)

"FIA",311.12,0,11)

"FIA",311.12,0,"RLRO")

"FIA",311.12,0,"VR")
18.0^SAMI
"FIA",311.12,311.12)
0
"FIA",311.12,311.121)
0
"FIA",311.14)
SAMI PARAMETER DEFAULTS
"FIA",311.14,0)
^SAMI(311.14,
"FIA",311.14,0,0)
311.14
"FIA",311.14,0,1)
y^y^f^^n^^y^o^n
"FIA",311.14,0,10)

"FIA",311.14,0,11)

"FIA",311.14,0,"RLRO")

"FIA",311.14,0,"VR")
18.0^SAMI
"FIA",311.14,311.14)
0
"FIA",311.14,311.141)
0
"IX",311.12,311.12,"D",0)
311.12^D^PARAMETER VALUES^MU^^F^IR^W^311.121^^^^^LS
"IX",311.12,311.12,"D",1)
S ^SAMI(311.12,"D",X(1),X(3))=$TR(X(2),"`","^")
"IX",311.12,311.12,"D",2)
K ^SAMI(311.12,"D",X(1),X(3))
"IX",311.12,311.12,"D",2.5)
K ^SAMI(311.12,"D")
"IX",311.12,311.12,"D",11.1,0)
^.114IA^3^3
"IX",311.12,311.12,"D",11.1,1,0)
1^C^^^30^1
"IX",311.12,311.12,"D",11.1,1,1.5)
S X=$$GET1^DIQ(311.12,DA(1)_",",.02)
"IX",311.12,311.12,"D",11.1,2,0)
2^C
"IX",311.12,311.12,"D",11.1,2,1.5)
S X=$$GET1^DIQ(311.121,DA_","_DA(1)_",",.02)
"IX",311.12,311.12,"D",11.1,3,0)
3^F^311.121^.01^30^2^F
"IX",311.12,311.12,"SYM",0)
311.12^SYM^REGULAR XREF ON THE SYMBOL FIELD^R^^F^IR^I^311.12^^^^^LS
"IX",311.12,311.12,"SYM",1)
S ^SAMI(311.12,"SYM",$E(X,1,3),DA)=""
"IX",311.12,311.12,"SYM",2)
K ^SAMI(311.12,"SYM",$E(X,1,3),DA)
"IX",311.12,311.12,"SYM",2.5)
K ^SAMI(311.12,"SYM")
"IX",311.12,311.12,"SYM",11.1,0)
^.114IA^1^1
"IX",311.12,311.12,"SYM",11.1,1,0)
1^F^311.12^.02^3^1^F
"IX",311.14,311.14,"D",0)
311.14^D^PARMS^MU^^F^IR^W^311.141^^^^^LS
"IX",311.14,311.14,"D",1)
S ^SAMI(311.14,"D",X(1),X(3))=$TR(X(2),"`","^")
"IX",311.14,311.14,"D",2)
K ^SAMI(311.14,"D",X(1))
"IX",311.14,311.14,"D",2.5)
K ^SAMI(311.14,"D")
"IX",311.14,311.14,"D",11.1,0)
^.114IA^3^3
"IX",311.14,311.14,"D",11.1,1,0)
1^C^^^30^1
"IX",311.14,311.14,"D",11.1,1,1.5)
S X=$$GET1^DIQ(311.14,DA(1)_",",.01)
"IX",311.14,311.14,"D",11.1,2,0)
2^C
"IX",311.14,311.14,"D",11.1,2,1.5)
S X=$$GET1^DIQ(311.141,DA_","_DA(1)_",",.02)
"IX",311.14,311.14,"D",11.1,3,0)
3^F^311.141^.01^^2^F
"IX",311.14,311.14,"D",11.1,3,3)

"MBREQ")
0
"PKG",230,-1)
1^1
"PKG",230,0)
SAMI^SAMI^SCREENING APPLICATIONS MANAGEMENT - IELCAP
"PKG",230,22,0)
^9.49I^1^1
"PKG",230,22,1,0)
18.0^3191203
"PKG",230,22,1,"PAH",1,0)
12^3210530
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
5
"RTN","SAMIHOM3")
0^1^B136076586
"RTN","SAMIHOM3",1,0)
SAMIHOM3 ;ven/gpl - ielcap: forms ; 2019-08-07T01:13Z
"RTN","SAMIHOM3",2,0)
 ;;18.0;SAMI;;;Build 1
"RTN","SAMIHOM3",3,0)
 ;
"RTN","SAMIHOM3",4,0)
 ;@license: see routine SAMIUL
"RTN","SAMIHOM3",5,0)
 ;
"RTN","SAMIHOM3",6,0)
 ; Routine SAMIHOM3 contains subroutines for implementing the ELCAP Home
"RTN","SAMIHOM3",7,0)
 ; Page. SAMIHOM3 is further enhanced to provide binding to VistA
"RTN","SAMIHOM3",8,0)
 ; CURRENTLY UNTESTED & IN PROGRESS
"RTN","SAMIHOM3",9,0)
 ;
"RTN","SAMIHOM3",10,0)
 quit  ; no entry from top
"RTN","SAMIHOM3",11,0)
 ;
"RTN","SAMIHOM3",12,0)
 ;
"RTN","SAMIHOM3",13,0)
 ;
"RTN","SAMIHOM3",14,0)
 ;@section 0 primary development
"RTN","SAMIHOM3",15,0)
 ;
"RTN","SAMIHOM3",16,0)
 ;
"RTN","SAMIHOM3",17,0)
 ;
"RTN","SAMIHOM3",18,0)
 ;@routine-credits
"RTN","SAMIHOM3",19,0)
 ;@primary-dev: George P. Lilly (gpl)
"RTN","SAMIHOM3",20,0)
 ; gpl@vistaexpertise.net
"RTN","SAMIHOM3",21,0)
 ;@primary-dev-org: Vista Expertise Network (ven)
"RTN","SAMIHOM3",22,0)
 ; http://vistaexpertise.net
"RTN","SAMIHOM3",23,0)
 ;@copyright: 2017, gpl, all rights reserved
"RTN","SAMIHOM3",24,0)
 ;@license: Apache 2.0
"RTN","SAMIHOM3",25,0)
 ; https://www.apache.org/licenses/LICENSE-2.0.html
"RTN","SAMIHOM3",26,0)
 ;
"RTN","SAMIHOM3",27,0)
 ;@last-updated: 2018-03-07T18:48Z
"RTN","SAMIHOM3",28,0)
 ;@application: Screening Applications Management (SAM)
"RTN","SAMIHOM3",29,0)
 ;@module: Screening Applications Management - IELCAP (SAMI)
"RTN","SAMIHOM3",30,0)
 ;@suite-of-files: SAMI Forms (311.101-311.199)
"RTN","SAMIHOM3",31,0)
 ;@version: 18.0T04
"RTN","SAMIHOM3",32,0)
 ;@release-date: not yet released
"RTN","SAMIHOM3",33,0)
 ;@patch-list: none yet
"RTN","SAMIHOM3",34,0)
 ;
"RTN","SAMIHOM3",35,0)
 ;@additional-dev: Frederick D. S. Marshall (toad)
"RTN","SAMIHOM3",36,0)
 ; toad@vistaexpertise.net
"RTN","SAMIHOM3",37,0)
 ;
"RTN","SAMIHOM3",38,0)
 ;@module-credits
"RTN","SAMIHOM3",39,0)
 ;@project: VA Partnership to Increase Access to Lung Screening
"RTN","SAMIHOM3",40,0)
 ; (VA-PALS)
"RTN","SAMIHOM3",41,0)
 ; http://va-pals.org/
"RTN","SAMIHOM3",42,0)
 ;@funding: 2017/2018, Bristol-Myers Squibb Foundation (bmsf)
"RTN","SAMIHOM3",43,0)
 ; https://www.bms.com/about-us/responsibility/bristol-myers-squibb-foundation.html
"RTN","SAMIHOM3",44,0)
 ;@partner-org: Veterans Affairs Office of Rural health
"RTN","SAMIHOM3",45,0)
 ; https://www.ruralhealth.va.gov/
"RTN","SAMIHOM3",46,0)
 ;@partner-org: International Early Lung Cancer Action Program (I-ELCAP)
"RTN","SAMIHOM3",47,0)
 ; http://ielcap.com/
"RTN","SAMIHOM3",48,0)
 ;@partner-org: Paraxial Technologies
"RTN","SAMIHOM3",49,0)
 ; http://paraxialtech.com/
"RTN","SAMIHOM3",50,0)
 ;@partner-org: Open Source Electronic Health Record Alliance (OSEHRA)
"RTN","SAMIHOM3",51,0)
 ; https://www.osehra.org/groups/va-pals-open-source-project-group
"RTN","SAMIHOM3",52,0)
 ;
"RTN","SAMIHOM3",53,0)
 ;@module-log
"RTN","SAMIHOM3",54,0)
 ; 2018-01-13 ven/gpl v18.0t04 SAMIHOM3: create routine from SAMIFRM to
"RTN","SAMIHOM3",55,0)
 ; implement ELCAP Home Page.
"RTN","SAMIHOM3",56,0)
 ;
"RTN","SAMIHOM3",57,0)
 ; 2018-02-05 ven/toad v18.0t04 SAMIHOM3: update license & attribution &
"RTN","SAMIHOM3",58,0)
 ; hdr comments, add white space & do-dot quits, spell out language
"RTN","SAMIHOM3",59,0)
 ; elements.
"RTN","SAMIHOM3",60,0)
 ;
"RTN","SAMIHOM3",61,0)
 ; 2018-02-27 ven/gpl v18.0t04 SAMIHOM3: new subroutines $$PREFIX,GETHOME,
"RTN","SAMIHOM3",62,0)
 ; $$SCANFOR,WSNEWCAS,PREFILL,MKSBFORM,MKSIFORM,$$VALDTNM,
"RTN","SAMIHOM3",63,0)
 ; $$SID2NUM,$$KEYDATE,$$GENSTDID,$$NEXTNUM to support creation of new
"RTN","SAMIHOM3",64,0)
 ; cases.
"RTN","SAMIHOM3",65,0)
 ;
"RTN","SAMIHOM3",66,0)
 ; 2018-03-01 ven/toad v18.0t04 SAMIHOM3: refactor & reorganize new code,
"RTN","SAMIHOM3",67,0)
 ; add header comments, r/findReplaceAll^%wf w/findReplace^%ts.
"RTN","SAMIHOM3",68,0)
 ;
"RTN","SAMIHOM3",69,0)
 ; 2018-03-06 ven/gpl v18.0t04 SAMIHOM3: ?
"RTN","SAMIHOM3",70,0)
 ;
"RTN","SAMIHOM3",71,0)
 ; 2018-03-07 ven/toad v18.0t04 SAMIHOM3: in $$SID2NUM add
"RTN","SAMIHOM3",72,0)
 ; WSNUFORM^SAMICASE to called-by list; in keyDate,GETHOME update
"RTN","SAMIHOM3",73,0)
 ; called-by.
"RTN","SAMIHOM3",74,0)
 ;
"RTN","SAMIHOM3",75,0)
 ;@contents
"RTN","SAMIHOM3",76,0)
 ;
"RTN","SAMIHOM3",77,0)
 ;  code for SAMI homepage web service
"RTN","SAMIHOM3",78,0)
 ;
"RTN","SAMIHOM3",79,0)
 ; WSHOME: web service for SAMI homepage
"RTN","SAMIHOM3",80,0)
 ; DEVHOME: temporary home page for development
"RTN","SAMIHOM3",81,0)
 ; PATLIST: returns a list of patients in ary, passed by name
"RTN","SAMIHOM3",82,0)
 ; GETHOME: homepage accessed using GET (not subsequent visit)
"RTN","SAMIHOM3",83,0)
 ; $$SCANFOR = scan array looking for value, return index
"RTN","SAMIHOM3",84,0)
 ;
"RTN","SAMIHOM3",85,0)
 ;  code for SAMI new case web service
"RTN","SAMIHOM3",86,0)
 ;
"RTN","SAMIHOM3",87,0)
 ; WSNEWCAS: web service receives post from home & creates new case
"RTN","SAMIHOM3",88,0)
 ; $$NEXTNUM = next number for studyid
"RTN","SAMIHOM3",89,0)
 ; $$GENSTDID = studyID for number
"RTN","SAMIHOM3",90,0)
 ; $$PREFIX = letters to use to begin studyId
"RTN","SAMIHOM3",91,0)
 ; $$KEYDATE = date in StudyId format (yyyy-mm-dd)
"RTN","SAMIHOM3",92,0)
 ; $$VALDTNM = validate a new name
"RTN","SAMIHOM3",93,0)
 ; PREFILL: prefill fields for forms
"RTN","SAMIHOM3",94,0)
 ; MKSIFORM: create intake form
"RTN","SAMIHOM3",95,0)
 ; MKSBFORM: create background form
"RTN","SAMIHOM3",96,0)
 ;
"RTN","SAMIHOM3",97,0)
 ;  api $$SID2NUM^SAMIHOM3
"RTN","SAMIHOM3",98,0)
 ;
"RTN","SAMIHOM3",99,0)
 ; $$SID2NUM = number part of studyid (XXX0001 -> 1)
"RTN","SAMIHOM3",100,0)
 ;
"RTN","SAMIHOM3",101,0)
 ;
"RTN","SAMIHOM3",102,0)
 ;
"RTN","SAMIHOM3",103,0)
 ;@section 1 code for SAMI homepage web service
"RTN","SAMIHOM3",104,0)
 ;
"RTN","SAMIHOM3",105,0)
 ;
"RTN","SAMIHOM3",106,0)
 ;
"RTN","SAMIHOM3",107,0)
 ; web service for SAMI homepage
"RTN","SAMIHOM3",108,0)
WSHOME(SAMIRTN,SAMIFILTER) goto WSHOME^SAMIHOM4
"RTN","SAMIHOM3",109,0)
 ;
"RTN","SAMIHOM3",110,0)
 ;
"RTN","SAMIHOM3",111,0)
 ; vapals post web service - all calls come through this gateway
"RTN","SAMIHOM3",112,0)
WSVAPALS(SAMIARG,SAMIBODY,SAMIRESULT) goto WSVAPALS^SAMIHOM4
"RTN","SAMIHOM3",113,0)
 ;
"RTN","SAMIHOM3",114,0)
 ;
"RTN","SAMIHOM3",115,0)
DEVHOME(SAMIRTN,SAMIFILTER) goto DEVHOME^SAMIHOM4
"RTN","SAMIHOM3",116,0)
 ;
"RTN","SAMIHOM3",117,0)
 ;
"RTN","SAMIHOM3",118,0)
PATLIST(ARY) ; returns a list of patients in ary, passed by name
"RTN","SAMIHOM3",119,0)
 ;
"RTN","SAMIHOM3",120,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM3",121,0)
 ;
"RTN","SAMIHOM3",122,0)
 ;ven/gpl;private;procedure;
"RTN","SAMIHOM3",123,0)
 ;@called-by
"RTN","SAMIHOM3",124,0)
 ; DEVHOME
"RTN","SAMIHOM3",125,0)
 ;@calls
"RTN","SAMIHOM3",126,0)
 ; $$setroot^%wd
"RTN","SAMIHOM3",127,0)
 ;@input
"RTN","SAMIHOM3",128,0)
 ; ary = name of array to return patient list in
"RTN","SAMIHOM3",129,0)
 ;@output
"RTN","SAMIHOM3",130,0)
 ; @ary = array containing list of patients
"RTN","SAMIHOM3",131,0)
 ;@examples [tbd]
"RTN","SAMIHOM3",132,0)
 ;@tests [tbd]
"RTN","SAMIHOM3",133,0)
 ;
"RTN","SAMIHOM3",134,0)
 ;@stanza 2 build list of patients
"RTN","SAMIHOM3",135,0)
 ;
"RTN","SAMIHOM3",136,0)
 new GROOT set GROOT=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM3",137,0)
 ;
"RTN","SAMIHOM3",138,0)
 kill @ARY
"RTN","SAMIHOM3",139,0)
 new zi set zi=""
"RTN","SAMIHOM3",140,0)
 for  set zi=$order(@GROOT@("graph",zi)) quit:zi=""  do  ;
"RTN","SAMIHOM3",141,0)
 . set @ARY@(zi)=""
"RTN","SAMIHOM3",142,0)
 . quit
"RTN","SAMIHOM3",143,0)
 ;
"RTN","SAMIHOM3",144,0)
 ;@stanza 3 termination
"RTN","SAMIHOM3",145,0)
 ;
"RTN","SAMIHOM3",146,0)
 quit  ; end of PATLIST
"RTN","SAMIHOM3",147,0)
 ;
"RTN","SAMIHOM3",148,0)
 ;
"RTN","SAMIHOM3",149,0)
 ;
"RTN","SAMIHOM3",150,0)
 ; homepage accessed using GET
"RTN","SAMIHOM3",151,0)
GETHOME(SAMIRTN,SAMIFILTER) goto GETHOME^SAMIHOM4
"RTN","SAMIHOM3",152,0)
 ;
"RTN","SAMIHOM3",153,0)
 ;
"RTN","SAMIHOM3",154,0)
SCANFOR(ary,start,what) ; scan array looking for value
"RTN","SAMIHOM3",155,0)
 ;
"RTN","SAMIHOM3",156,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM3",157,0)
 ;
"RTN","SAMIHOM3",158,0)
 ;ven/gpl;private;function;
"RTN","SAMIHOM3",159,0)
 ;@called-by
"RTN","SAMIHOM3",160,0)
 ; GETHOME
"RTN","SAMIHOM3",161,0)
 ;@calls: none
"RTN","SAMIHOM3",162,0)
 ;@input
"RTN","SAMIHOM3",163,0)
 ;.ary = array to scan
"RTN","SAMIHOM3",164,0)
 ; start = index to begin scanning at
"RTN","SAMIHOM3",165,0)
 ; what = value to scan array for
"RTN","SAMIHOM3",166,0)
 ;@output = array index where value was found
"RTN","SAMIHOM3",167,0)
 ;@examples [tbd]
"RTN","SAMIHOM3",168,0)
 ;@tests [tbd]
"RTN","SAMIHOM3",169,0)
 ;
"RTN","SAMIHOM3",170,0)
 ;@stanza 2 scan array
"RTN","SAMIHOM3",171,0)
 ;
"RTN","SAMIHOM3",172,0)
 ;  returns the index in the array where what occurs
"RTN","SAMIHOM3",173,0)
 ;  ary is passed by reference
"RTN","SAMIHOM3",174,0)
 ;
"RTN","SAMIHOM3",175,0)
 new limit s limit=0
"RTN","SAMIHOM3",176,0)
 new %1 set %1=start
"RTN","SAMIHOM3",177,0)
 for  set %1=$order(ary(%1)) quit:+%1=0  quit:limit>1000  quit:ary(%1)[what  do  ;
"RTN","SAMIHOM3",178,0)
 . set limit=limit+1
"RTN","SAMIHOM3",179,0)
 . ;W !,ary(%1)
"RTN","SAMIHOM3",180,0)
 . quit
"RTN","SAMIHOM3",181,0)
 ;
"RTN","SAMIHOM3",182,0)
 ;@stanza 3 return & termination
"RTN","SAMIHOM3",183,0)
 n zrtn
"RTN","SAMIHOM3",184,0)
 s zrtn=%1
"RTN","SAMIHOM3",185,0)
 i %1<start s zrtn=start
"RTN","SAMIHOM3",186,0)
 i %1>1000 s zrtn=start
"RTN","SAMIHOM3",187,0)
 ;
"RTN","SAMIHOM3",188,0)
 quit zrtn ; return array index; end of $$$SCANFOR
"RTN","SAMIHOM3",189,0)
 ;
"RTN","SAMIHOM3",190,0)
 ;
"RTN","SAMIHOM3",191,0)
 ;
"RTN","SAMIHOM3",192,0)
 ;@section 2 code for SAMI new case web service
"RTN","SAMIHOM3",193,0)
 ;
"RTN","SAMIHOM3",194,0)
 ;
"RTN","SAMIHOM3",195,0)
 ;
"RTN","SAMIHOM3",196,0)
 ; receives post from home & creates new case
"RTN","SAMIHOM3",197,0)
WSNEWCAS(SAMIARGS,SAMIBODY,SAMIRESULT) goto WSNEWCAS^SAMIHOM4
"RTN","SAMIHOM3",198,0)
 ;
"RTN","SAMIHOM3",199,0)
 ;
"RTN","SAMIHOM3",200,0)
NEXTNUM() ; next number for studyid
"RTN","SAMIHOM3",201,0)
 ;
"RTN","SAMIHOM3",202,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM3",203,0)
 ;
"RTN","SAMIHOM3",204,0)
 ;ven/gpl;private;variable;
"RTN","SAMIHOM3",205,0)
 ;@called-by
"RTN","SAMIHOM3",206,0)
 ; WSNEWCAS
"RTN","SAMIHOM3",207,0)
 ;@calls
"RTN","SAMIHOM3",208,0)
 ; $$setroot^%wd
"RTN","SAMIHOM3",209,0)
 ;@input: none
"RTN","SAMIHOM3",210,0)
 ;@output = next number for study id
"RTN","SAMIHOM3",211,0)
 ;@examples [tbd]
"RTN","SAMIHOM3",212,0)
 ;@tests [tbd]
"RTN","SAMIHOM3",213,0)
 ;
"RTN","SAMIHOM3",214,0)
 ;@stanza 2 calculate next number
"RTN","SAMIHOM3",215,0)
 ;
"RTN","SAMIHOM3",216,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM3",217,0)
 new number set number=$order(@root@("  "),-1)+1
"RTN","SAMIHOM3",218,0)
 ;
"RTN","SAMIHOM3",219,0)
 ;@stanza 3 return & termination
"RTN","SAMIHOM3",220,0)
 ;
"RTN","SAMIHOM3",221,0)
 quit number ; return #; end of $$NEXTNUM
"RTN","SAMIHOM3",222,0)
 ;
"RTN","SAMIHOM3",223,0)
 ;
"RTN","SAMIHOM3",224,0)
 ;
"RTN","SAMIHOM3",225,0)
GENSTDID(num,ARG) ; studyID for number
"RTN","SAMIHOM3",226,0)
 ;
"RTN","SAMIHOM3",227,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM3",228,0)
 ;
"RTN","SAMIHOM3",229,0)
 ;ven/gpl;private;function;
"RTN","SAMIHOM3",230,0)
 ;@called-by
"RTN","SAMIHOM3",231,0)
 ; WSNEWCAS
"RTN","SAMIHOM3",232,0)
 ; wsLookup^SAMISRCH
"RTN","SAMIHOM3",233,0)
 ;@calls
"RTN","SAMIHOM3",234,0)
 ; $$PREFIX
"RTN","SAMIHOM3",235,0)
 ;@input
"RTN","SAMIHOM3",236,0)
 ; num = number of study id
"RTN","SAMIHOM3",237,0)
 ;@output = study id corresponding to number
"RTN","SAMIHOM3",238,0)
 ;@examples [tbd]
"RTN","SAMIHOM3",239,0)
 ;@tests [tbd]
"RTN","SAMIHOM3",240,0)
 ;
"RTN","SAMIHOM3",241,0)
 ;@stanza 2 calculate study id
"RTN","SAMIHOM3",242,0)
 ;
"RTN","SAMIHOM3",243,0)
 new zl set zl=$length(num)
"RTN","SAMIHOM3",244,0)
 new zz set zz="00000"
"RTN","SAMIHOM3",245,0)
 ;new studyid set studyid=$$GETPRFX^SAMIFORM(.ARG)_$extract(zz,1,5-zl)_num
"RTN","SAMIHOM3",246,0)
 ; the prefix is determined by the site or siteid, which should be passed
"RTN","SAMIHOM3",247,0)
 ; in ARG
"RTN","SAMIHOM3",248,0)
 n tsite s tsite=$g(ARG("siteid"))
"RTN","SAMIHOM3",249,0)
 i tsite="" s tsite=$g(ARG("site"))
"RTN","SAMIHOM3",250,0)
 i tsite="" s tsite="UNK"
"RTN","SAMIHOM3",251,0)
 new studyid set studyid=tsite_$extract(zz,1,5-zl)_num
"RTN","SAMIHOM3",252,0)
 ;
"RTN","SAMIHOM3",253,0)
 ;@stanza 3 return & termination
"RTN","SAMIHOM3",254,0)
 ;
"RTN","SAMIHOM3",255,0)
 quit studyid ; return study id; end of $$GENSTDID
"RTN","SAMIHOM3",256,0)
 ;
"RTN","SAMIHOM3",257,0)
 ;
"RTN","SAMIHOM3",258,0)
 ;
"RTN","SAMIHOM3",259,0)
KEYDATE(fmdt) ; date in StudyId format (yyyy-mm-dd)
"RTN","SAMIHOM3",260,0)
 ;
"RTN","SAMIHOM3",261,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM3",262,0)
 ;
"RTN","SAMIHOM3",263,0)
 ;ven/gpl;private;function;
"RTN","SAMIHOM3",264,0)
 ;@called-by
"RTN","SAMIHOM3",265,0)
 ; WSNEWCAS
"RTN","SAMIHOM3",266,0)
 ; WSNFPOST^SAMICASE
"RTN","SAMIHOM3",267,0)
 ;@calls
"RTN","SAMIHOM3",268,0)
 ; $$FMTE^XLFDT
"RTN","SAMIHOM3",269,0)
 ;@input
"RTN","SAMIHOM3",270,0)
 ; fmdt = date in fileman format
"RTN","SAMIHOM3",271,0)
 ;@output = date in study id format
"RTN","SAMIHOM3",272,0)
 ;@examples [tbd]
"RTN","SAMIHOM3",273,0)
 ;@tests [tbd]
"RTN","SAMIHOM3",274,0)
 ;
"RTN","SAMIHOM3",275,0)
 ;@stanza 2 calculate studyid format
"RTN","SAMIHOM3",276,0)
 ;
"RTN","SAMIHOM3",277,0)
 new zdt set zdt=$$FMTE^XLFDT(fmdt,"7D")
"RTN","SAMIHOM3",278,0)
 ;
"RTN","SAMIHOM3",279,0)
 new zy,zm,zd
"RTN","SAMIHOM3",280,0)
 set zy=$piece(zdt,"/",1)
"RTN","SAMIHOM3",281,0)
 set zm=$piece(zdt,"/",2)
"RTN","SAMIHOM3",282,0)
 if $length(zm)=1 set zm="0"_zm
"RTN","SAMIHOM3",283,0)
 set zd=$piece(zdt,"/",3)
"RTN","SAMIHOM3",284,0)
 if $length(zd)=1 set zd="0"_zd
"RTN","SAMIHOM3",285,0)
 ;
"RTN","SAMIHOM3",286,0)
 new studydate set studydate=zy_"-"_zm_"-"_zd
"RTN","SAMIHOM3",287,0)
 ;
"RTN","SAMIHOM3",288,0)
 ;@stanza 3 return & termination
"RTN","SAMIHOM3",289,0)
 ;
"RTN","SAMIHOM3",290,0)
 quit studydate ; return date; end of $$KEYDATE
"RTN","SAMIHOM3",291,0)
 ;
"RTN","SAMIHOM3",292,0)
 ;
"RTN","SAMIHOM3",293,0)
 ;
"RTN","SAMIHOM3",294,0)
VALDTNM(nm,args) ; validate new name
"RTN","SAMIHOM3",295,0)
 ;
"RTN","SAMIHOM3",296,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM3",297,0)
 ;
"RTN","SAMIHOM3",298,0)
 ;ven/gpl;private;function;
"RTN","SAMIHOM3",299,0)
 ;@called-by
"RTN","SAMIHOM3",300,0)
 ; WSNEWCAS
"RTN","SAMIHOM3",301,0)
 ;@calls: none
"RTN","SAMIHOM3",302,0)
 ;@input
"RTN","SAMIHOM3",303,0)
 ; nm = name to validate
"RTN","SAMIHOM3",304,0)
 ;.args = array to return error messages
"RTN","SAMIHOM3",305,0)
 ;@output = 1 if valid, -1 if not
"RTN","SAMIHOM3",306,0)
 ;@examples [tbd]
"RTN","SAMIHOM3",307,0)
 ;@tests [tbd]
"RTN","SAMIHOM3",308,0)
 ;
"RTN","SAMIHOM3",309,0)
 ;@stanza 2 screen for invalid name
"RTN","SAMIHOM3",310,0)
 ;
"RTN","SAMIHOM3",311,0)
 if nm'["," do  quit -1 ;
"RTN","SAMIHOM3",312,0)
 . set args("saminuerror")="invalid name"
"RTN","SAMIHOM3",313,0)
 . quit
"RTN","SAMIHOM3",314,0)
 ;
"RTN","SAMIHOM3",315,0)
 ;@stanza 3 return & termination
"RTN","SAMIHOM3",316,0)
 ;
"RTN","SAMIHOM3",317,0)
 quit 1 ; return success; end of $$VALDTNM
"RTN","SAMIHOM3",318,0)
 ;
"RTN","SAMIHOM3",319,0)
 ;
"RTN","SAMIHOM3",320,0)
 ;
"RTN","SAMIHOM3",321,0)
PREFILL(dfn) ; prefill fields for form
"RTN","SAMIHOM3",322,0)
 ;
"RTN","SAMIHOM3",323,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM3",324,0)
 ;
"RTN","SAMIHOM3",325,0)
 ;ven/gpl;private;procedure;
"RTN","SAMIHOM3",326,0)
 ;@called-by
"RTN","SAMIHOM3",327,0)
 ; WSNEWCAS
"RTN","SAMIHOM3",328,0)
 ;@calls
"RTN","SAMIHOM3",329,0)
 ; $$setroot^%wd
"RTN","SAMIHOM3",330,0)
 ;@input
"RTN","SAMIHOM3",331,0)
 ; gien =
"RTN","SAMIHOM3",332,0)
 ;@output
"RTN","SAMIHOM3",333,0)
 ; @root(gien) = ...
"RTN","SAMIHOM3",334,0)
 ;  where root = graph root for elcap patients
"RTN","SAMIHOM3",335,0)
 ;@examples [tbd]
"RTN","SAMIHOM3",336,0)
 ;@tests [tbd]
"RTN","SAMIHOM3",337,0)
 ;
"RTN","SAMIHOM3",338,0)
 ;@stanza 2 prefill fields
"RTN","SAMIHOM3",339,0)
 ;
"RTN","SAMIHOM3",340,0)
 ; pull data from VistA
"RTN","SAMIHOM3",341,0)
 ;
"RTN","SAMIHOM3",342,0)
 ;n ok
"RTN","SAMIHOM3",343,0)
 ;s ok=$$PTINFO^SAMIVSTA(dfn)
"RTN","SAMIHOM3",344,0)
 ;i +ok<1 D ^ZTER
"RTN","SAMIHOM3",345,0)
 d PTINFO^SAMIVSTA(dfn)
"RTN","SAMIHOM3",346,0)
 ;
"RTN","SAMIHOM3",347,0)
 ; prefills fields from patient-lookup graph
"RTN","SAMIHOM3",348,0)
 ;
"RTN","SAMIHOM3",349,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM3",350,0)
 new lroot s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM3",351,0)
 new lien s lien=$o(@lroot@("dfn",dfn,""))
"RTN","SAMIHOM3",352,0)
 q:lien=""
"RTN","SAMIHOM3",353,0)
 n gien s gien=$o(@root@("dfn",dfn,"")) ; 
"RTN","SAMIHOM3",354,0)
 q:gien=""
"RTN","SAMIHOM3",355,0)
 ; merge prefill fields
"RTN","SAMIHOM3",356,0)
 m @root@(gien)=@lroot@(lien)
"RTN","SAMIHOM3",357,0)
 ; fix format problems
"RTN","SAMIHOM3",358,0)
 new saminame set saminame=$get(@root@(gien,"saminame"))
"RTN","SAMIHOM3",359,0)
 ; dob format
"RTN","SAMIHOM3",360,0)
 n dob s dob=$g(@lroot@(lien,"sbdob"))
"RTN","SAMIHOM3",361,0)
 n X,Y
"RTN","SAMIHOM3",362,0)
 S X=dob
"RTN","SAMIHOM3",363,0)
 d ^%DT
"RTN","SAMIHOM3",364,0)
 Q:Y=-1
"RTN","SAMIHOM3",365,0)
 s dob=Y
"RTN","SAMIHOM3",366,0)
 if dob'="" set @root@(gien,"sbdob")=$$VAPALSDT^SAMICASE(dob)
"RTN","SAMIHOM3",367,0)
 if dob'="" set @root@(gien,"sidob")=$$VAPALSDT^SAMICASE(dob)
"RTN","SAMIHOM3",368,0)
 ; ssn format
"RTN","SAMIHOM3",369,0)
 n ssn s ssn=$g(@lroot@(lien,"ssn"))
"RTN","SAMIHOM3",370,0)
 if $l(ssn)=9 set @root@(gien,"sissn")=$e(ssn,1,3)_"-"_$e(ssn,4,5)_"-"_$e(ssn,6,9)
"RTN","SAMIHOM3",371,0)
 ; studyid
"RTN","SAMIHOM3",372,0)
 set @root@(gien,"sisid")=@root@(gien,"samistudyid")
"RTN","SAMIHOM3",373,0)
 ;
"RTN","SAMIHOM3",374,0)
 ;@stanza 3 termination
"RTN","SAMIHOM3",375,0)
 ;
"RTN","SAMIHOM3",376,0)
 quit  ; end of PREFILL
"RTN","SAMIHOM3",377,0)
 ;
"RTN","SAMIHOM3",378,0)
 ;
"RTN","SAMIHOM3",379,0)
 ;
"RTN","SAMIHOM3",380,0)
MKSBFORM(num) ; create background form -- depricated gpl 20180615
"RTN","SAMIHOM3",381,0)
 ;
"RTN","SAMIHOM3",382,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM3",383,0)
 ;
"RTN","SAMIHOM3",384,0)
 ;ven/gpl;private;procedure;
"RTN","SAMIHOM3",385,0)
 ;@called-by
"RTN","SAMIHOM3",386,0)
 ; WSNEWCAS
"RTN","SAMIHOM3",387,0)
 ;@calls
"RTN","SAMIHOM3",388,0)
 ; $$setroot^%wd
"RTN","SAMIHOM3",389,0)
 ;@input
"RTN","SAMIHOM3",390,0)
 ; num = index where new form should be built
"RTN","SAMIHOM3",391,0)
 ;@output
"RTN","SAMIHOM3",392,0)
 ; @root(num) = ...
"RTN","SAMIHOM3",393,0)
 ;  where root = graph root for elcap patients
"RTN","SAMIHOM3",394,0)
 ; @root@("graph")
"RTN","SAMIHOM3",395,0)
 ;@examples [tbd]
"RTN","SAMIHOM3",396,0)
 ;@tests [tbd]
"RTN","SAMIHOM3",397,0)
 ;
"RTN","SAMIHOM3",398,0)
 ;@stanza 2 build background form & place graph
"RTN","SAMIHOM3",399,0)
 ;
"RTN","SAMIHOM3",400,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM3",401,0)
 new sid set sid=$get(@root@(num,"samistudyid"))
"RTN","SAMIHOM3",402,0)
 quit:sid=""
"RTN","SAMIHOM3",403,0)
 new cdate set cdate=$get(@root@(num,"samicreatedate"))
"RTN","SAMIHOM3",404,0)
 quit:cdate=""
"RTN","SAMIHOM3",405,0)
 merge @root@("graph",sid,"sbform-"_cdate)=@root@(num)
"RTN","SAMIHOM3",406,0)
 d SSAMISTA^SAMICASE(sid,"sbform-"_cdate,"incomplete")
"RTN","SAMIHOM3",407,0)
 ;
"RTN","SAMIHOM3",408,0)
 ;@stanza 3 termination
"RTN","SAMIHOM3",409,0)
 ;
"RTN","SAMIHOM3",410,0)
 quit  ; end of MKSBFORM
"RTN","SAMIHOM3",411,0)
 ;
"RTN","SAMIHOM3",412,0)
 ;
"RTN","SAMIHOM3",413,0)
 ;
"RTN","SAMIHOM3",414,0)
MKSIFORM(num) ; create intake form
"RTN","SAMIHOM3",415,0)
 ;
"RTN","SAMIHOM3",416,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM3",417,0)
 ;
"RTN","SAMIHOM3",418,0)
 ;ven/gpl;private;procedure;
"RTN","SAMIHOM3",419,0)
 ;@called-by
"RTN","SAMIHOM3",420,0)
 ; WSNEWCAS
"RTN","SAMIHOM3",421,0)
 ;@calls
"RTN","SAMIHOM3",422,0)
 ; $$setroot^%wd
"RTN","SAMIHOM3",423,0)
 ;@input
"RTN","SAMIHOM3",424,0)
 ; num = index where new form should be built
"RTN","SAMIHOM3",425,0)
 ;@output
"RTN","SAMIHOM3",426,0)
 ; @root(num) = ...
"RTN","SAMIHOM3",427,0)
 ;  where root = graph root for elcap patients
"RTN","SAMIHOM3",428,0)
 ; @root@("graph")
"RTN","SAMIHOM3",429,0)
 ;@examples [tbd]
"RTN","SAMIHOM3",430,0)
 ;@tests [tbd]
"RTN","SAMIHOM3",431,0)
 ;
"RTN","SAMIHOM3",432,0)
 ;@stanza 2 build intake form & place graph
"RTN","SAMIHOM3",433,0)
 ;
"RTN","SAMIHOM3",434,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM3",435,0)
 new sid set sid=$get(@root@(num,"samistudyid"))
"RTN","SAMIHOM3",436,0)
 quit:sid=""
"RTN","SAMIHOM3",437,0)
 new cdate set cdate=$get(@root@(num,"samicreatedate"))
"RTN","SAMIHOM3",438,0)
 quit:cdate=""
"RTN","SAMIHOM3",439,0)
 merge @root@("graph",sid,"siform-"_cdate)=@root@(num)
"RTN","SAMIHOM3",440,0)
 d SSAMISTA^SAMICASE(sid,"siform-"_cdate,"complete")
"RTN","SAMIHOM3",441,0)
 ; initialize form from VistA data
"RTN","SAMIHOM3",442,0)
 n zf s zf=$na(@root@("graph",sid,"siform-"_cdate))
"RTN","SAMIHOM3",443,0)
 s @zf@("sipsa")=$g(@root@(num,"address1")) ; primary address
"RTN","SAMIHOM3",444,0)
 s @zf@("sipan")=$g(@root@(num,"address2")) ; apartment number
"RTN","SAMIHOM3",445,0)
 s @zf@("sipc")=$g(@root@(num,"city")) ; city
"RTN","SAMIHOM3",446,0)
 s @zf@("sips")=$g(@root@(num,"state")) ; state
"RTN","SAMIHOM3",447,0)
 s @zf@("sipcn")=$g(@root@(num,"county")) ; county
"RTN","SAMIHOM3",448,0)
 s @zf@("sipcr")="USA" ; country
"RTN","SAMIHOM3",449,0)
 s @zf@("sipz")=$g(@root@(num,"zip")) ; zip
"RTN","SAMIHOM3",450,0)
 i @zf@("sipz")'="" d  ;
"RTN","SAMIHOM3",451,0)
 . n zip s zip=@zf@("sipz")
"RTN","SAMIHOM3",452,0)
 . q:zip=""
"RTN","SAMIHOM3",453,0)
 . n ru s ru=$$URBRUR^SAMIVSTA(zip)
"RTN","SAMIHOM3",454,0)
 . i ru=0 s ru="n"
"RTN","SAMIHOM3",455,0)
 . i (ru="r")!(ru="u")!(ru="n") s @zf@("sirs")=ru
"RTN","SAMIHOM3",456,0)
 . s @root@(num,"sirs")=$g(@zf@("sirs"))
"RTN","SAMIHOM3",457,0)
 n phn s phn=$g(@root@(num,"phone")) ; phone number
"RTN","SAMIHOM3",458,0)
 i phn["x" s phn=$p(phn," x",1)
"RTN","SAMIHOM3",459,0)
 s @zf@("sippn")=phn
"RTN","SAMIHOM3",460,0)
 s @zf@("sidc")=$$VAPALSDT^SAMICASE($$NOW^XLFDT)
"RTN","SAMIHOM3",461,0)
 s @zf@("sipedc")=$$VAPALSDT^SAMICASE($$NOW^XLFDT)
"RTN","SAMIHOM3",462,0)
 ; set samifirsttime variable for intake form
"RTN","SAMIHOM3",463,0)
 s @zf@("samifirsttime")="true"
"RTN","SAMIHOM3",464,0)
 ;
"RTN","SAMIHOM3",465,0)
 ;@stanza 3 termination
"RTN","SAMIHOM3",466,0)
 ;
"RTN","SAMIHOM3",467,0)
 quit "siform-"_cdate ; end of MKSIFORM
"RTN","SAMIHOM3",468,0)
 ;
"RTN","SAMIHOM3",469,0)
 ;
"RTN","SAMIHOM3",470,0)
 ;
"RTN","SAMIHOM3",471,0)
 ;@section 4 api $$SID2NUM^SAMIHOM3
"RTN","SAMIHOM3",472,0)
 ;
"RTN","SAMIHOM3",473,0)
 ;
"RTN","SAMIHOM3",474,0)
 ;
"RTN","SAMIHOM3",475,0)
 ;@API $$SID2NUM^SAMIHOM3, number part of study id
"RTN","SAMIHOM3",476,0)
SID2NUM(sid) ; number part of studyid (XXX0001 -> 1)
"RTN","SAMIHOM3",477,0)
 ;
"RTN","SAMIHOM3",478,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM3",479,0)
 ;
"RTN","SAMIHOM3",480,0)
 ;ven/gpl;public;function;
"RTN","SAMIHOM3",481,0)
 ;@called-by
"RTN","SAMIHOM3",482,0)
 ; getVals^%wfhform
"RTN","SAMIHOM3",483,0)
 ; WSCASE^SAMICASE
"RTN","SAMIHOM3",484,0)
 ; WSNUFORM^SAMICASE
"RTN","SAMIHOM3",485,0)
 ; MKCEFORM^SAMICASE
"RTN","SAMIHOM3",486,0)
 ;@calls: none
"RTN","SAMIHOM3",487,0)
 ;@input
"RTN","SAMIHOM3",488,0)
 ; sid = study id
"RTN","SAMIHOM3",489,0)
 ;@output = number from study id
"RTN","SAMIHOM3",490,0)
 ;@examples [tbd]
"RTN","SAMIHOM3",491,0)
 ;@tests [tbd]
"RTN","SAMIHOM3",492,0)
 ;
"RTN","SAMIHOM3",493,0)
 ;@stanza 2 calculate number
"RTN","SAMIHOM3",494,0)
 ;
"RTN","SAMIHOM3",495,0)
 ;new number set number=+$extract(sid,4,$length(sid))
"RTN","SAMIHOM3",496,0)
 ; we have to look up the number (pien) instead of computing it
"RTN","SAMIHOM3",497,0)
 new number,proot
"RTN","SAMIHOM3",498,0)
 set proot=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM3",499,0)
 set number=$o(@proot@("sid",sid,"")) 
"RTN","SAMIHOM3",500,0)
 ;
"RTN","SAMIHOM3",501,0)
 ;@stanza 3 return & termination
"RTN","SAMIHOM3",502,0)
 ;
"RTN","SAMIHOM3",503,0)
 quit number ; return number; end of $$sid2num
"RTN","SAMIHOM3",504,0)
 ;
"RTN","SAMIHOM3",505,0)
 ;
"RTN","SAMIHOM3",506,0)
ADDPAT(dfn) ; calls newCase to add patient dfn to vapals
"RTN","SAMIHOM3",507,0)
 n lroot s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM3",508,0)
 n lien s lien=$o(@lroot@("dfn",dfn,""))
"RTN","SAMIHOM3",509,0)
 q:lien=""
"RTN","SAMIHOM3",510,0)
 n name s name=$g(@lroot@(lien,"saminame"))
"RTN","SAMIHOM3",511,0)
 q:name=""
"RTN","SAMIHOM3",512,0)
 n bdy s bdy(1)="saminame="_name_"&dfn="_dfn
"RTN","SAMIHOM3",513,0)
 n ARGS,result
"RTN","SAMIHOM3",514,0)
 d WSNEWCAS(.ARGS,.bdy,.result)
"RTN","SAMIHOM3",515,0)
 ; zwr result
"RTN","SAMIHOM3",516,0)
 ;
"RTN","SAMIHOM3",517,0)
INDEX ; reindex the vapals-patients graph
"RTN","SAMIHOM3",518,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM3",519,0)
 n zi s zi=0
"RTN","SAMIHOM3",520,0)
 f  s zi=$o(@root@(zi)) q:+zi=0  d  ;
"RTN","SAMIHOM3",521,0)
 . n dfn,sid
"RTN","SAMIHOM3",522,0)
 . s dfn=@root@(zi,"dfn")
"RTN","SAMIHOM3",523,0)
 . s sid=@root@(zi,"samistudyid")
"RTN","SAMIHOM3",524,0)
 . s @root@("dfn",dfn,zi)=""
"RTN","SAMIHOM3",525,0)
 . s @root@("sid",sid,zi)=""
"RTN","SAMIHOM3",526,0)
 q
"RTN","SAMIHOM3",527,0)
 ;
"RTN","SAMIHOM3",528,0)
EOR ; end of routine SAMIHOM3
"RTN","SAMIHOM4")
0^2^B741921644
"RTN","SAMIHOM4",1,0)
SAMIHOM4 ;ven/gpl,arc - ielcap: home page ;2021-03-17T18:32Z
"RTN","SAMIHOM4",2,0)
 ;;18.0;SAMI;**1,4,5,6,9**;;Build 1
"RTN","SAMIHOM4",3,0)
 ;;1.18.0.9-i9
"RTN","SAMIHOM4",4,0)
 ;
"RTN","SAMIHOM4",5,0)
 ; SAMIHOM4 contains web services & other subroutines for producing
"RTN","SAMIHOM4",6,0)
 ; the ELCAP Home Page.
"RTN","SAMIHOM4",7,0)
 ;
"RTN","SAMIHOM4",8,0)
 quit  ; no entry from top
"RTN","SAMIHOM4",9,0)
 ;
"RTN","SAMIHOM4",10,0)
 ;
"RTN","SAMIHOM4",11,0)
 ;
"RTN","SAMIHOM4",12,0)
 ;@section 0 primary development
"RTN","SAMIHOM4",13,0)
 ;
"RTN","SAMIHOM4",14,0)
 ;
"RTN","SAMIHOM4",15,0)
 ;
"RTN","SAMIHOM4",16,0)
 ;@license: see routine SAMIUL
"RTN","SAMIHOM4",17,0)
 ;@documentation : see SAMICUL
"RTN","SAMIHOM4",18,0)
 ;@contents
"RTN","SAMIHOM4",19,0)
 ; WSHOME: code for ws: vapals-elcap homepage
"RTN","SAMIHOM4",20,0)
 ; WSVAPALS: code for ws: vapals post
"RTN","SAMIHOM4",21,0)
 ; REG: manual registration
"RTN","SAMIHOM4",22,0)
 ; MKPTLK: creates patient-lookup record
"RTN","SAMIHOM4",23,0)
 ; UPDTFRMS: update demographics in all forms for patient
"RTN","SAMIHOM4",24,0)
 ; MERGE: merge participant records
"RTN","SAMIHOM4",25,0)
 ; ADDUNMAT: adds unmatched report web service to system
"RTN","SAMIHOM4",26,0)
 ; DELUNMAT: deletes unmatched web service
"RTN","SAMIHOM4",27,0)
 ; WSUNMAT: navigates to unmatched report
"RTN","SAMIHOM4",28,0)
 ; $$DUPSSN = true if duplicate ssn
"RTN","SAMIHOM4",29,0)
 ; $$DUPICN = true if duplicate icn
"RTN","SAMIHOM4",30,0)
 ; $$BADICN = true if ICN checkdigits are wrong
"RTN","SAMIHOM4",31,0)
 ; SAVE: save patient-lookup record after edit
"RTN","SAMIHOM4",32,0)
 ; $$REMATCH = possible match ien
"RTN","SAMIHOM4",33,0)
 ; SETINFO: set information message text
"RTN","SAMIHOM4",34,0)
 ; SETWARN: set warning message text
"RTN","SAMIHOM4",35,0)
 ; RTNERR: redisplay page w/error message
"RTN","SAMIHOM4",36,0)
 ; RTNPAGE: display page
"RTN","SAMIHOM4",37,0)
 ; REINDXPL: reindex patient lookup
"RTN","SAMIHOM4",38,0)
 ; INDXPTLK: generate index entries in patient-lookup graph
"RTN","SAMIHOM4",39,0)
 ; UNINDXPT: remove index entries from patient-lookup graph
"RTN","SAMIHOM4",40,0)
 ; $$UCASE = uppercase
"RTN","SAMIHOM4",41,0)
 ; DEVHOME: code for ws: temporary home page for development
"RTN","SAMIHOM4",42,0)
 ; GETHOME: code for ws: homepage accessed using GET
"RTN","SAMIHOM4",43,0)
 ; WSNEWCAS: code for ws: receives post from home & creates new case
"RTN","SAMIHOM4",44,0)
 ;
"RTN","SAMIHOM4",45,0)
 ;@to-do
"RTN","SAMIHOM4",46,0)
 ; Add label comments
"RTN","SAMIHOM4",47,0)
 ;
"RTN","SAMIHOM4",48,0)
 ;
"RTN","SAMIHOM4",49,0)
 ;
"RTN","SAMIHOM4",50,0)
 ;@section 1 wsi WSHOME & related subroutines
"RTN","SAMIHOM4",51,0)
 ;
"RTN","SAMIHOM4",52,0)
 ;
"RTN","SAMIHOM4",53,0)
 ;
"RTN","SAMIHOM4",54,0)
 ;@wsi-code WSHOME^SAMIHOM3, vapals-elcap homepage
"RTN","SAMIHOM4",55,0)
WSHOME ; code for web service for SAMI homepage
"RTN","SAMIHOM4",56,0)
 ;
"RTN","SAMIHOM4",57,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM4",58,0)
 ;
"RTN","SAMIHOM4",59,0)
 ;ven/gpl;web service;procedure;
"RTN","SAMIHOM4",60,0)
 ;@signature
"RTN","SAMIHOM4",61,0)
 ; do WSHOME^SAMIHOM3(SAMIRTN,SAMIFILTER)
"RTN","SAMIHOM4",62,0)
 ;@branches-from
"RTN","SAMIHOM4",63,0)
 ; WSHOME^SAMIHOM3
"RTN","SAMIHOM4",64,0)
 ;@called-by
"RTN","SAMIHOM4",65,0)
 ;@calls
"RTN","SAMIHOM4",66,0)
 ; GETHOME
"RTN","SAMIHOM4",67,0)
 ;@input
"RTN","SAMIHOM4",68,0)
 ; SAMIFILTER
"RTN","SAMIHOM4",69,0)
 ;@output
"RTN","SAMIHOM4",70,0)
 ;.SAMIRTN
"RTN","SAMIHOM4",71,0)
 ;@examples [tbd]
"RTN","SAMIHOM4",72,0)
 ;@tests [tbd]
"RTN","SAMIHOM4",73,0)
 ;
"RTN","SAMIHOM4",74,0)
 ; no parameters required
"RTN","SAMIHOM4",75,0)
 ;
"RTN","SAMIHOM4",76,0)
 ;@stanza 2 present development or temporary homepage
"RTN","SAMIHOM4",77,0)
 ;
"RTN","SAMIHOM4",78,0)
 if $get(SAMIFILTER("test"))=1 do  quit
"RTN","SAMIHOM4",79,0)
 . do DEVHOME^SAMIHOM3(.SAMIRTN,.SAMIFILTER)
"RTN","SAMIHOM4",80,0)
 . quit
"RTN","SAMIHOM4",81,0)
 ;
"RTN","SAMIHOM4",82,0)
 if $g(SAMIFILTER("samiroute"))'="" do  quit  ; workaround for "get" access to pages
"RTN","SAMIHOM4",83,0)
 . new SAMIBODY set SAMIBODY(1)=""
"RTN","SAMIHOM4",84,0)
 . do WSVAPALS^SAMIHOM3(.SAMIFILTER,.SAMIBODY,.SAMIRTN)
"RTN","SAMIHOM4",85,0)
 ;
"RTN","SAMIHOM4",86,0)
 if $get(SAMIFILTER("dfn"))'="" do  quit  ; V4W/DLW - workaround for "get" access from CPRS
"RTN","SAMIHOM4",87,0)
 . new dfn set dfn=$get(SAMIFILTER("dfn"))
"RTN","SAMIHOM4",88,0)
 . new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",89,0)
 . new studyid set studyid=$get(@root@(dfn,"samistudyid"))
"RTN","SAMIHOM4",90,0)
 . new SAMIBODY
"RTN","SAMIHOM4",91,0)
 . if studyid'="" do
"RTN","SAMIHOM4",92,0)
 . . set SAMIBODY(1)="samiroute=casereview&dfn="_dfn_"&studyid="_studyid
"RTN","SAMIHOM4",93,0)
 . else  do
"RTN","SAMIHOM4",94,0)
 . . set SAMIBODY(1)="samiroute=lookup&dfn="_dfn_"&studyid="_studyid
"RTN","SAMIHOM4",95,0)
 . do WSVAPALS^SAMIHOM3(.SAMIFILTER,.SAMIBODY,.SAMIRTN)
"RTN","SAMIHOM4",96,0)
 ;
"RTN","SAMIHOM4",97,0)
 do GETHOME^SAMIHOM3(.SAMIRTN,.SAMIFILTER) ; VAPALS homepage
"RTN","SAMIHOM4",98,0)
 ;
"RTN","SAMIHOM4",99,0)
 ;@stanza 3 termination
"RTN","SAMIHOM4",100,0)
 ;
"RTN","SAMIHOM4",101,0)
 quit  ; end of wsi WSHOME^SAMIHOM3
"RTN","SAMIHOM4",102,0)
 ;
"RTN","SAMIHOM4",103,0)
 ;
"RTN","SAMIHOM4",104,0)
 ;
"RTN","SAMIHOM4",105,0)
 ;@wsi-code WSVAPALS^SAMIHOM3, vapals-elcap post
"RTN","SAMIHOM4",106,0)
WSVAPALS ; code for web service for vapals post
"RTN","SAMIHOM4",107,0)
 ;
"RTN","SAMIHOM4",108,0)
 ;ven/gpl;web service;procedure;
"RTN","SAMIHOM4",109,0)
 ;@signature
"RTN","SAMIHOM4",110,0)
 ; do WSVAPALS^SAMIHOM3(SAMIARG,SAMIBODY,SAMIRESULT)
"RTN","SAMIHOM4",111,0)
 ;@branches-from
"RTN","SAMIHOM4",112,0)
 ; WSVAPALS^SAMIHOM3
"RTN","SAMIHOM4",113,0)
 ;
"RTN","SAMIHOM4",114,0)
 ; all calls come through this gateway
"RTN","SAMIHOM4",115,0)
 ;
"RTN","SAMIHOM4",116,0)
 k ^SAMIUL("vapals")
"RTN","SAMIHOM4",117,0)
 m ^SAMIUL("vapals")=SAMIARG
"RTN","SAMIHOM4",118,0)
 m ^SAMIUL("vapals","BODY")=SAMIBODY
"RTN","SAMIHOM4",119,0)
 ;
"RTN","SAMIHOM4",120,0)
 new vars,SAMIBDY
"RTN","SAMIHOM4",121,0)
 set SAMIBDY=$get(SAMIBODY(1))
"RTN","SAMIHOM4",122,0)
 do parseBody^%wf("vars",.SAMIBDY)
"RTN","SAMIHOM4",123,0)
 m vars=SAMIARG
"RTN","SAMIHOM4",124,0)
 i $g(vars("siteid"))'="" d  ;
"RTN","SAMIHOM4",125,0)
 . i $g(vars("site"))'=$g(vars("siteid")) s vars("site")=$g(vars("siteid"))
"RTN","SAMIHOM4",126,0)
 m SAMIARG=vars
"RTN","SAMIHOM4",127,0)
 m SAMIARG=SAMIBODY
"RTN","SAMIHOM4",128,0)
 ;
"RTN","SAMIHOM4",129,0)
 ; Processing for multi-tenancy
"RTN","SAMIHOM4",130,0)
 ;
"RTN","SAMIHOM4",131,0)
 if '$d(vars("siteid")) d  ;
"RTN","SAMIHOM4",132,0)
 . if $g(vars("studyid"))="" q
"RTN","SAMIHOM4",133,0)
 . n sym s sym=$e(vars("studyid"),1,3) ; first 3 chars in studyid
"RTN","SAMIHOM4",134,0)
 . i $$SITENM2^SAMISITE(sym)=-1 q
"RTN","SAMIHOM4",135,0)
 . s vars("siteid")=sym
"RTN","SAMIHOM4",136,0)
 . s vars("site")=sym
"RTN","SAMIHOM4",137,0)
 ;
"RTN","SAMIHOM4",138,0)
 if $G(vars("site"))'="" d  ;
"RTN","SAMIHOM4",139,0)
 . n siteid s siteid=vars("site")
"RTN","SAMIHOM4",140,0)
 . s SAMIARG("siteid")=siteid
"RTN","SAMIHOM4",141,0)
 . s SAMIARG("sitetitle")=$$SITENM2^SAMISITE(siteid)_" - "_siteid
"RTN","SAMIHOM4",142,0)
 k ^gpl("siteselect")
"RTN","SAMIHOM4",143,0)
 m ^gpl("siteselect")=SAMIARG
"RTN","SAMIHOM4",144,0)
 m ^gpl("siteselect","vars")=vars
"RTN","SAMIHOM4",145,0)
 if $G(SAMIARG("siteid"))="" if '$$FINDSITE^SAMISITE(.SAMIRESULT,.SAMIARG) Q 0
"RTN","SAMIHOM4",146,0)
 new SAMISITE,SAMITITL
"RTN","SAMIHOM4",147,0)
 s SAMISITE=$G(SAMIARG("siteid"))
"RTN","SAMIHOM4",148,0)
 i $G(SAMIARG("sitetitle"))="" d  ;
"RTN","SAMIHOM4",149,0)
 . s SAMIARG("sitetitle")=$$SITENM2^SAMISITE(SAMISITE)_" - "_SAMISITE
"RTN","SAMIHOM4",150,0)
 s SAMITITL=$G(SAMIARG("sitetitle"))
"RTN","SAMIHOM4",151,0)
 m vars=SAMIARG
"RTN","SAMIHOM4",152,0)
 ;
"RTN","SAMIHOM4",153,0)
 k ^SAMIUL("vapals","vars")
"RTN","SAMIHOM4",154,0)
 merge ^SAMIUL("vapals","vars")=vars
"RTN","SAMIHOM4",155,0)
 merge ^SAMIUL("vapals","vars")=SAMIBODY
"RTN","SAMIHOM4",156,0)
 ;
"RTN","SAMIHOM4",157,0)
 n route s route=$g(vars("samiroute"))
"RTN","SAMIHOM4",158,0)
 i route=""  d GETHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG) ; on error go home
"RTN","SAMIHOM4",159,0)
 ;
"RTN","SAMIHOM4",160,0)
 i route="lookup" d  q 0
"RTN","SAMIHOM4",161,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",162,0)
 . d WSLOOKUP^SAMISRC2(.SAMIARG,.SAMIBODY,.SAMIRESULT)
"RTN","SAMIHOM4",163,0)
 ;
"RTN","SAMIHOM4",164,0)
 i route="login" d  q 0
"RTN","SAMIHOM4",165,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",166,0)
 . d LOGIN^SAMISITE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",167,0)
 ;
"RTN","SAMIHOM4",168,0)
 i route="home" d  q 0
"RTN","SAMIHOM4",169,0)
 . k ^gpl("home")
"RTN","SAMIHOM4",170,0)
 . m ^gpl("home")=SAMIARG
"RTN","SAMIHOM4",171,0)
 . s SAMIARG("samiroute")=""
"RTN","SAMIHOM4",172,0)
 . d WSHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",173,0)
 ;
"RTN","SAMIHOM4",174,0)
 i route="logout" d  q 0
"RTN","SAMIHOM4",175,0)
 . ;s SAMIARG("samiroute")="home"
"RTN","SAMIHOM4",176,0)
 . ;do WSVAPALS^SAMIHOM3(.SAMIFILTER,.SAMIARG,.SAMIRESULT)
"RTN","SAMIHOM4",177,0)
 . ;Q
"RTN","SAMIHOM4",178,0)
 . s SAMIARG("sitetitle")="Unknown Site"
"RTN","SAMIHOM4",179,0)
 . s SAMIARG("siteid")=""
"RTN","SAMIHOM4",180,0)
 . s SAMIARG("errorMessage")=""
"RTN","SAMIHOM4",181,0)
 . d RTNERR^SAMIHOM4(.SAMIRESULT,"vapals:login",.SAMIARG)
"RTN","SAMIHOM4",182,0)
 ;
"RTN","SAMIHOM4",183,0)
 i route="newcase" d  q 0
"RTN","SAMIHOM4",184,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",185,0)
 . d WSNEWCAS^SAMIHOM3(.SAMIARG,.SAMIBODY,.SAMIRESULT)
"RTN","SAMIHOM4",186,0)
 ;
"RTN","SAMIHOM4",187,0)
 i route="casereview" d  q 0
"RTN","SAMIHOM4",188,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",189,0)
 . d WSCASE^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",190,0)
 ;
"RTN","SAMIHOM4",191,0)
 i route="nuform" d  q 0
"RTN","SAMIHOM4",192,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",193,0)
 . d WSNUFORM^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",194,0)
 ;
"RTN","SAMIHOM4",195,0)
 i route="addform" d  q 0
"RTN","SAMIHOM4",196,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",197,0)
 . d WSNFPOST^SAMICASE(.SAMIARG,.SAMIBODY,.SAMIRESULT)
"RTN","SAMIHOM4",198,0)
 ;
"RTN","SAMIHOM4",199,0)
 i route="form" d  q 0
"RTN","SAMIHOM4",200,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",201,0)
 . d wsGetForm^%wf(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",202,0)
 ;
"RTN","SAMIHOM4",203,0)
 i route="postform" d  q 0
"RTN","SAMIHOM4",204,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",205,0)
 . d wsPostForm^%wf(.SAMIARG,.SAMIBODY,.SAMIRESULT)
"RTN","SAMIHOM4",206,0)
 . i $g(SAMIARG("form"))["siform" d  ;
"RTN","SAMIHOM4",207,0)
 . . n notr s notr=0 ; note return 0 if failure, 1 or greater if success
"RTN","SAMIHOM4",208,0)
 . . ; returns the ien of the note that was created and should be sent
"RTN","SAMIHOM4",209,0)
 . . s notr=$$NOTE^SAMINOT1(.SAMIARG)
"RTN","SAMIHOM4",210,0)
 . . if +notr>0 d  ;
"RTN","SAMIHOM4",211,0)
 . . . n SAMIFILTER
"RTN","SAMIHOM4",212,0)
 . . . s SAMIFILTER("sid")=$G(SAMIARG("studyid"))
"RTN","SAMIHOM4",213,0)
 . . . s SAMIFILTER("key")=$g(SAMIARG("form")) ;
"RTN","SAMIHOM4",214,0)
 . . . n tiuien
"RTN","SAMIHOM4",215,0)
 . . . s tiuien=+notr
"RTN","SAMIHOM4",216,0)
 . . . s SAMIFILTER("notenmbr")=tiuien
"RTN","SAMIHOM4",217,0)
 . . . n sendrslt
"RTN","SAMIHOM4",218,0)
 . . . ;s sendrslt="1^MSG9239010"
"RTN","SAMIHOM4",219,0)
 . . . s sendrslt=$$EN^SAMIORU(.SAMIFILTER) ; send the note to VistA
"RTN","SAMIHOM4",220,0)
 . . . i +sendrslt>0 d  ; success
"RTN","SAMIHOM4",221,0)
 . . . . n rtnid s rtnid=$p(sendrslt,"^",2) ; return id from HL7
"RTN","SAMIHOM4",222,0)
 . . . . ; post the id to the graph here
"RTN","SAMIHOM4",223,0)
 . . . . n sid s sid=$G(SAMIARG("studyid"))
"RTN","SAMIHOM4",224,0)
 . . . . n form s form=$G(SAMIARG("form"))
"RTN","SAMIHOM4",225,0)
 . . . . n nien s nien=$$NTIEN^SAMINOT1(sid,form) ; latest note ien
"RTN","SAMIHOM4",226,0)
 . . . . n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",227,0)
 . . . . s @root@("graph",sid,form,"notes",nien,"hl7id")=rtnid
"RTN","SAMIHOM4",228,0)
 . . . . s SAMIARG("errorMessage")="Note successfully sent to VistA ID: "_rtnid
"RTN","SAMIHOM4",229,0)
 . . . else  d  ;
"RTN","SAMIHOM4",230,0)
 . . . . n rtnmsg s rtnmsg=$p(sendrslt,"^",2)
"RTN","SAMIHOM4",231,0)
 . . . . s SAMIARG("errorMessage")=rtnmsg
"RTN","SAMIHOM4",232,0)
 . . . d WSCASE^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",233,0)
 . i $g(SAMIARG("form"))["fuform" d  ;
"RTN","SAMIHOM4",234,0)
 . . n notr s notr=0 ; note return 0 if failure, 1 or greater if success
"RTN","SAMIHOM4",235,0)
 . . ; returns the ien of the note that was created and should be sent
"RTN","SAMIHOM4",236,0)
 . . s notr=$$NOTE^SAMINOT2(.SAMIARG)
"RTN","SAMIHOM4",237,0)
 . . if +notr>0 d  ;
"RTN","SAMIHOM4",238,0)
 . . . n SAMIFILTER
"RTN","SAMIHOM4",239,0)
 . . . s SAMIFILTER("sid")=$G(SAMIARG("studyid"))
"RTN","SAMIHOM4",240,0)
 . . . s SAMIFILTER("key")=$g(SAMIARG("form")) ;
"RTN","SAMIHOM4",241,0)
 . . . n tiuien
"RTN","SAMIHOM4",242,0)
 . . . s tiuien=+notr
"RTN","SAMIHOM4",243,0)
 . . . s SAMIFILTER("notenmbr")=tiuien
"RTN","SAMIHOM4",244,0)
 . . . n sendrslt
"RTN","SAMIHOM4",245,0)
 . . . ;s sendrslt="0^Missing ORM Message"
"RTN","SAMIHOM4",246,0)
 . . . s sendrslt=$$EN^SAMIORU(.SAMIFILTER) ; send the note to VistA
"RTN","SAMIHOM4",247,0)
 . . . i +sendrslt>0 d  ; success
"RTN","SAMIHOM4",248,0)
 . . . . n rtnid s rtnid=$p(sendrslt,"^",2) ; return id from HL7
"RTN","SAMIHOM4",249,0)
 . . . . ; post the id to the graph here
"RTN","SAMIHOM4",250,0)
 . . . . n sid s sid=$G(SAMIARG("studyid"))
"RTN","SAMIHOM4",251,0)
 . . . . n form s form=$G(SAMIARG("form"))
"RTN","SAMIHOM4",252,0)
 . . . . n nien s nien=$$NTIEN^SAMINOT1(sid,form) ; latest note ien
"RTN","SAMIHOM4",253,0)
 . . . . n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",254,0)
 . . . . s @root@("graph",sid,form,"notes",nien,"hl7id")=rtnid
"RTN","SAMIHOM4",255,0)
 . . . . s SAMIARG("errorMessage")="Note successfully sent to VistA ID: "_rtnid
"RTN","SAMIHOM4",256,0)
 . . . else  d  ;
"RTN","SAMIHOM4",257,0)
 . . . . n rtnmsg s rtnmsg=$p(sendrslt,"^",2)
"RTN","SAMIHOM4",258,0)
 . . . . i $g(SAMIARG("errorMessage"))="" d  ;
"RTN","SAMIHOM4",259,0)
 . . . . . s SAMIARG("errorMessage")=rtnmsg
"RTN","SAMIHOM4",260,0)
 . . . d WSCASE^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",261,0)
 . . e  d WSCASE^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",262,0)
 . e  d WSCASE^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",263,0)
 ;
"RTN","SAMIHOM4",264,0)
 i route="deleteform" d  q 0
"RTN","SAMIHOM4",265,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",266,0)
 . d DELFORM^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",267,0)
 ;
"RTN","SAMIHOM4",268,0)
 i route="ctreport" d  q 0
"RTN","SAMIHOM4",269,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",270,0)
 . n format s format="html"
"RTN","SAMIHOM4",271,0)
 . s format="text"
"RTN","SAMIHOM4",272,0)
 . i format="text" d WSNOTE^SAMINOT3(.SAMIRESULT,.SAMIARG) q  ;
"RTN","SAMIHOM4",273,0)
 . i format="html" d WSREPORT^SAMICTR0(.SAMIRESULT,.SAMIARG) q  ;
"RTN","SAMIHOM4",274,0)
 . ;d wsReport^SAMICTRT(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",275,0)
 ;
"RTN","SAMIHOM4",276,0)
 i route="note" d  q 0
"RTN","SAMIHOM4",277,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",278,0)
 . d WSNOTE^SAMINOT1(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",279,0)
 ;
"RTN","SAMIHOM4",280,0)
 i route="report" d  q 0
"RTN","SAMIHOM4",281,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",282,0)
 . d WSREPORT^SAMIUR(.SAMIRESULT,.vars)
"RTN","SAMIHOM4",283,0)
 ;
"RTN","SAMIHOM4",284,0)
 i route="addperson" d  q 0
"RTN","SAMIHOM4",285,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",286,0)
 . n form
"RTN","SAMIHOM4",287,0)
 . s form="vapals:addperson"
"RTN","SAMIHOM4",288,0)
 . d RTNPAGE^SAMIHOM4(.SAMIRESULT,form,.SAMIARG) q  ;
"RTN","SAMIHOM4",289,0)
 ;
"RTN","SAMIHOM4",290,0)
 i route="editperson" d  q 0
"RTN","SAMIHOM4",291,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",292,0)
 . n dfn s dfn=$g(vars("dfn")) ; must have a dfn
"RTN","SAMIHOM4",293,0)
 . i dfn="" d  q  ;
"RTN","SAMIHOM4",294,0)
 . . d GETHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG) ; on error go home 
"RTN","SAMIHOM4",295,0)
 . n root s root=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",296,0)
 . n sien s sien=$o(@root@("dfn",dfn,""))
"RTN","SAMIHOM4",297,0)
 . i sien="" d  q  ;
"RTN","SAMIHOM4",298,0)
 . . d GETHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG) ; on error go home 
"RTN","SAMIHOM4",299,0)
 . s vars("name")=$g(@root@(sien,"saminame"))
"RTN","SAMIHOM4",300,0)
 . s tdob=$g(@root@(sien,"dob"))
"RTN","SAMIHOM4",301,0)
 . s vars("dob")=$p(tdob,"-",2)_"/"_$p(tdob,"-",3)_"/"_$p(tdob,"-",1)
"RTN","SAMIHOM4",302,0)
 . s vars("sbdob")=$g(@root@(sien,"dob"))
"RTN","SAMIHOM4",303,0)
 . s vars("gender")=$g(@root@(sien,"sex"))
"RTN","SAMIHOM4",304,0)
 . s vars("icn")=$g(@root@(sien,"icn"))
"RTN","SAMIHOM4",305,0)
 . n tssn s tssn=$g(@root@(sien,"ssn"))
"RTN","SAMIHOM4",306,0)
 . s vars("ssn")=$e(tssn,1,3)_"-"_$e(tssn,4,5)_"-"_$e(tssn,6,9)
"RTN","SAMIHOM4",307,0)
 . s vars("last5")=$g(@root@(sien,"last5"))
"RTN","SAMIHOM4",308,0)
 . s vars("dfn")=$g(@root@(sien,"dfn"))
"RTN","SAMIHOM4",309,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",310,0)
 . n form,err,zhtml
"RTN","SAMIHOM4",311,0)
 . s form="vapals:editparticipant"
"RTN","SAMIHOM4",312,0)
 . d RTNPAGE^SAMIHOM4(.SAMIRESULT,form,.SAMIARG) q  ;
"RTN","SAMIHOM4",313,0)
 ;
"RTN","SAMIHOM4",314,0)
 i route="register" d  q 0
"RTN","SAMIHOM4",315,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",316,0)
 . d REG^SAMIHOM4(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",317,0)
 ; 
"RTN","SAMIHOM4",318,0)
 i route="editsave" d  q 0
"RTN","SAMIHOM4",319,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",320,0)
 . d SAVE^SAMIHOM4(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",321,0)
 ;
"RTN","SAMIHOM4",322,0)
 i route="merge" d  q 0
"RTN","SAMIHOM4",323,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",324,0)
 . d MERGE^SAMIHOM4(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",325,0)
 ;
"RTN","SAMIHOM4",326,0)
 quit 0  ; end of wsi WSVAPALS^SAMIHOM3
"RTN","SAMIHOM4",327,0)
 ;
"RTN","SAMIHOM4",328,0)
 ;
"RTN","SAMIHOM4",329,0)
 ;
"RTN","SAMIHOM4",330,0)
REG(SAMIRTN,SAMIARG) ; manual registration
"RTN","SAMIHOM4",331,0)
 ;
"RTN","SAMIHOM4",332,0)
 n name s name=$g(SAMIARG("name"))
"RTN","SAMIHOM4",333,0)
 ;
"RTN","SAMIHOM4",334,0)
 m ^gpl("reg")=SAMIARG
"RTN","SAMIHOM4",335,0)
 n ssn s ssn=SAMIARG("ssn")
"RTN","SAMIHOM4",336,0)
 s ssn=$tr(ssn,"-")
"RTN","SAMIHOM4",337,0)
 s SAMIARG("errorMessage")=""
"RTN","SAMIHOM4",338,0)
 s SAMIARG("errorField")=""
"RTN","SAMIHOM4",339,0)
 ; test for duplicate ssn
"RTN","SAMIHOM4",340,0)
 ;
"RTN","SAMIHOM4",341,0)
 ;i $$DUPSSN(ssn) d  ;
"RTN","SAMIHOM4",342,0)
 ;. ;s SAMIARG("errorMessage")=SAMIARG("errorMessage")_" Duplicate SSN."
"RTN","SAMIHOM4",343,0)
 ;. s SAMIARG("errorMessage")=SAMIARG("errorMessage")_" Duplicate SSN error. A person with that SSN is already entered in the system."
"RTN","SAMIHOM4",344,0)
 ;. s SAMIARG("errorField")="ssn"
"RTN","SAMIHOM4",345,0)
 ;
"RTN","SAMIHOM4",346,0)
 ; test for duplicate icn
"RTN","SAMIHOM4",347,0)
 ;
"RTN","SAMIHOM4",348,0)
 ;n icn s icn=$g(SAMIARG("icn"))
"RTN","SAMIHOM4",349,0)
 ;i icn'="" i $$DUPICN(icn) d  ;
"RTN","SAMIHOM4",350,0)
 ;. s SAMIARG("errorMessage")=SAMIARG("errorMessage")_" Duplicate ICN error. A person with that ICN is already entered in the system."
"RTN","SAMIHOM4",351,0)
 ;. s SAMIARG("errorField")="icn"
"RTN","SAMIHOM4",352,0)
 ;;
"RTN","SAMIHOM4",353,0)
 ;; test for wellformed ICN
"RTN","SAMIHOM4",354,0)
 ;;
"RTN","SAMIHOM4",355,0)
 ;i icn'="" i $$BADICN(icn) d  ;
"RTN","SAMIHOM4",356,0)
 ;. s SAMIARG("errorMessage")=SAMIARG("errorMessage")_" Invalid ICN error. The check digits in the ICN do not match"
"RTN","SAMIHOM4",357,0)
 ;. s SAMIARG("errorField")="icn"
"RTN","SAMIHOM4",358,0)
 ;;
"RTN","SAMIHOM4",359,0)
 ; if there is an error, send back to edit with error message
"RTN","SAMIHOM4",360,0)
 i $g(SAMIARG("errorMessage"))'="" d  q  ;
"RTN","SAMIHOM4",361,0)
 . n form
"RTN","SAMIHOM4",362,0)
 . s form="vapals:addperson"
"RTN","SAMIHOM4",363,0)
 . d RTNERR(.SAMIRESULT,form,.SAMIARG)
"RTN","SAMIHOM4",364,0)
 ;
"RTN","SAMIHOM4",365,0)
 n root s root=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",366,0)
 n proot s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",367,0)
 n ptlkien s ptlkien=""
"RTN","SAMIHOM4",368,0)
 n dfn s dfn=""
"RTN","SAMIHOM4",369,0)
 n sien s sien=""
"RTN","SAMIHOM4",370,0)
 i ptlkien="" s ptlkien=$o(@root@("AAAAAA"),-1)+1
"RTN","SAMIHOM4",371,0)
 n zm
"RTN","SAMIHOM4",372,0)
 k SAMIARG("MATCHLOG")
"RTN","SAMIHOM4",373,0)
 s zm=$$REMATCH(sien,.SAMIARG)
"RTN","SAMIHOM4",374,0)
 i zm>0 d  ;
"RTN","SAMIHOM4",375,0)
 . s SAMIARG("MATCHLOG")=zm
"RTN","SAMIHOM4",376,0)
 d MKPTLK(ptlkien,.SAMIARG) ; make the patient-lookup record
"RTN","SAMIHOM4",377,0)
 ;
"RTN","SAMIHOM4",378,0)
 s dfn=$o(@root@("dfn"," "),-1)+1
"RTN","SAMIHOM4",379,0)
 n pdfn
"RTN","SAMIHOM4",380,0)
 s pdfn=$o(@proot@("dfn"," "),-1)+1
"RTN","SAMIHOM4",381,0)
 i pdfn>dfn s dfn=pdfn ; need a dfn that has not been used
"RTN","SAMIHOM4",382,0)
 i dfn<9000001 s dfn=9000001
"RTN","SAMIHOM4",383,0)
 s @root@(ptlkien,"dfn")=dfn
"RTN","SAMIHOM4",384,0)
 d INDXPTLK(ptlkien)
"RTN","SAMIHOM4",385,0)
 s SAMIFILTER("samiroute")="addperson"
"RTN","SAMIHOM4",386,0)
 s SAMIFILTER("siteid")=$G(SAMIARG("siteid"))
"RTN","SAMIHOM4",387,0)
 s SAMIFILTER("sitetitle")=$G(SAMIARG("sitetitle"))
"RTN","SAMIHOM4",388,0)
 k SAMIARG ; return to a blank manual registration form
"RTN","SAMIHOM4",389,0)
 s SAMIARG("siteid")=$G(SAMIFILTER("siteid"))
"RTN","SAMIHOM4",390,0)
 s SAMIARG("sitetitle")=$G(SAMIFILTER("sitetitle"))
"RTN","SAMIHOM4",391,0)
 d SETINFO(.SAMIFILTER,name_" was successfully entered")
"RTN","SAMIHOM4",392,0)
 ;d SETWARN(.SAMIFILTER,"We might want to give you a warning")
"RTN","SAMIHOM4",393,0)
 do WSVAPALS^SAMIHOM3(.SAMIFILTER,.SAMIARG,.SAMIRESULT)
"RTN","SAMIHOM4",394,0)
 ;
"RTN","SAMIHOM4",395,0)
 quit  ; end of REG
"RTN","SAMIHOM4",396,0)
 ;
"RTN","SAMIHOM4",397,0)
 ;
"RTN","SAMIHOM4",398,0)
 ;
"RTN","SAMIHOM4",399,0)
MKPTLK(ptlkien,SAMIARG) ; creates patient-lookup record
"RTN","SAMIHOM4",400,0)
 ;
"RTN","SAMIHOM4",401,0)
 n ssn s ssn=SAMIARG("ssn")
"RTN","SAMIHOM4",402,0)
 s ssn=$tr(ssn,"-")
"RTN","SAMIHOM4",403,0)
 n name s name=$g(SAMIARG("name"))
"RTN","SAMIHOM4",404,0)
 n sinamef,sinamel
"RTN","SAMIHOM4",405,0)
 s sinamel=$p(name,","),sinamel=$$TRIM^XLFSTR(sinamel,"LR")
"RTN","SAMIHOM4",406,0)
 s sinamef=$p(name,",",2),sinamef=$$TRIM^XLFSTR(sinamef,"LR")
"RTN","SAMIHOM4",407,0)
 s name=sinamel_","_sinamef
"RTN","SAMIHOM4",408,0)
 n siteid s siteid=$g(SAMIARG("siteid"))
"RTN","SAMIHOM4",409,0)
 i siteid="" s siteid=$g(SAMIARG("site"))
"RTN","SAMIHOM4",410,0)
 ;
"RTN","SAMIHOM4",411,0)
 s @root@(ptlkien,"siteid")=siteid
"RTN","SAMIHOM4",412,0)
 s @root@(ptlkien,"saminame")=name
"RTN","SAMIHOM4",413,0)
 s @root@(ptlkien,"sinamef")=sinamef
"RTN","SAMIHOM4",414,0)
 s @root@(ptlkien,"sinamel")=sinamel
"RTN","SAMIHOM4",415,0)
 n fmdob s fmdob=$$FMDT^SAMIUR2(SAMIARG("dob"))
"RTN","SAMIHOM4",416,0)
 n ptlkdob s ptlkdob=$$FMTE^XLFDT(fmdob,7)
"RTN","SAMIHOM4",417,0)
 s ptlkdob=$TR(ptlkdob,"/","-")
"RTN","SAMIHOM4",418,0)
 s @root@(ptlkien,"dob")=ptlkdob
"RTN","SAMIHOM4",419,0)
 s @root@(ptlkien,"sbdob")=ptlkdob
"RTN","SAMIHOM4",420,0)
 n gender s gender=SAMIARG("gender")
"RTN","SAMIHOM4",421,0)
 s @root@(ptlkien,"gender")=$s(gender="M":"M^MALE",1:"F^FEMALE")
"RTN","SAMIHOM4",422,0)
 s @root@(ptlkien,"sex")=SAMIARG("gender")
"RTN","SAMIHOM4",423,0)
 s @root@(ptlkien,"icn")=SAMIARG("icn")
"RTN","SAMIHOM4",424,0)
 s @root@(ptlkien,"ssn")=ssn
"RTN","SAMIHOM4",425,0)
 n last5 s last5=$$UCASE($e(name,1))_$e(ssn,6,9)
"RTN","SAMIHOM4",426,0)
 s @root@(ptlkien,"last5")=last5
"RTN","SAMIHOM4",427,0)
 n mymatch s mymatch=$g(SAMIARG("MATCHLOG"))
"RTN","SAMIHOM4",428,0)
 i mymatch'="" s @root@(ptlkien,"MATCHLOG")=mymatch
"RTN","SAMIHOM4",429,0)
 ;
"RTN","SAMIHOM4",430,0)
 quit  ; end of MKPTLK
"RTN","SAMIHOM4",431,0)
 ;
"RTN","SAMIHOM4",432,0)
 ;
"RTN","SAMIHOM4",433,0)
 ;
"RTN","SAMIHOM4",434,0)
UPDTFRMS(dfn) ; update demographics in all forms for patient
"RTN","SAMIHOM4",435,0)
 ;
"RTN","SAMIHOM4",436,0)
 n lroot s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",437,0)
 n proot s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",438,0)
 n lien s lien=$o(@lroot@("dfn",dfn,""))
"RTN","SAMIHOM4",439,0)
 q:lien=""
"RTN","SAMIHOM4",440,0)
 n pien s pien=$o(@proot@("dfn",dfn,""))
"RTN","SAMIHOM4",441,0)
 q:pien=""
"RTN","SAMIHOM4",442,0)
 ; this patient has forms
"RTN","SAMIHOM4",443,0)
 m @proot@(pien)=@lroot@(lien) ; refresh the demos in the patient record
"RTN","SAMIHOM4",444,0)
 n ssn s ssn=$g(@proot@(pien,"ssn"))
"RTN","SAMIHOM4",445,0)
 s @proot@(pien,"sissn")=$e(ssn,1,3)_"-"_$e(ssn,4,5)_"-"_$e(ssn,6,9)
"RTN","SAMIHOM4",446,0)
 n sid s sid=$g(@proot@("sisid")) ; studyid 
"RTN","SAMIHOM4",447,0)
 q:sid=""  ; no studyid
"RTN","SAMIHOM4",448,0)
 n zi s zi=""
"RTN","SAMIHOM4",449,0)
 f  s zi=$o(@proot@("graph",sid,zi)) q:zi=""  d  ; for each form
"RTN","SAMIHOM4",450,0)
 . m @proot@("graph",sid,zi)=@proot@(pien) ; stamp each form with new demos
"RTN","SAMIHOM4",451,0)
 ;
"RTN","SAMIHOM4",452,0)
 quit  ; end of UPDTFRMS
"RTN","SAMIHOM4",453,0)
 ;
"RTN","SAMIHOM4",454,0)
 ;
"RTN","SAMIHOM4",455,0)
 ;
"RTN","SAMIHOM4",456,0)
MERGE(SAMIRESULT,SAMIARGS) ; merge participant records
"RTN","SAMIHOM4",457,0)
 ;
"RTN","SAMIHOM4",458,0)
 ; called from pressing the merge button on the unmatched report
"RTN","SAMIHOM4",459,0)
 ;
"RTN","SAMIHOM4",460,0)
 n toien s toien=$g(SAMIARGS("toien"))
"RTN","SAMIHOM4",461,0)
 i toien="" d  q  ;
"RTN","SAMIHOM4",462,0)
 . d WSUNMAT(.SAMIRESULT,.SAMIARGS)
"RTN","SAMIHOM4",463,0)
 n lroot s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",464,0)
 n fromien s fromien=$g(@lroot@(toien,"MATCHLOG"))
"RTN","SAMIHOM4",465,0)
 i fromien="" d  q  ;
"RTN","SAMIHOM4",466,0)
 . d WSUNMAT(.SAMIRESULT,.SAMIARGS)
"RTN","SAMIHOM4",467,0)
 ;
"RTN","SAMIHOM4",468,0)
 ; test for remotedfn in from record - not valid if absent
"RTN","SAMIHOM4",469,0)
 ;
"RTN","SAMIHOM4",470,0)
 i $g(@lroot@(fromien,"remotedfn"))="" d  q  ;
"RTN","SAMIHOM4",471,0)
 . d WSUNMAT(.SAMIRESULT,.SAMIARGS)
"RTN","SAMIHOM4",472,0)
 ;
"RTN","SAMIHOM4",473,0)
 ; remove index entries for from and to records
"RTN","SAMIHOM4",474,0)
 ;
"RTN","SAMIHOM4",475,0)
 d UNINDXPT(fromien) ; delete index entries
"RTN","SAMIHOM4",476,0)
 d UNINDXPT(toien)
"RTN","SAMIHOM4",477,0)
 ;
"RTN","SAMIHOM4",478,0)
 ; create changelog entry in to record - contains from record
"RTN","SAMIHOM4",479,0)
 ;
"RTN","SAMIHOM4",480,0)
 m @lroot@(toien,"changelog",$$FMTE^XLFDT($$NOW^XLFDT,5))=@lroot@(fromien)
"RTN","SAMIHOM4",481,0)
 ;
"RTN","SAMIHOM4",482,0)
 ; change the dfn in the from record to the to record dfn for merging
"RTN","SAMIHOM4",483,0)
 ;
"RTN","SAMIHOM4",484,0)
 s @lroot@(fromien,"dfn")=@lroot@(toien,"dfn")
"RTN","SAMIHOM4",485,0)
 n dfn s dfn=@lroot@(toien,"dfn") ; for use in updating forms
"RTN","SAMIHOM4",486,0)
 ;
"RTN","SAMIHOM4",487,0)
 ; merge the from record to the to record
"RTN","SAMIHOM4",488,0)
 ;
"RTN","SAMIHOM4",489,0)
 m @lroot@(toien)=@lroot@(fromien)
"RTN","SAMIHOM4",490,0)
 ;
"RTN","SAMIHOM4",491,0)
 ; delete the from record
"RTN","SAMIHOM4",492,0)
 ;
"RTN","SAMIHOM4",493,0)
 k @lroot@(fromien)
"RTN","SAMIHOM4",494,0)
 ;
"RTN","SAMIHOM4",495,0)
 ; reindex the to record
"RTN","SAMIHOM4",496,0)
 ;
"RTN","SAMIHOM4",497,0)
 d INDXPTLK(toien)
"RTN","SAMIHOM4",498,0)
 ;
"RTN","SAMIHOM4",499,0)
 ; propagate the updated from record to every form
"RTN","SAMIHOM4",500,0)
 ;
"RTN","SAMIHOM4",501,0)
 d UPDTFRMS(dfn) ; updates the patient in the vapals-patient graph
"RTN","SAMIHOM4",502,0)
 ;
"RTN","SAMIHOM4",503,0)
 ; leave and return to the unmatched report
"RTN","SAMIHOM4",504,0)
 ;   note that the form and to records will no longer be in the report
"RTN","SAMIHOM4",505,0)
 ;
"RTN","SAMIHOM4",506,0)
 d WSUNMAT(.SAMIRESULT,.SAMIARGS)
"RTN","SAMIHOM4",507,0)
 ;
"RTN","SAMIHOM4",508,0)
 quit  ; end of MERGE
"RTN","SAMIHOM4",509,0)
 ;
"RTN","SAMIHOM4",510,0)
 ;
"RTN","SAMIHOM4",511,0)
 ;
"RTN","SAMIHOM4",512,0)
ADDUNMAT ; adds unmatched report web service to system
"RTN","SAMIHOM4",513,0)
 ;
"RTN","SAMIHOM4",514,0)
 d addService^%webutils("GET","unmatched","WSUNMAT^SAMIHOM4")
"RTN","SAMIHOM4",515,0)
 ;
"RTN","SAMIHOM4",516,0)
 quit  ; end of ADDUNMAT
"RTN","SAMIHOM4",517,0)
 ;
"RTN","SAMIHOM4",518,0)
 ;
"RTN","SAMIHOM4",519,0)
 ;
"RTN","SAMIHOM4",520,0)
DELUNMAT ; deletes unmatched web service
"RTN","SAMIHOM4",521,0)
 ;
"RTN","SAMIHOM4",522,0)
 d deleteService^%webutils("GET","unmatched")
"RTN","SAMIHOM4",523,0)
 ;
"RTN","SAMIHOM4",524,0)
 quit  ; end of DELUNMAT
"RTN","SAMIHOM4",525,0)
 ;
"RTN","SAMIHOM4",526,0)
 ;
"RTN","SAMIHOM4",527,0)
 ;
"RTN","SAMIHOM4",528,0)
WSUNMAT(SAMIRESULT,SAMIARGS) ; navigates to unmatched report
"RTN","SAMIHOM4",529,0)
 ; 
"RTN","SAMIHOM4",530,0)
 n filter,bdy
"RTN","SAMIHOM4",531,0)
 s bdy=""
"RTN","SAMIHOM4",532,0)
 ;s filter("siteid")="PHX"
"RTN","SAMIHOM4",533,0)
 s filter("samiroute")="report"
"RTN","SAMIHOM4",534,0)
 s filter("samireporttype")="unmatched"
"RTN","SAMIHOM4",535,0)
 d WSVAPALS^SAMIHOM3(.filter,.bdy,.SAMIRESULT) ; back to the unmatched report
"RTN","SAMIHOM4",536,0)
 ;
"RTN","SAMIHOM4",537,0)
 quit  ; end of WSUNMAT
"RTN","SAMIHOM4",538,0)
 ;
"RTN","SAMIHOM4",539,0)
 ;
"RTN","SAMIHOM4",540,0)
 ;
"RTN","SAMIHOM4",541,0)
DUPSSN(ssn) ; extrinsic returns true if duplicate ssn
"RTN","SAMIHOM4",542,0)
 ;
"RTN","SAMIHOM4",543,0)
 n proot s proot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",544,0)
 i $d(@proot@("ssn",ssn)) q 1
"RTN","SAMIHOM4",545,0)
 ;
"RTN","SAMIHOM4",546,0)
 quit 0 ; end of $$DUPSSN
"RTN","SAMIHOM4",547,0)
 ;
"RTN","SAMIHOM4",548,0)
 ;
"RTN","SAMIHOM4",549,0)
 ;
"RTN","SAMIHOM4",550,0)
DUPICN(icn) ; extrinsic returns true if duplicate icn
"RTN","SAMIHOM4",551,0)
 ;
"RTN","SAMIHOM4",552,0)
 n proot s proot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",553,0)
 n tmpicn s tmpicn=$p(icn,"V",1)
"RTN","SAMIHOM4",554,0)
 i $d(@proot@("icn",icn)) q 1
"RTN","SAMIHOM4",555,0)
 i $d(@proot@("icn",tmpicn)) q 1
"RTN","SAMIHOM4",556,0)
 ;
"RTN","SAMIHOM4",557,0)
 quit 0 ; end of $$DUPICN
"RTN","SAMIHOM4",558,0)
 ;
"RTN","SAMIHOM4",559,0)
 ;
"RTN","SAMIHOM4",560,0)
 ;
"RTN","SAMIHOM4",561,0)
BADICN(icn) ; extrinsic returns true if ICN checkdigits are wrong
"RTN","SAMIHOM4",562,0)
 ;
"RTN","SAMIHOM4",563,0)
 n zchk s zchk=$p(icn,"V",2)
"RTN","SAMIHOM4",564,0)
 n zicn s zicn=$p(icn,"V",1)
"RTN","SAMIHOM4",565,0)
 q:zchk="" 1
"RTN","SAMIHOM4",566,0)
 i zchk'=$$CHECKDG^MPIFSPC(zicn) q 1
"RTN","SAMIHOM4",567,0)
 ;
"RTN","SAMIHOM4",568,0)
 quit 0
"RTN","SAMIHOM4",569,0)
 ;
"RTN","SAMIHOM4",570,0)
 ;
"RTN","SAMIHOM4",571,0)
 ;
"RTN","SAMIHOM4",572,0)
SAVE(SAMIRESULT,SAMIARG) ; save patient-lookup record after edit
"RTN","SAMIHOM4",573,0)
 ;
"RTN","SAMIHOM4",574,0)
 n dfn s dfn=$g(vars("dfn")) ; must have a dfn
"RTN","SAMIHOM4",575,0)
 i dfn="" d  q  ;
"RTN","SAMIHOM4",576,0)
 . d GETHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG) ; on error go home 
"RTN","SAMIHOM4",577,0)
 n root s root=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",578,0)
 n sien s sien=$o(@root@("dfn",dfn,""))
"RTN","SAMIHOM4",579,0)
 i sien="" d  q  ;
"RTN","SAMIHOM4",580,0)
 . d GETHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG) ; on error go home 
"RTN","SAMIHOM4",581,0)
 d UNINDXPT(sien) ; remove old index entries
"RTN","SAMIHOM4",582,0)
 n zm
"RTN","SAMIHOM4",583,0)
 k SAMIARG("MATCHLOG")
"RTN","SAMIHOM4",584,0)
 s zm=$$REMATCH(sien,.SAMIARG)
"RTN","SAMIHOM4",585,0)
 i zm>0 d  ;
"RTN","SAMIHOM4",586,0)
 . s SAMIARG("MATCHLOG")=zm
"RTN","SAMIHOM4",587,0)
 d MKPTLK(sien,.SAMIARG) ; add the updated fields
"RTN","SAMIHOM4",588,0)
 d INDXPTLK(sien) ; create new index entries
"RTN","SAMIHOM4",589,0)
 d UPDTFRMS(dfn) ; update demographic info in all forms
"RTN","SAMIHOM4",590,0)
 n filter,bdy
"RTN","SAMIHOM4",591,0)
 s bdy=""
"RTN","SAMIHOM4",592,0)
 m filter=SAMIARG
"RTN","SAMIHOM4",593,0)
 s filter("samiroute")="report"
"RTN","SAMIHOM4",594,0)
 s filter("samireporttype")="unmatched"
"RTN","SAMIHOM4",595,0)
 d WSVAPALS^SAMIHOM3(.filter,.bdy,.SAMIRESULT) ; back to the unmatched report
"RTN","SAMIHOM4",596,0)
 ;
"RTN","SAMIHOM4",597,0)
 quit  ; end of SAVE
"RTN","SAMIHOM4",598,0)
 ;
"RTN","SAMIHOM4",599,0)
 ;
"RTN","SAMIHOM4",600,0)
 ;
"RTN","SAMIHOM4",601,0)
REMATCH(sien,SAMIARG) ; extrinsic returns possible match ien
"RTN","SAMIHOM4",602,0)
 ;
"RTN","SAMIHOM4",603,0)
 ; else zero
"RTN","SAMIHOM4",604,0)
 ;
"RTN","SAMIHOM4",605,0)
 n lroot s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",606,0)
 n ssn,name,icn,x,y
"RTN","SAMIHOM4",607,0)
 s ssn=$g(SAMIARG("ssn"))
"RTN","SAMIHOM4",608,0)
 i ssn["-" s ssn=$tr(ssn,"-")
"RTN","SAMIHOM4",609,0)
 s name=$g(SAMIARG("saminame"))
"RTN","SAMIHOM4",610,0)
 i name="" s name=$g(SAMIARG("name"))
"RTN","SAMIHOM4",611,0)
 s name=$$UCASE(name)
"RTN","SAMIHOM4",612,0)
 s icn=$g(SAMIARG("icn"))
"RTN","SAMIHOM4",613,0)
 s x=0
"RTN","SAMIHOM4",614,0)
 i ssn'="" s x=$o(@lroot@("ssn",ssn,""))
"RTN","SAMIHOM4",615,0)
 i x=sien s x=$o(@lroot@("ssn",ssn,x))
"RTN","SAMIHOM4",616,0)
 i +x'=0 d  ;
"RTN","SAMIHOM4",617,0)
 . s y=$g(@lroot@(x,"dfn"))
"RTN","SAMIHOM4",618,0)
 . ;i y>9000000 s x=0
"RTN","SAMIHOM4",619,0)
 i x>0 q x
"RTN","SAMIHOM4",620,0)
 i name'="" s x=$o(@lroot@("name",name,""))
"RTN","SAMIHOM4",621,0)
 i x=sien s x=$o(@lroot@("name",name,x))
"RTN","SAMIHOM4",622,0)
 i +x'=0 d  ;
"RTN","SAMIHOM4",623,0)
 . s y=$g(@lroot@(x,"dfn"))
"RTN","SAMIHOM4",624,0)
 . ;i y>9000000 s x=0
"RTN","SAMIHOM4",625,0)
 i x>0 q x
"RTN","SAMIHOM4",626,0)
 ;i icn'="" s x=$o(@lroot@("icn",icn,""))
"RTN","SAMIHOM4",627,0)
 ;i x=sien s x=$o(@lroot@("icn",icn,x))
"RTN","SAMIHOM4",628,0)
 ;i +x'=0 d  ;
"RTN","SAMIHOM4",629,0)
 ;. s y=$g(@lroot@(x,"dfn"))
"RTN","SAMIHOM4",630,0)
 ;. i y>9000000 s x=0
"RTN","SAMIHOM4",631,0)
 ;i x>0 q x
"RTN","SAMIHOM4",632,0)
 ;
"RTN","SAMIHOM4",633,0)
 quit 0 ; end of $$REMATCH
"RTN","SAMIHOM4",634,0)
 ;
"RTN","SAMIHOM4",635,0)
 ;
"RTN","SAMIHOM4",636,0)
 ;
"RTN","SAMIHOM4",637,0)
SETINFO(vars,msg) ; set information message text
"RTN","SAMIHOM4",638,0)
 ;
"RTN","SAMIHOM4",639,0)
 ; vars are the screen variables passed by reference
"RTN","SAMIHOM4",640,0)
 ;
"RTN","SAMIHOM4",641,0)
 s vars("infoMessage")=msg
"RTN","SAMIHOM4",642,0)
 ;
"RTN","SAMIHOM4",643,0)
 quit  ; end of SETINFO
"RTN","SAMIHOM4",644,0)
 ;
"RTN","SAMIHOM4",645,0)
 ;
"RTN","SAMIHOM4",646,0)
 ;
"RTN","SAMIHOM4",647,0)
SETWARN(vars,msg) ; set warning message text
"RTN","SAMIHOM4",648,0)
 ;
"RTN","SAMIHOM4",649,0)
 ; vars are the screen variables passed by reference
"RTN","SAMIHOM4",650,0)
 ;
"RTN","SAMIHOM4",651,0)
 s vars("warnMessage")=msg
"RTN","SAMIHOM4",652,0)
 ;
"RTN","SAMIHOM4",653,0)
 quit  ; end of SETWARN
"RTN","SAMIHOM4",654,0)
 ;
"RTN","SAMIHOM4",655,0)
 ;
"RTN","SAMIHOM4",656,0)
 ; 
"RTN","SAMIHOM4",657,0)
RTNERR(rtn,form,vals,msg,fld) ; redisplay page w/error message
"RTN","SAMIHOM4",658,0)
 ;
"RTN","SAMIHOM4",659,0)
 ; rtn is the return array
"RTN","SAMIHOM4",660,0)
 ; form is the form the page requires
"RTN","SAMIHOM4",661,0)
 ; vals are the values for the page. passed by reference
"RTN","SAMIHOM4",662,0)
 ; msg is the error message to be displayed
"RTN","SAMIHOM4",663,0)
 ; fld is the name of the field where the cursor should be put
"RTN","SAMIHOM4",664,0)
 ;
"RTN","SAMIHOM4",665,0)
 n zhtml ; work area for the tempate
"RTN","SAMIHOM4",666,0)
 d SAMIHTM^%wf(.zhtml,form,.err)
"RTN","SAMIHOM4",667,0)
 d MERGEHTM^%wf(.zhtml,.vals,.err)
"RTN","SAMIHOM4",668,0)
 m rtn=zhtml
"RTN","SAMIHOM4",669,0)
 set HTTPRSP("mime")="text/html" ; set mime type
"RTN","SAMIHOM4",670,0)
 ;
"RTN","SAMIHOM4",671,0)
 quit  ; end of RTNERR
"RTN","SAMIHOM4",672,0)
 ;
"RTN","SAMIHOM4",673,0)
 ;
"RTN","SAMIHOM4",674,0)
 ;
"RTN","SAMIHOM4",675,0)
RTNPAGE(rtn,form,vals) ; display page
"RTN","SAMIHOM4",676,0)
 ;
"RTN","SAMIHOM4",677,0)
 ; rtn is the return array
"RTN","SAMIHOM4",678,0)
 ; form is the form the page requires
"RTN","SAMIHOM4",679,0)
 ; vals are the values for the page. passed by reference
"RTN","SAMIHOM4",680,0)
 ;
"RTN","SAMIHOM4",681,0)
 n err
"RTN","SAMIHOM4",682,0)
 n zhtml ; work area for the tempate
"RTN","SAMIHOM4",683,0)
 d SAMIHTM^%wf(.zhtml,form,.err)
"RTN","SAMIHOM4",684,0)
 d MERGEHTM^%wf(.zhtml,.vals,.err)
"RTN","SAMIHOM4",685,0)
 m SAMIRESULT=zhtml
"RTN","SAMIHOM4",686,0)
 set HTTPRSP("mime")="text/html" ; set mime type
"RTN","SAMIHOM4",687,0)
 ;
"RTN","SAMIHOM4",688,0)
 quit  ; end of RTNPAGE
"RTN","SAMIHOM4",689,0)
 ;
"RTN","SAMIHOM4",690,0)
 ;
"RTN","SAMIHOM4",691,0)
 ;
"RTN","SAMIHOM4",692,0)
REINDXPL ; reindex patient lookup
"RTN","SAMIHOM4",693,0)
 ;
"RTN","SAMIHOM4",694,0)
 n root s root=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",695,0)
 n zi s zi=0
"RTN","SAMIHOM4",696,0)
 k @root@("ssn")
"RTN","SAMIHOM4",697,0)
 k @root@("name")
"RTN","SAMIHOM4",698,0)
 k @root@("last5")
"RTN","SAMIHOM4",699,0)
 k @root@("sinamef")
"RTN","SAMIHOM4",700,0)
 k @root@("sinamel")
"RTN","SAMIHOM4",701,0)
 k @root@("icn")
"RTN","SAMIHOM4",702,0)
 f  s zi=$o(@root@(zi)) q:+zi=0  d  ;
"RTN","SAMIHOM4",703,0)
 . d INDXPTLK(zi)
"RTN","SAMIHOM4",704,0)
 ;
"RTN","SAMIHOM4",705,0)
 quit  ; end of REINDXPL
"RTN","SAMIHOM4",706,0)
 ;
"RTN","SAMIHOM4",707,0)
 ;
"RTN","SAMIHOM4",708,0)
 ;
"RTN","SAMIHOM4",709,0)
INDXPTLK(ien) ; generate index entries in patient-lookup graph
"RTN","SAMIHOM4",710,0)
 ;
"RTN","SAMIHOM4",711,0)
 ; for entry ien
"RTN","SAMIHOM4",712,0)
 ;
"RTN","SAMIHOM4",713,0)
 n proot set proot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",714,0)
 n name s name=$g(@proot@(ien,"saminame"))
"RTN","SAMIHOM4",715,0)
 s @proot@("name",name,ien)=""
"RTN","SAMIHOM4",716,0)
 n ucname s ucname=$$UCASE(name)
"RTN","SAMIHOM4",717,0)
 s @proot@("name",ucname,ien)=""
"RTN","SAMIHOM4",718,0)
 n x
"RTN","SAMIHOM4",719,0)
 s x=$g(@proot@(ien,"dfn")) ;w !,x
"RTN","SAMIHOM4",720,0)
 s:x'="" @proot@("dfn",x,ien)=""
"RTN","SAMIHOM4",721,0)
 s x=$g(@proot@(ien,"last5")) ;w !,x
"RTN","SAMIHOM4",722,0)
 s:x'="" @proot@("last5",x,ien)=""
"RTN","SAMIHOM4",723,0)
 s x=$g(@proot@(ien,"icn")) ;w !,x
"RTN","SAMIHOM4",724,0)
 i x'["V" d  ;
"RTN","SAMIHOM4",725,0)
 . i x="" q
"RTN","SAMIHOM4",726,0)
 . n chk s chk=$$CHECKDG^MPIFSPC(x)
"RTN","SAMIHOM4",727,0)
 . s @proot@(ien,"icn")=x_"V"_chk
"RTN","SAMIHOM4",728,0)
 . s x=x_"V"_chk
"RTN","SAMIHOM4",729,0)
 s:x'="" @proot@("icn",x,ien)=""
"RTN","SAMIHOM4",730,0)
 s x=$g(@proot@(ien,"ssn")) ;w !,x
"RTN","SAMIHOM4",731,0)
 s:x'="" @proot@("ssn",x,ien)=""
"RTN","SAMIHOM4",732,0)
 s x=$g(@proot@(ien,"sinamef")) ;w !,x
"RTN","SAMIHOM4",733,0)
 s:x'="" @proot@("sinamef",x,ien)=""
"RTN","SAMIHOM4",734,0)
 s x=$g(@proot@(ien,"sinamel")) w !,x
"RTN","SAMIHOM4",735,0)
 s:x'="" @proot@("sinamel",x,ien)=""
"RTN","SAMIHOM4",736,0)
 set @proot@("Date Last Updated")=$$HTE^XLFDT($horolog)
"RTN","SAMIHOM4",737,0)
 ;
"RTN","SAMIHOM4",738,0)
 quit  ; end of INDXPTLK
"RTN","SAMIHOM4",739,0)
 ;
"RTN","SAMIHOM4",740,0)
 ;
"RTN","SAMIHOM4",741,0)
 ;
"RTN","SAMIHOM4",742,0)
UNINDXPT(ien) ; remove index entries from patient-lookup graph
"RTN","SAMIHOM4",743,0)
 ;
"RTN","SAMIHOM4",744,0)
 ; for entry ien
"RTN","SAMIHOM4",745,0)
 ;
"RTN","SAMIHOM4",746,0)
 n proot set proot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",747,0)
 n name s name=$g(@proot@(ien,"saminame"))
"RTN","SAMIHOM4",748,0)
 k @proot@("name",name,ien)
"RTN","SAMIHOM4",749,0)
 n ucname s ucname=$$UCASE(name)
"RTN","SAMIHOM4",750,0)
 k @proot@("name",ucname,ien)
"RTN","SAMIHOM4",751,0)
 n x
"RTN","SAMIHOM4",752,0)
 s x=$g(@proot@(ien,"dfn")) ;w !,x
"RTN","SAMIHOM4",753,0)
 k:x'="" @proot@("dfn",x,ien)
"RTN","SAMIHOM4",754,0)
 s x=$g(@proot@(ien,"last5")) ;w !,x
"RTN","SAMIHOM4",755,0)
 k:x'="" @proot@("last5",x,ien)
"RTN","SAMIHOM4",756,0)
 s x=$g(@proot@(ien,"icn")) ;w !,x
"RTN","SAMIHOM4",757,0)
 i x'["V" d  ;
"RTN","SAMIHOM4",758,0)
 . i x="" q
"RTN","SAMIHOM4",759,0)
 . n chk s chk=$$CHECKDG^MPIFSPC(x)
"RTN","SAMIHOM4",760,0)
 . s @proot@(ien,"icn")=x_"V"_chk
"RTN","SAMIHOM4",761,0)
 . s x=x_"V"_chk
"RTN","SAMIHOM4",762,0)
 k:x'="" @proot@("icn",x,ien)
"RTN","SAMIHOM4",763,0)
 s x=$g(@proot@(ien,"ssn")) ;w !,x
"RTN","SAMIHOM4",764,0)
 k:x'="" @proot@("ssn",x,ien)
"RTN","SAMIHOM4",765,0)
 s x=$g(@proot@(ien,"sinamef")) ;w !,x
"RTN","SAMIHOM4",766,0)
 k:x'="" @proot@("sinamef",x,ien)
"RTN","SAMIHOM4",767,0)
 s x=$g(@proot@(ien,"sinamel")) w !,x
"RTN","SAMIHOM4",768,0)
 k:x'="" @proot@("sinamel",x,ien)
"RTN","SAMIHOM4",769,0)
 set @proot@("Date Last Updated")=$$HTE^XLFDT($horolog)
"RTN","SAMIHOM4",770,0)
 ;
"RTN","SAMIHOM4",771,0)
 quit  ; end of UNINDXPT
"RTN","SAMIHOM4",772,0)
 ;
"RTN","SAMIHOM4",773,0)
 ;
"RTN","SAMIHOM4",774,0)
 ;
"RTN","SAMIHOM4",775,0)
UCASE(STR) ; extrinsic returns uppercase of STR
"RTN","SAMIHOM4",776,0)
 ;
"RTN","SAMIHOM4",777,0)
 N X,Y
"RTN","SAMIHOM4",778,0)
 S X=STR
"RTN","SAMIHOM4",779,0)
 X ^%ZOSF("UPPERCASE")
"RTN","SAMIHOM4",780,0)
 ;
"RTN","SAMIHOM4",781,0)
 quit Y ; end of $$UCASE
"RTN","SAMIHOM4",782,0)
 ;
"RTN","SAMIHOM4",783,0)
 ;
"RTN","SAMIHOM4",784,0)
 ;
"RTN","SAMIHOM4",785,0)
 ;@wsi-code DEVHOME^SAMIHOM3
"RTN","SAMIHOM4",786,0)
DEVHOME ; temporary home page for development
"RTN","SAMIHOM4",787,0)
 ;
"RTN","SAMIHOM4",788,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM4",789,0)
 ;
"RTN","SAMIHOM4",790,0)
 ;ven/gpl;private;procedure;
"RTN","SAMIHOM4",791,0)
 ;@signature
"RTN","SAMIHOM4",792,0)
 ; do DEVHOME^SAMIHOM3(SAMIRTN,SAMIFILTER)
"RTN","SAMIHOM4",793,0)
 ;@branches-from
"RTN","SAMIHOM4",794,0)
 ; DEVHOME^SAMIHOM3
"RTN","SAMIHOM4",795,0)
 ;@called-by
"RTN","SAMIHOM4",796,0)
 ; WSHOME
"RTN","SAMIHOM4",797,0)
 ;@calls
"RTN","SAMIHOM4",798,0)
 ; htmltb2^%yottaweb
"RTN","SAMIHOM4",799,0)
 ; PATLIST
"RTN","SAMIHOM4",800,0)
 ; genhtml^%yottautl
"RTN","SAMIHOM4",801,0)
 ; addary^%yottautl
"RTN","SAMIHOM4",802,0)
 ;@input
"RTN","SAMIHOM4",803,0)
 ; SAMIFILTER =
"RTN","SAMIHOM4",804,0)
 ;@output
"RTN","SAMIHOM4",805,0)
 ;.SAMIRTN =
"RTN","SAMIHOM4",806,0)
 ;@examples [tbd]
"RTN","SAMIHOM4",807,0)
 ;@tests [tbd]
"RTN","SAMIHOM4",808,0)
 ;
"RTN","SAMIHOM4",809,0)
 ;@stanza 2 ?
"RTN","SAMIHOM4",810,0)
 ;
"RTN","SAMIHOM4",811,0)
 new gtop,gbot
"RTN","SAMIHOM4",812,0)
 do htmltb2^%yottaweb(.gtop,.gbot,"SAMI Test Patients")
"RTN","SAMIHOM4",813,0)
 ;
"RTN","SAMIHOM4",814,0)
 new html,ary,hpat
"RTN","SAMIHOM4",815,0)
 do PATLIST^SAMIHOM3("hpat")
"RTN","SAMIHOM4",816,0)
 quit:'$data(hpat)
"RTN","SAMIHOM4",817,0)
 ;
"RTN","SAMIHOM4",818,0)
 set ary("title")="SAMI Test Patients on this system"
"RTN","SAMIHOM4",819,0)
 set ary("header",1)="StudyId"
"RTN","SAMIHOM4",820,0)
 set ary("header",2)="Name"
"RTN","SAMIHOM4",821,0)
 ;
"RTN","SAMIHOM4",822,0)
 new cnt set cnt=0
"RTN","SAMIHOM4",823,0)
 new zi set zi=""
"RTN","SAMIHOM4",824,0)
 for  set zi=$order(hpat(zi)) quit:zi=""  do  ;
"RTN","SAMIHOM4",825,0)
 . set cnt=cnt+1
"RTN","SAMIHOM4",826,0)
 . new url set url="<a href=""/cform.cgi?studyId="_zi_""">"_zi_"</a>"
"RTN","SAMIHOM4",827,0)
 . set ary(cnt,1)=url
"RTN","SAMIHOM4",828,0)
 . set ary(cnt,2)=""
"RTN","SAMIHOM4",829,0)
 . quit
"RTN","SAMIHOM4",830,0)
 ;
"RTN","SAMIHOM4",831,0)
 do genhtml^%yottautl("html","ary")
"RTN","SAMIHOM4",832,0)
 ;
"RTN","SAMIHOM4",833,0)
 do addary^%yottautl("SAMIRTN","gtop")
"RTN","SAMIHOM4",834,0)
 do addary^%yottautl("SAMIRTN","html")
"RTN","SAMIHOM4",835,0)
 set SAMIRTN($order(SAMIRTN(""),-1)+1)=gbot
"RTN","SAMIHOM4",836,0)
 kill SAMIRTN(0)
"RTN","SAMIHOM4",837,0)
 ;
"RTN","SAMIHOM4",838,0)
 set HTTPRSP("mime")="text/html"
"RTN","SAMIHOM4",839,0)
 ;
"RTN","SAMIHOM4",840,0)
 ;@stanza ? termination
"RTN","SAMIHOM4",841,0)
 ;
"RTN","SAMIHOM4",842,0)
 quit  ; end of wsi DEVHOME^SAMIHOM3
"RTN","SAMIHOM4",843,0)
 ;
"RTN","SAMIHOM4",844,0)
 ;
"RTN","SAMIHOM4",845,0)
 ;
"RTN","SAMIHOM4",846,0)
 ;@wsi-code GETHOME^SAMIHOM3
"RTN","SAMIHOM4",847,0)
GETHOME ; homepage accessed using GET
"RTN","SAMIHOM4",848,0)
 ;
"RTN","SAMIHOM4",849,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM4",850,0)
 ;
"RTN","SAMIHOM4",851,0)
 ;ven/gpl;private;procedure;
"RTN","SAMIHOM4",852,0)
 ;@signature
"RTN","SAMIHOM4",853,0)
 ; do GETHOME^SAMIHOM3(SAMIRTN,SAMIFILTER)
"RTN","SAMIHOM4",854,0)
 ;@branches-from
"RTN","SAMIHOM4",855,0)
 ; GETHOME^SAMIHOM3
"RTN","SAMIHOM4",856,0)
 ;@called-by
"RTN","SAMIHOM4",857,0)
 ; WSHOME
"RTN","SAMIHOM4",858,0)
 ; WSNEWCAS
"RTN","SAMIHOM4",859,0)
 ; WSNFPOST^SAMICASE
"RTN","SAMIHOM4",860,0)
 ; wsLookup^SAMISRCH
"RTN","SAMIHOM4",861,0)
 ;@calls
"RTN","SAMIHOM4",862,0)
 ; GETTMPL^SAMICASE
"RTN","SAMIHOM4",863,0)
 ; findReplace^%ts
"RTN","SAMIHOM4",864,0)
 ; $$SCANFOR
"RTN","SAMIHOM4",865,0)
 ; ADDCRLF^VPRJRUT
"RTN","SAMIHOM4",866,0)
 ;@input
"RTN","SAMIHOM4",867,0)
 ; SAMIFILTER =
"RTN","SAMIHOM4",868,0)
 ;@output
"RTN","SAMIHOM4",869,0)
 ;.SAMIRTN =
"RTN","SAMIHOM4",870,0)
 ;@examples [tbd]
"RTN","SAMIHOM4",871,0)
 ;@tests [tbd]
"RTN","SAMIHOM4",872,0)
 ;
"RTN","SAMIHOM4",873,0)
 ;@stanza 2 get template for homepage
"RTN","SAMIHOM4",874,0)
 ;
"RTN","SAMIHOM4",875,0)
 ; Processing for multi-tenancy
"RTN","SAMIHOM4",876,0)
 ;
"RTN","SAMIHOM4",877,0)
 if $G(SAMIFILTER("siteid"))="" if '$$FINDSITE^SAMISITE(.SAMIRTN,.SAMIFILTER) Q 0
"RTN","SAMIHOM4",878,0)
 new SAMISITE,SAMITITL
"RTN","SAMIHOM4",879,0)
 s SAMISITE=$G(SAMIFILTER("siteid"))
"RTN","SAMIHOM4",880,0)
 s SAMITITL=$G(SAMIFILTER("sitetitle"))
"RTN","SAMIHOM4",881,0)
 ;
"RTN","SAMIHOM4",882,0)
 new temp,tout,form
"RTN","SAMIHOM4",883,0)
 s form="vapals:home"
"RTN","SAMIHOM4",884,0)
 do GETTMPL^SAMICASE("temp",form)
"RTN","SAMIHOM4",885,0)
 quit:'$data(temp)
"RTN","SAMIHOM4",886,0)
 ;
"RTN","SAMIHOM4",887,0)
 ;@stanza 3 process homepage template
"RTN","SAMIHOM4",888,0)
 ;
"RTN","SAMIHOM4",889,0)
 n err
"RTN","SAMIHOM4",890,0)
 do MERGEHTM^%wf(.temp,.SAMIFILTER,.err)
"RTN","SAMIHOM4",891,0)
 ;
"RTN","SAMIHOM4",892,0)
 ;
"RTN","SAMIHOM4",893,0)
 do ADDCRLF^VPRJRUT(.temp)
"RTN","SAMIHOM4",894,0)
 merge SAMIRTN=temp
"RTN","SAMIHOM4",895,0)
 ;
"RTN","SAMIHOM4",896,0)
 quit  ; below is redacted
"RTN","SAMIHOM4",897,0)
 ;
"RTN","SAMIHOM4",898,0)
 ; 
"RTN","SAMIHOM4",899,0)
 new cnt set cnt=0
"RTN","SAMIHOM4",900,0)
 new zi set zi=0
"RTN","SAMIHOM4",901,0)
 for  set zi=$order(temp(zi)) quit:+zi=0  do  ;
"RTN","SAMIHOM4",902,0)
 . ;
"RTN","SAMIHOM4",903,0)
 . n ln s ln=temp(zi)
"RTN","SAMIHOM4",904,0)
 . n touched s touched=0
"RTN","SAMIHOM4",905,0)
 . ;
"RTN","SAMIHOM4",906,0)
 . i ln["href" i 'touched d  ;
"RTN","SAMIHOM4",907,0)
 . . d FIXHREF^SAMIFORM(.ln)
"RTN","SAMIHOM4",908,0)
 . . s temp(zi)=ln
"RTN","SAMIHOM4",909,0)
 . ;
"RTN","SAMIHOM4",910,0)
 . i ln["src" d  ;
"RTN","SAMIHOM4",911,0)
 . . d FIXSRC^SAMIFORM(.ln)
"RTN","SAMIHOM4",912,0)
 . . s temp(zi)=ln
"RTN","SAMIHOM4",913,0)
 . ;
"RTN","SAMIHOM4",914,0)
 . i ln["id" i ln["studyIdMenu" d  ;
"RTN","SAMIHOM4",915,0)
 . . s zi=zi+4
"RTN","SAMIHOM4",916,0)
 . ;
"RTN","SAMIHOM4",917,0)
 . if ln["@@MANUALREGISTRATION@@" do  ; turn off manual registration
"RTN","SAMIHOM4",918,0)
 . . n setman,setparm
"RTN","SAMIHOM4",919,0)
 . . s setman="true"
"RTN","SAMIHOM4",920,0)
 . . s setparm=$$GET^XPAR("SYS","SAMI ALLOW MANUAL ENTRY",,"Q")
"RTN","SAMIHOM4",921,0)
 . . i setparm=0 s setman="false"
"RTN","SAMIHOM4",922,0)
 . . do findReplace^%ts(.ln,"@@MANUALREGISTRATION@@",setman)
"RTN","SAMIHOM4",923,0)
 . . s temp(zi)=ln
"RTN","SAMIHOM4",924,0)
 . . quit 
"RTN","SAMIHOM4",925,0)
 . set cnt=cnt+1
"RTN","SAMIHOM4",926,0)
 . set tout(cnt)=temp(zi)
"RTN","SAMIHOM4",927,0)
 . quit
"RTN","SAMIHOM4",928,0)
 ;
"RTN","SAMIHOM4",929,0)
 ;@stanza 4 add cr/lf & save to return array
"RTN","SAMIHOM4",930,0)
 ;
"RTN","SAMIHOM4",931,0)
 do ADDCRLF^VPRJRUT(.tout)
"RTN","SAMIHOM4",932,0)
 merge SAMIRTN=tout
"RTN","SAMIHOM4",933,0)
 ;
"RTN","SAMIHOM4",934,0)
 ;@stanza 5 termination
"RTN","SAMIHOM4",935,0)
 ;
"RTN","SAMIHOM4",936,0)
 quit  ; end of wsi GETHOME^SAMIHOM3
"RTN","SAMIHOM4",937,0)
 ;
"RTN","SAMIHOM4",938,0)
 ;
"RTN","SAMIHOM4",939,0)
 ;
"RTN","SAMIHOM4",940,0)
 ;@wsi-code WSNEWCAS^SAMIHOM3
"RTN","SAMIHOM4",941,0)
WSNEWCAS ; receives post from home & creates new case
"RTN","SAMIHOM4",942,0)
 ;
"RTN","SAMIHOM4",943,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM4",944,0)
 ;
"RTN","SAMIHOM4",945,0)
 ;ven/gpl;private;procedure;
"RTN","SAMIHOM4",946,0)
 ;@signature
"RTN","SAMIHOM4",947,0)
 ; do WSNEWCAS^SAMIHOM3(SAMIARGS,SAMIBODY,SAMIRESULT)
"RTN","SAMIHOM4",948,0)
 ;@branches-from
"RTN","SAMIHOM4",949,0)
 ; WSNEWCAS^SAMIHOM3
"RTN","SAMIHOM4",950,0)
 ;@called-by
"RTN","SAMIHOM4",951,0)
 ;@calls
"RTN","SAMIHOM4",952,0)
 ; parseBody^%wf
"RTN","SAMIHOM4",953,0)
 ; $$setroot^%wd
"RTN","SAMIHOM4",954,0)
 ; $$NEXTNUM
"RTN","SAMIHOM4",955,0)
 ; $$GENSTDID^SAMIHOM3
"RTN","SAMIHOM4",956,0)
 ; $$NOW^XLFDT
"RTN","SAMIHOM4",957,0)
 ; $$KEYDATE^SAMIHOM3
"RTN","SAMIHOM4",958,0)
 ; $$VALDTNM
"RTN","SAMIHOM4",959,0)
 ; GETHOME
"RTN","SAMIHOM4",960,0)
 ; PREFILL
"RTN","SAMIHOM4",961,0)
 ; MKSBFORM
"RTN","SAMIHOM4",962,0)
 ; MKSIFORM^SAMIHOM3
"RTN","SAMIHOM4",963,0)
 ; WSCASE^SAMICASE
"RTN","SAMIHOM4",964,0)
 ;@input
"RTN","SAMIHOM4",965,0)
 ;.ARGS =
"RTN","SAMIHOM4",966,0)
 ; BODY =
"RTN","SAMIHOM4",967,0)
 ;.RESULT =
"RTN","SAMIHOM4",968,0)
 ;@output: ?
"RTN","SAMIHOM4",969,0)
 ;@examples [tbd]
"RTN","SAMIHOM4",970,0)
 ;@tests [tbd]
"RTN","SAMIHOM4",971,0)
 ;
"RTN","SAMIHOM4",972,0)
 ;@stanza 2 ?
"RTN","SAMIHOM4",973,0)
 ;
"RTN","SAMIHOM4",974,0)
 merge ^SAMIUL("newCase","ARGS")=SAMIARGS
"RTN","SAMIHOM4",975,0)
 merge ^SAMIUL("newCase","BODY")=SAMIBODY
"RTN","SAMIHOM4",976,0)
 ;
"RTN","SAMIHOM4",977,0)
 new vars,bdy
"RTN","SAMIHOM4",978,0)
 set SAMIBDY=$get(SAMIBODY(1))
"RTN","SAMIHOM4",979,0)
 do parseBody^%wf("vars",.SAMIBDY)
"RTN","SAMIHOM4",980,0)
 merge ^SAMIUL("newCase","vars")=vars
"RTN","SAMIHOM4",981,0)
 ;
"RTN","SAMIHOM4",982,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",983,0)
 ;
"RTN","SAMIHOM4",984,0)
 new saminame set saminame=$get(vars("name"))
"RTN","SAMIHOM4",985,0)
 if saminame="" s saminame=$get(vars("saminame"))
"RTN","SAMIHOM4",986,0)
 ;if $$VALDTNM(saminame,.ARGS)=-1 do  quit  ;
"RTN","SAMIHOM4",987,0)
 ;. new r1
"RTN","SAMIHOM4",988,0)
 ;. do GETHOME(.r1,.ARGS) ; home page to redisplay
"RTN","SAMIHOM4",989,0)
 ;. merge RESULT=r1
"RTN","SAMIHOM4",990,0)
 ;. quit
"RTN","SAMIHOM4",991,0)
 ;
"RTN","SAMIHOM4",992,0)
 new dfn s dfn=$get(vars("dfn"))
"RTN","SAMIHOM4",993,0)
 ;if dfn="" do  quit  ;
"RTN","SAMIHOM4",994,0)
 ;. new r1
"RTN","SAMIHOM4",995,0)
 ;. do GETHOME(.r1,.ARGS) ; home page to redisplay
"RTN","SAMIHOM4",996,0)
 ;. merge RESULT=r1
"RTN","SAMIHOM4",997,0)
 ;. quit
"RTN","SAMIHOM4",998,0)
 ;
"RTN","SAMIHOM4",999,0)
 ;new gien set gien=$$NEXTNUM
"RTN","SAMIHOM4",1000,0)
 new gien set gien=dfn
"RTN","SAMIHOM4",1001,0)
 ;
"RTN","SAMIHOM4",1002,0)
 m ^SAMIUL("newCase","G1")=root
"RTN","SAMIHOM4",1003,0)
 ; create dfn index
"RTN","SAMIHOM4",1004,0)
 set @root@("dfn",dfn,gien)=""
"RTN","SAMIHOM4",1005,0)
 ;
"RTN","SAMIHOM4",1006,0)
 set @root@(gien,"saminum")=gien
"RTN","SAMIHOM4",1007,0)
 set @root@(gien,"saminame")=saminame
"RTN","SAMIHOM4",1008,0)
 ;
"RTN","SAMIHOM4",1009,0)
 new studyid set studyid=$$GENSTDID^SAMIHOM3(gien,.SAMIARGS)
"RTN","SAMIHOM4",1010,0)
 set @root@(gien,"samistudyid")=studyid
"RTN","SAMIHOM4",1011,0)
 set @root@("sid",studyid,gien)=""
"RTN","SAMIHOM4",1012,0)
 ;
"RTN","SAMIHOM4",1013,0)
 new datekey set datekey=$$KEYDATE^SAMIHOM3($$NOW^XLFDT)
"RTN","SAMIHOM4",1014,0)
 set @root@(gien,"samicreatedate")=datekey
"RTN","SAMIHOM4",1015,0)
 ;
"RTN","SAMIHOM4",1016,0)
 merge ^SAMIUL("newCase",gien)=@root@(gien)
"RTN","SAMIHOM4",1017,0)
 ;
"RTN","SAMIHOM4",1018,0)
 ;
"RTN","SAMIHOM4",1019,0)
 do PREFILL^SAMIHOM3(dfn) ; prefills from the "patient-lookup" graph
"RTN","SAMIHOM4",1020,0)
 ;
"RTN","SAMIHOM4",1021,0)
 n siformkey
"RTN","SAMIHOM4",1022,0)
 ;do makeSbform(gien) ; create a background form for new patient
"RTN","SAMIHOM4",1023,0)
 set siformkey=$$MKSIFORM^SAMIHOM3(gien) ; create an intake for for new patient
"RTN","SAMIHOM4",1024,0)
 ;
"RTN","SAMIHOM4",1025,0)
 set SAMIARGS("studyid")=studyid
"RTN","SAMIHOM4",1026,0)
 set SAMIARGS("form")="vapals:"_siformkey
"RTN","SAMIHOM4",1027,0)
 do wsGetForm^%wf(.SAMIRESULT,.SAMIARGS)
"RTN","SAMIHOM4",1028,0)
 ;do WSCASE^SAMICASE(.SAMIRESULT,.SAMIARGS) ; navigate to the case review page
"RTN","SAMIHOM4",1029,0)
 ;
"RTN","SAMIHOM4",1030,0)
 ;@stanza ? termination
"RTN","SAMIHOM4",1031,0)
 ;
"RTN","SAMIHOM4",1032,0)
 quit  ; end of wsi WSNEWCAS^SAMIHOM3
"RTN","SAMIHOM4",1033,0)
 ;
"RTN","SAMIHOM4",1034,0)
 ;
"RTN","SAMIHOM4",1035,0)
 ;
"RTN","SAMIHOM4",1036,0)
EOR ; End of routine SAMIHOM4
"RTN","SAMIJS1")
0^3^B19204155
"RTN","SAMIJS1",1,0)
SAMIJS1 ;ven/gpl - json archive routine ;May 05, 2021@17:12
"RTN","SAMIJS1",2,0)
 ;;18.0;SAMI;;;Build 1
"RTN","SAMIJS1",3,0)
 ;
"RTN","SAMIJS1",4,0)
 ;@license: see routine SAMIUL
"RTN","SAMIJS1",5,0)
 ;
"RTN","SAMIJS1",6,0)
 ;
"RTN","SAMIJS1",7,0)
EN 
"RTN","SAMIJS1",8,0)
 n site,dfn,pat
"RTN","SAMIJS1",9,0)
 s site=$$PICSITE^SAMIMOV()
"RTN","SAMIJS1",10,0)
 q:site="^"
"RTN","SAMIJS1",11,0)
 d PICPAT^SAMIMOV(.pat,site)
"RTN","SAMIJS1",12,0)
 w "   ",$g(pat("name"))
"RTN","SAMIJS1",13,0)
 s dfn=$g(pat("dfn"))
"RTN","SAMIJS1",14,0)
 w !,"dfn=",dfn
"RTN","SAMIJS1",15,0)
 d mkarch(dfn)
"RTN","SAMIJS1",16,0)
 d outarch(dfn)
"RTN","SAMIJS1",17,0)
 q
"RTN","SAMIJS1",18,0)
 ;
"RTN","SAMIJS1",19,0)
EXSITE 
"RTN","SAMIJS1",20,0)
 n site,dfn,pat
"RTN","SAMIJS1",21,0)
 s site=$$PICSITE^SAMIMOV()
"RTN","SAMIJS1",22,0)
 q:site="^"
"RTN","SAMIJS1",23,0)
 n lroot,proot,aroot
"RTN","SAMIJS1",24,0)
 s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIJS1",25,0)
 s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMIJS1",26,0)
 s aroot=$$setroot^%wd("vapals-archive")
"RTN","SAMIJS1",27,0)
 n dfn,lien s dfn=""
"RTN","SAMIJS1",28,0)
 f  s dfn=$o(@lroot@("dfn",dfn)) q:+dfn=0  d  ;
"RTN","SAMIJS1",29,0)
 . s lien=$o(@lroot@("dfn",dfn,""))
"RTN","SAMIJS1",30,0)
 . i $g(@lroot@(lien,"siteid"))'=site q  ;
"RTN","SAMIJS1",31,0)
 . d mkarch(dfn)
"RTN","SAMIJS1",32,0)
 . d outarch(dfn)
"RTN","SAMIJS1",33,0)
 q
"RTN","SAMIJS1",34,0)
 ;
"RTN","SAMIJS1",35,0)
dfn2lien(dfn) ; extrinsic return the lookup ien of patient dfn
"RTN","SAMIJS1",36,0)
 n lroot,lien
"RTN","SAMIJS1",37,0)
 s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIJS1",38,0)
 s lien=$o(@lroot@("dfn",dfn,""))
"RTN","SAMIJS1",39,0)
 q lien
"RTN","SAMIJS1",40,0)
 ;
"RTN","SAMIJS1",41,0)
dfn2pien(dfn) ; extrinsic return the patient graph ien of patient dfn
"RTN","SAMIJS1",42,0)
 n proot,pien
"RTN","SAMIJS1",43,0)
 s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMIJS1",44,0)
 s pien=$o(@proot@("dfn",dfn,""))
"RTN","SAMIJS1",45,0)
 q pien
"RTN","SAMIJS1",46,0)
 ;
"RTN","SAMIJS1",47,0)
getaien(dfn) ; returns the ien for patient dfn in vapals-archive
"RTN","SAMIJS1",48,0)
 ; is laygo
"RTN","SAMIJS1",49,0)
 n aroot s aroot=$$setroot^%wd("vapals-archive")
"RTN","SAMIJS1",50,0)
 n aien
"RTN","SAMIJS1",51,0)
 s aien=$o(@aroot@(" "),-1)+1
"RTN","SAMIJS1",52,0)
 q aien
"RTN","SAMIJS1",53,0)
 ;
"RTN","SAMIJS1",54,0)
mkarch(dfn) ; create an archive record for patient dfn
"RTN","SAMIJS1",55,0)
 n lroot,proot,aroot
"RTN","SAMIJS1",56,0)
 n lien,pien,aien
"RTN","SAMIJS1",57,0)
 s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIJS1",58,0)
 w !,"patient-lookup: ",lroot
"RTN","SAMIJS1",59,0)
 s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMIJS1",60,0)
 w !,"vapals-patients: ",proot
"RTN","SAMIJS1",61,0)
 s aroot=$$setroot^%wd("vapals-archive")
"RTN","SAMIJS1",62,0)
 w !,"vapals-archive: ",aroot
"RTN","SAMIJS1",63,0)
 ;
"RTN","SAMIJS1",64,0)
 s lien=$$dfn2lien(dfn)
"RTN","SAMIJS1",65,0)
 w !,"lien=",lien
"RTN","SAMIJS1",66,0)
 s pien=$$dfn2pien(dfn)
"RTN","SAMIJS1",67,0)
 w !,"pien=",pien
"RTN","SAMIJS1",68,0)
 ;
"RTN","SAMIJS1",69,0)
 i lien="" d  q  ;
"RTN","SAMIJS1",70,0)
 . w !,"error, lookup ien not found for patient dfn=",dfn
"RTN","SAMIJS1",71,0)
 ;
"RTN","SAMIJS1",72,0)
 s aien=$o(@aroot@("dfn",dfn,""))
"RTN","SAMIJS1",73,0)
 i aien'="" d  ;
"RTN","SAMIJS1",74,0)
 . k @aroot@(aien)
"RTN","SAMIJS1",75,0)
 i aien="" s aien=$$getaien(dfn)
"RTN","SAMIJS1",76,0)
 w !,"aien=",aien
"RTN","SAMIJS1",77,0)
 ;
"RTN","SAMIJS1",78,0)
 m @aroot@(aien,"patient","lookup")=@lroot@(lien)
"RTN","SAMIJS1",79,0)
 s @aroot@("dfn",dfn,aien)=""
"RTN","SAMIJS1",80,0)
 ;
"RTN","SAMIJS1",81,0)
 n sid s sid=""
"RTN","SAMIJS1",82,0)
 d:pien'=""
"RTN","SAMIJS1",83,0)
 . m @aroot@(aien,"patient","demos")=@proot@(pien)
"RTN","SAMIJS1",84,0)
 . s sid=$g(@proot@(pien,"samistudyid"))
"RTN","SAMIJS1",85,0)
 . i sid="" s sid=$g(@proot@(pien,"sisid"))
"RTN","SAMIJS1",86,0)
 . q:sid=""
"RTN","SAMIJS1",87,0)
 . m @aroot@(aien,"patient","graph")=@proot@("graph",sid)
"RTN","SAMIJS1",88,0)
 ;
"RTN","SAMIJS1",89,0)
 q
"RTN","SAMIJS1",90,0)
 ;
"RTN","SAMIJS1",91,0)
outarch(dfn) ; write out an archive record to an external file
"RTN","SAMIJS1",92,0)
 n aroot s aroot=$$setroot^%wd("vapals-archive")
"RTN","SAMIJS1",93,0)
 n aien s aien=$o(@aroot@("dfn",dfn,""),-1)
"RTN","SAMIJS1",94,0)
 q:aien=""
"RTN","SAMIJS1",95,0)
 ;
"RTN","SAMIJS1",96,0)
 n sid s sid=$g(@aroot@(aien,"patient","demos","samistudyid"))
"RTN","SAMIJS1",97,0)
 n tmpout s tmpout=$na(^TMP("VAPALS-ARCH",$J))
"RTN","SAMIJS1",98,0)
 k @tmpout
"RTN","SAMIJS1",99,0)
 n arec s arec=$na(@aroot@(aien))
"RTN","SAMIJS1",100,0)
 d encode^%webjson(arec,tmpout)
"RTN","SAMIJS1",101,0)
 ;
"RTN","SAMIJS1",102,0)
 n adir,fname
"RTN","SAMIJS1",103,0)
 s adir="/home/osehra/www/archive"
"RTN","SAMIJS1",104,0)
 s fname="vapals-"_sid_"-"_dfn_"-"_DT_".json"
"RTN","SAMIJS1",105,0)
 i $$GTF^%ZISH($NA(@tmpout@(1)),3,adir,fname) d  ;
"RTN","SAMIJS1",106,0)
 . w !,"file "_fname_" written to "_adir
"RTN","SAMIJS1",107,0)
 ;
"RTN","SAMIJS1",108,0)
 q
"RTN","SAMIJS1",109,0)
 ;
"RTN","SAMIJS1",110,0)
DETAIL() ; displays the archive record for a patient
"RTN","SAMIJS1",111,0)
 ;
"RTN","SAMIJS1",112,0)
 n site,dfn,pat
"RTN","SAMIJS1",113,0)
 s site=$$PICSITE^SAMIMOV()
"RTN","SAMIJS1",114,0)
 q:site="^"
"RTN","SAMIJS1",115,0)
 d PICPAT^SAMIMOV(.pat,site)
"RTN","SAMIJS1",116,0)
 w "   ",$g(pat("name"))
"RTN","SAMIJS1",117,0)
 s dfn=$g(pat("dfn"))
"RTN","SAMIJS1",118,0)
 w !,"dfn=",dfn
"RTN","SAMIJS1",119,0)
 q:dfn=""
"RTN","SAMIJS1",120,0)
 n aroot ; archive root
"RTN","SAMIJS1",121,0)
 s aroot=$$setroot^%wd("vapals-archive")
"RTN","SAMIJS1",122,0)
 d mkarch(dfn)
"RTN","SAMIJS1",123,0)
 n aien
"RTN","SAMIJS1",124,0)
 s aien=$o(@aroot@("dfn",dfn,""))
"RTN","SAMIJS1",125,0)
 i aien="" d  q  ;
"RTN","SAMIJS1",126,0)
 . w !,"patient not found in archive"
"RTN","SAMIJS1",127,0)
 n groot
"RTN","SAMIJS1",128,0)
 s groot=$na(@aroot@(aien))
"RTN","SAMIJS1",129,0)
 n OUT s OUT=$na(^TMP("SAMIOUT",$J))
"RTN","SAMIJS1",130,0)
 k @OUT
"RTN","SAMIJS1",131,0)
 D GTREE^SYNVPR(groot,9,,,OUT)
"RTN","SAMIJS1",132,0)
 D BROWSE^DDBR(OUT,"N","Patient")
"RTN","SAMIJS1",133,0)
 k @OUT
"RTN","SAMIJS1",134,0)
 q
"RTN","SAMIJS1",135,0)
 ;    
"RTN","SAMIJS2")
0^4^B35653444
"RTN","SAMIJS2",1,0)
SAMIJS2 ;ven/gpl - json archive routine ; 1/22/19 1:24pm
"RTN","SAMIJS2",2,0)
 ;;18.0;SAMI;;;Build 1
"RTN","SAMIJS2",3,0)
 ;
"RTN","SAMIJS2",4,0)
 ;@license: see routine SAMIUL
"RTN","SAMIJS2",5,0)
 ;
"RTN","SAMIJS2",6,0)
 ;
"RTN","SAMIJS2",7,0)
 q
"RTN","SAMIJS2",8,0)
 ;
"RTN","SAMIJS2",9,0)
FILE(directory) ; [Public] Load files from the file system; OPT: SAMI LOAD FILES
"RTN","SAMIJS2",10,0)
 ;
"RTN","SAMIJS2",11,0)
 if '$data(directory) do
"RTN","SAMIJS2",12,0)
 . N DIR,X,Y,DA,DIRUT,DTOUT,DUOUT,DIROUT
"RTN","SAMIJS2",13,0)
 . S DIR(0)="F^0:1024"
"RTN","SAMIJS2",14,0)
 . S DIR("A")="Enter directory from which to load Patients"
"RTN","SAMIJS2",15,0)
 . D ^DIR
"RTN","SAMIJS2",16,0)
 . W !
"RTN","SAMIJS2",17,0)
 . if '$data(DIRUT) set directory=Y
"RTN","SAMIJS2",18,0)
 quit:'$data(directory)
"RTN","SAMIJS2",19,0)
 ;
"RTN","SAMIJS2",20,0)
 ; Load files from directory
"RTN","SAMIJS2",21,0)
 new samifiles
"RTN","SAMIJS2",22,0)
 new samimask set samimask("*.json")=""
"RTN","SAMIJS2",23,0)
 new % set %=$$LIST^%ZISH(directory,$na(samimask),$na(samifiles))
"RTN","SAMIJS2",24,0)
 if '% write "Failed to read any files. Check directory.",! quit
"RTN","SAMIJS2",25,0)
 ;
"RTN","SAMIJS2",26,0)
 new file set file=""
"RTN","SAMIJS2",27,0)
 for  set file=$order(samifiles(file)) q:file=""  do
"RTN","SAMIJS2",28,0)
 . if file["Information" quit  ; We don't process information files yet...
"RTN","SAMIJS2",29,0)
 . ;
"RTN","SAMIJS2",30,0)
 . write "Loading ",file,"...",!
"RTN","SAMIJS2",31,0)
 . if $$loaded(file) d  q  ;
"RTN","SAMIJS2",32,0)
 .. w "already loaded, skipping "_file,!
"RTN","SAMIJS2",33,0)
 . ;
"RTN","SAMIJS2",34,0)
 . kill ^TMP("SAMIFILE",$J)
"RTN","SAMIJS2",35,0)
 . new % set %=$$FTG^%ZISH(directory,file,$name(^TMP("SAMIFILE",$J,1)),3)
"RTN","SAMIJS2",36,0)
 . i '% write "Failed to read the file. Please debug me.",! quit
"RTN","SAMIJS2",37,0)
 . ;
"RTN","SAMIJS2",38,0)
 . ; Normalize overflow nodes (and hope for the best that we don't go over 32k)
"RTN","SAMIJS2",39,0)
 . new i,j set (i,j)=""
"RTN","SAMIJS2",40,0)
 . for  set i=$order(^TMP("SAMIFILE",$J,i)) quit:'i  for  set j=$order(^TMP("SAMIFILE",$J,i,"OVF",j)) quit:'j  do
"RTN","SAMIJS2",41,0)
 .. set ^TMP("SAMIFILE",$J,i)=^TMP("SAMIFILE",$J,i)_^TMP("SAMIFILE",$J,i,"OVF",j)  ; ** NOT TESTED **
"RTN","SAMIJS2",42,0)
 . ;
"RTN","SAMIJS2",43,0)
 . ; Now load the file into Vapals
"RTN","SAMIJS2",44,0)
 . write "Ingesting ",file,"...",!
"RTN","SAMIJS2",45,0)
 . ;
"RTN","SAMIJS2",46,0)
 . do
"RTN","SAMIJS2",47,0)
 .. new samifiles,file,directory
"RTN","SAMIJS2",48,0)
 .. do KILL^XUSCLEAN ; VistA leaks like hell
"RTN","SAMIJS2",49,0)
 . ;
"RTN","SAMIJS2",50,0)
 . new root set root=$$setroot^%wd("vapals-intake")
"RTN","SAMIJS2",51,0)
 . new ien set ien=$order(@root@(" "),-1)+1
"RTN","SAMIJS2",52,0)
 . new gr set gr=$name(@root@(ien,"json"))
"RTN","SAMIJS2",53,0)
 . do decode^%webjson($na(^TMP("SAMIFILE",$J)),gr)
"RTN","SAMIJS2",54,0)
 . set @root@("file",file,ien)=""
"RTN","SAMIJS2",55,0)
 . new args,samijsonreturn
"RTN","SAMIJS2",56,0)
 . new % set %=$$wsPostSAMI(.args,,.samijsonreturn,ien) ; ignore % which always comes out at 1
"RTN","SAMIJS2",57,0)
 . ;
"RTN","SAMIJS2",58,0)
 . ; Get the status back from JSON
"RTN","SAMIJS2",59,0)
 . new samireturn,samijsonerror
"RTN","SAMIJS2",60,0)
 . do decode^%webjson($na(samijsonreturn),$na(samireturn),$na(samijsonerror))
"RTN","SAMIJS2",61,0)
 . if $data(samijsonerror) write "There is an error decoding the return. Debug me." quit
"RTN","SAMIJS2",62,0)
 . ;
"RTN","SAMIJS2",63,0)
 . q:'$d(samireturn)
"RTN","SAMIJS2",64,0)
 . if $get(samireturn("loadMessage"))["Duplicate" write "Patient Already Loaded",! quit
"RTN","SAMIJS2",65,0)
 . n errmsg s errmsg=$get(samireturn("loadMessage"))
"RTN","SAMIJS2",66,0)
 . if errmsg["Error" d  q  ;
"RTN","SAMIJS2",67,0)
 . . write errmsg,!
"RTN","SAMIJS2",68,0)
 . write " ",errmsg,!
"RTN","SAMIJS2",69,0)
 . ;
"RTN","SAMIJS2",70,0)
 . write " Loaded with following data: ",!
"RTN","SAMIJS2",71,0)
 . write "DFN: ",$g(samireturn("dfn")),?15,"STUDYID: ",$g(samireturn("sid")),?25," LIEN: ",$g(samireturn("ien")),?50,"Name: ",$g(samireturn("name")),!
"RTN","SAMIJS2",72,0)
 . write "--------------------------------------------------------------------------",!
"RTN","SAMIJS2",73,0)
 . ;b
"RTN","SAMIJS2",74,0)
 q
"RTN","SAMIJS2",75,0)
 ;
"RTN","SAMIJS2",76,0)
wsPostSAMI(args,body,return,ien) ; accept incoming SAMI record in VAPALS
"RTN","SAMIJS2",77,0)
 ;
"RTN","SAMIJS2",78,0)
 n rtn
"RTN","SAMIJS2",79,0)
 n lroot,proot,iroot
"RTN","SAMIJS2",80,0)
 s iroot=$$setroot^%wd("vapals-intake")
"RTN","SAMIJS2",81,0)
 s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMIJS2",82,0)
 s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIJS2",83,0)
 n lien,pien,grloaded,dfn,sid
"RTN","SAMIJS2",84,0)
 s (lien,pien,grloaded)=0
"RTN","SAMIJS2",85,0)
 i '$d(@iroot@(ien,"json","patient","lookup")) d  q  ;
"RTN","SAMIJS2",86,0)
 . s rtn("loadMessage")="Error, patient lookup missing"
"RTN","SAMIJS2",87,0)
 . d encode^%webjson("rtn","return","zerr")
"RTN","SAMIJS2",88,0)
 ; so, what is the dfn.. it is the number for this patient on this system
"RTN","SAMIJS2",89,0)
 ;s dfn=$g(@iroot@(ien,"json","patient","lookup","dfn"))
"RTN","SAMIJS2",90,0)
 ;i dfn="" d  q  ;
"RTN","SAMIJS2",91,0)
 ;. s rtn("loadMessage")="Error, dfn missing"
"RTN","SAMIJS2",92,0)
 ;. d encode^%webjson("rtn","return","zerr")
"RTN","SAMIJS2",93,0)
 ;n newdfn s newdfn=0
"RTN","SAMIJS2",94,0)
 ;i $d(@lroot@("dfn",dfn)) d  ; oops need a new dfn for this system
"RTN","SAMIJS2",95,0)
 ;. s dfn=$o(@lroot@("dfn"," "),-1)+1
"RTN","SAMIJS2",96,0)
 ;. s newdfn=1 ; remember to propogate the new dfn
"RTN","SAMIJS2",97,0)
 s dfn=$o(@lroot@("dfn"," "),-1)+1
"RTN","SAMIJS2",98,0)
 i $o(@proot@("dfn"," "),-1)+1>dfn s dfn=$o(@proot@("dfn"," "),-1)+1
"RTN","SAMIJS2",99,0)
 s rtn("dfn")=dfn
"RTN","SAMIJS2",100,0)
 i '$d(@lroot@(dfn)) s lien=dfn
"RTN","SAMIJS2",101,0)
 e  s lien=$o(@lroot@(" "),-1)+1
"RTN","SAMIJS2",102,0)
 s rtn("ien")=lien
"RTN","SAMIJS2",103,0)
 ;i newdfn=1 s @lroot@(lien,"dfn")=dfn
"RTN","SAMIJS2",104,0)
 n name s name=$g(@iroot@(ien,"json","patient","lookup","saminame"))
"RTN","SAMIJS2",105,0)
 i name="" d  q  ;
"RTN","SAMIJS2",106,0)
 . s rtn("loadMessage")="Error, name missing"
"RTN","SAMIJS2",107,0)
 . d encode^%webjson("rtn","return","zerr")
"RTN","SAMIJS2",108,0)
 s rtn("name")=name
"RTN","SAMIJS2",109,0)
 m @lroot@(lien)=@iroot@(ien,"json","patient","lookup")
"RTN","SAMIJS2",110,0)
 s @lroot@(lien,"dfn")=dfn
"RTN","SAMIJS2",111,0)
 d INDXPTLK^SAMIHOM4(lien)
"RTN","SAMIJS2",112,0)
 ;
"RTN","SAMIJS2",113,0)
 ; detect if enrolled
"RTN","SAMIJS2",114,0)
 ;
"RTN","SAMIJS2",115,0)
 i '$d(@iroot@(ien,"json","patient","demos")) d  q  ;
"RTN","SAMIJS2",116,0)
 . s rtn("loadMessage")="Load sucessful, not enrolled"
"RTN","SAMIJS2",117,0)
 . d encode^%webjson("rtn","return","zerr")
"RTN","SAMIJS2",118,0)
 ; 
"RTN","SAMIJS2",119,0)
 ; determine pien in vapals-patients
"RTN","SAMIJS2",120,0)
 ;
"RTN","SAMIJS2",121,0)
 ;i '$d(@proot@(dfn)) s pien=dfn
"RTN","SAMIJS2",122,0)
 ;e  s pien=$$NEXTNUM^SAMIHOM3()
"RTN","SAMIJS2",123,0)
 s pien=$$NEXTNUM^SAMIHOM3()
"RTN","SAMIJS2",124,0)
 m @proot@(pien)=@iroot@(ien,"json","patient","demos")
"RTN","SAMIJS2",125,0)
 s @proot@("dfn",dfn,pien)=""
"RTN","SAMIJS2",126,0)
 ;i newdfn s @proot@(pien,"dfn")=dfn
"RTN","SAMIJS2",127,0)
 s @proot@(pien,"dfn")=dfn
"RTN","SAMIJS2",128,0)
 ;
"RTN","SAMIJS2",129,0)
 ; determine studyid (sid)
"RTN","SAMIJS2",130,0)
 ;
"RTN","SAMIJS2",131,0)
 n sid s sid=$g(@proot@(pien,"samistudyid"))
"RTN","SAMIJS2",132,0)
 i sid="" d  q  ;
"RTN","SAMIJS2",133,0)
 . s rtn("loadMessage")="Error, studyid missing"
"RTN","SAMIJS2",134,0)
 . d encode^%webjson("rtn","return","zerr")
"RTN","SAMIJS2",135,0)
 i $d(@proot@("sid",sid)) d  q  ; opps we need a new sid for this system
"RTN","SAMIJS2",136,0)
 . s rtn("loadMessage")="Error, studyid is not unique"
"RTN","SAMIJS2",137,0)
 . d encode^%webjson("rtn","return","zerr")
"RTN","SAMIJS2",138,0)
 s rtn("sid")=sid
"RTN","SAMIJS2",139,0)
 s @proot@("sid",sid,pien)=""
"RTN","SAMIJS2",140,0)
 ;
"RTN","SAMIJS2",141,0)
 ; merge in all the forms
"RTN","SAMIJS2",142,0)
 ;
"RTN","SAMIJS2",143,0)
 m @proot@("graph",sid)=@iroot@(ien,"json","patient","graph")
"RTN","SAMIJS2",144,0)
 ;
"RTN","SAMIJS2",145,0)
 ; encode the successful return
"RTN","SAMIJS2",146,0)
 ;
"RTN","SAMIJS2",147,0)
 s rtn("loadMessage")="Load successful, enrolled"
"RTN","SAMIJS2",148,0)
 d encode^%webjson("rtn","return","zerr")
"RTN","SAMIJS2",149,0)
 q
"RTN","SAMIJS2",150,0)
 ;
"RTN","SAMIJS2",151,0)
loaded(filenm,graph) ;extrinsic returns 1 if the filename is already loaded
"RTN","SAMIJS2",152,0)
 ; in the graph default for graph is vapals-intake
"RTN","SAMIJS2",153,0)
 if $g(graph)="" s graph="vapals-intake"
"RTN","SAMIJS2",154,0)
 n tmproot s tmproot=$$setroot^%wd(graph)
"RTN","SAMIJS2",155,0)
 i $d(@tmproot@("file",filenm)) q 1
"RTN","SAMIJS2",156,0)
 q 0
"RTN","SAMIJS2",157,0)
 ;
"RTN","SAMIUR")
0^5^B560761257
"RTN","SAMIUR",1,0)
SAMIUR ;ven/gpl - user reports ;2021-05-25T19:11Z
"RTN","SAMIUR",2,0)
 ;;18.0;SAMI;**5,10,11**;2020-01;Build 1
"RTN","SAMIUR",3,0)
 ;;1.18.0.11+i11
"RTN","SAMIUR",4,0)
 ;
"RTN","SAMIUR",5,0)
 ; SAMIUR contains a web service & associated subroutines to produce
"RTN","SAMIUR",6,0)
 ; VAPALS-ELCAP user reports.
"RTN","SAMIUR",7,0)
 ;
"RTN","SAMIUR",8,0)
 quit  ; no entry from top
"RTN","SAMIUR",9,0)
 ;
"RTN","SAMIUR",10,0)
 ;
"RTN","SAMIUR",11,0)
 ;
"RTN","SAMIUR",12,0)
 ;@section 0 primary development
"RTN","SAMIUR",13,0)
 ;
"RTN","SAMIUR",14,0)
 ;
"RTN","SAMIUR",15,0)
 ;
"RTN","SAMIUR",16,0)
 ;@routine-credits
"RTN","SAMIUR",17,0)
 ;@primary-dev George P. Lilly (gpl)
"RTN","SAMIUR",18,0)
 ; gpl@vistaexpertise.net
"RTN","SAMIUR",19,0)
 ;@primary-dev-org Vista Expertise Network (ven)
"RTN","SAMIUR",20,0)
 ; http://vistaexpertise.net
"RTN","SAMIUR",21,0)
 ;@copyright 2017/2021, gpl, all rights reserved
"RTN","SAMIUR",22,0)
 ;@license see routine SAMIUL
"RTN","SAMIUR",23,0)
 ;
"RTN","SAMIUR",24,0)
 ;@last-updated 2021-05-25T19:11Z
"RTN","SAMIUR",25,0)
 ;@application Screening Applications Management (SAM)
"RTN","SAMIUR",26,0)
 ;@module Screening Applications Management - IELCAP (SAMI)
"RTN","SAMIUR",27,0)
 ;@suite-of-files SAMI Forms (311.101-311.199)
"RTN","SAMIUR",28,0)
 ;@version 1.18.0.11+i11
"RTN","SAMIUR",29,0)
 ;@release-date 2020-01
"RTN","SAMIUR",30,0)
 ;@patch-list **5,10,11**
"RTN","SAMIUR",31,0)
 ;
"RTN","SAMIUR",32,0)
 ;@additional-dev Frederick D. S. Marshall (toad)
"RTN","SAMIUR",33,0)
 ; toad@vistaexpertise.net
"RTN","SAMIUR",34,0)
 ;@additional-dev Larry G. Carlson (lgc)
"RTN","SAMIUR",35,0)
 ; larry.g.carlson@gmail.com
"RTN","SAMIUR",36,0)
 ;@additional-dev Alexis R. Carlson (arc)
"RTN","SAMIUR",37,0)
 ; whatisthehumanspirit@gmail.com
"RTN","SAMIUR",38,0)
 ;@additional-dev Kenneth McGlothlen (mcglk)
"RTN","SAMIUR",39,0)
 ; mcglk@vistaexpertise.net
"RTN","SAMIUR",40,0)
 ;
"RTN","SAMIUR",41,0)
 ;@module-credits
"RTN","SAMIUR",42,0)
 ;@project VA Partnership to Increase Access to Lung Screening
"RTN","SAMIUR",43,0)
 ; (VA-PALS)
"RTN","SAMIUR",44,0)
 ; http://va-pals.org/
"RTN","SAMIUR",45,0)
 ;@funding 2017/2021, Bristol-Myers Squibb Foundation (bmsf)
"RTN","SAMIUR",46,0)
 ; https://www.bms.com/about-us/responsibility/bristol-myers-squibb-foundation.html
"RTN","SAMIUR",47,0)
 ;@partner-org Veterans Affairs Office of Rural health
"RTN","SAMIUR",48,0)
 ; https://www.ruralhealth.va.gov/
"RTN","SAMIUR",49,0)
 ;@partner-org International Early Lung Cancer Action Program (I-ELCAP)
"RTN","SAMIUR",50,0)
 ; http://ielcap.com/
"RTN","SAMIUR",51,0)
 ;@partner-org Paraxial Technologies (par)
"RTN","SAMIUR",52,0)
 ; http://paraxialtech.com/
"RTN","SAMIUR",53,0)
 ;@partner-org Open Source Electronic Health Record Alliance (OSEHRA)
"RTN","SAMIUR",54,0)
 ; https://www.osehra.org/groups/va-pals-open-source-project-group
"RTN","SAMIUR",55,0)
 ;
"RTN","SAMIUR",56,0)
 ;@module-log repo github.com:VA-PALS-ELCAP/SAMI-VAPALS-ELCAP.git
"RTN","SAMIUR",57,0)
 ;
"RTN","SAMIUR",58,0)
 ; 2020-02-10/12 ven/gpl 1.18.0-t04 d543f7bb,f9869dfb,0e4d8b9a
"RTN","SAMIUR",59,0)
 ;  SAMIUR: 1st version of revised user reports, progress on user
"RTN","SAMIUR",60,0)
 ; reports, fixed a bug in enrollment report.
"RTN","SAMIUR",61,0)
 ;
"RTN","SAMIUR",62,0)
 ; 2020-02-18 ven/lgc 1.18.0-t04 76874314
"RTN","SAMIUR",63,0)
 ;  SAMIUR: update recently edited routines.
"RTN","SAMIUR",64,0)
 ;
"RTN","SAMIUR",65,0)
 ; 2020-03-10/12 ven/gpl 1.18.0-t04 8de06b06,4ad52d64
"RTN","SAMIUR",66,0)
 ;  SAMIUR: user report date filtering, fix end date logic in UR.
"RTN","SAMIUR",67,0)
 ;
"RTN","SAMIUR",68,0)
 ; 2020-04-16/23 ven/lgc 1.18.0-t04 e54b76d1b,89bffd3b
"RTN","SAMIUR",69,0)
 ;  SAMIUR: SAMIFRM2 > SAMIFORM, SAMISUB2 > LOAD.
"RTN","SAMIUR",70,0)
 ;
"RTN","SAMIUR",71,0)
 ; 2020-08-04 ven/gpl 1.18.0-t04 cd865e2b VPA-438
"RTN","SAMIUR",72,0)
 ;  SAMIUR: requested changes to followup report.
"RTN","SAMIUR",73,0)
 ;
"RTN","SAMIUR",74,0)
 ; 2020-09-26 ven/gpl 1.18.0-t04 92b12324 VAP-420
"RTN","SAMIUR",75,0)
 ;  SAMIUR: add smoking history.
"RTN","SAMIUR",76,0)
 ;
"RTN","SAMIUR",77,0)
 ; 2020-01-01/05 ven/arc 1.18.0 399f8547,62e3200f
"RTN","SAMIUR",78,0)
 ;  SAMIUR: unmatched participant processing.
"RTN","SAMIUR",79,0)
 ;
"RTN","SAMIUR",80,0)
 ; 2020-04-29/05-13 ven/gpl 1.18.0.5+i5 e8b8ea2d,61c7d208
"RTN","SAMIUR",81,0)
 ;  SAMIUR: fixes for reports, worklist functionality.
"RTN","SAMIUR",82,0)
 ;
"RTN","SAMIUR",83,0)
 ; 2021-03-22/23 ven/gpl 1.18.0.10+i10 256efe63,ba81b86a2
"RTN","SAMIUR",84,0)
 ;  SAMIUR: sort all reports by name, added row totals to reports.
"RTN","SAMIUR",85,0)
 ;
"RTN","SAMIUR",86,0)
 ; 2021-03-23 ven/toad 1.18.0.10+i10 96f461d0,af86e0eb
"RTN","SAMIUR",87,0)
 ;  SAMIUR: add version info & dev log, lt refactor, fix XINDEX
"RTN","SAMIUR",88,0)
 ; errors.
"RTN","SAMIUR",89,0)
 ;
"RTN","SAMIUR",90,0)
 ; 2021-03-29 ven/gpl 1.18.0.11+i11 e809f2a2
"RTN","SAMIUR",91,0)
 ;  SAMIUR: prevent crash when reports have no matches: in WSREPORT
"RTN","SAMIUR",92,0)
 ; set SRT="" and uncomment zwrite SRT; in WKLIST add 2 commented-out
"RTN","SAMIUR",93,0)
 ; debugging lines.
"RTN","SAMIUR",94,0)
 ;
"RTN","SAMIUR",95,0)
 ; 2021-03-30 ven/toad 1.18.0.11+i11 7b14bb2
"RTN","SAMIUR",96,0)
 ;  SAMIUR: bump version, date, log; in WSREPORT comment zwrite SRT.
"RTN","SAMIUR",97,0)
 ;
"RTN","SAMIUR",98,0)
 ; 2021-03-31 ven/gpl 1.18.0.11+i11 66d89cd
"RTN","SAMIUR",99,0)
 ;  SAMIUR: sort on all uppercase names for reports
"RTN","SAMIUR",100,0)
 ;
"RTN","SAMIUR",101,0)
 ; 2021-04-13 ven/gpl 1.18.0.11+i11 a12765b
"RTN","SAMIUR",102,0)
 ;  SAMIUR: inactive report created.
"RTN","SAMIUR",103,0)
 ;
"RTN","SAMIUR",104,0)
 ; 2021-05-20/25 ven/mcglk&toad 1.18.0.11+i11
"RTN","SAMIUR",105,0)
 ;  SAMIUR: annotate, lt refactor, bump version.
"RTN","SAMIUR",106,0)
 ;
"RTN","SAMIUR",107,0)
 ;@contents
"RTN","SAMIUR",108,0)
 ; WSREPORT generate report based on params in filter
"RTN","SAMIUR",109,0)
 ; SORT sort patients by name
"RTN","SAMIUR",110,0)
 ; NUHREF create nuhref link to casereview for all patients
"RTN","SAMIUR",111,0)
 ; PNAME page name for report
"RTN","SAMIUR",112,0)
 ;
"RTN","SAMIUR",113,0)
 ; SELECT select patients for report
"RTN","SAMIUR",114,0)
 ; UNMAT build unmatched persons list
"RTN","SAMIUR",115,0)
 ; WKLIST build work list
"RTN","SAMIUR",116,0)
 ;
"RTN","SAMIUR",117,0)
 ;
"RTN","SAMIUR",118,0)
 ;
"RTN","SAMIUR",119,0)
 ;@section 1 wsreport subroutines
"RTN","SAMIUR",120,0)
 ;
"RTN","SAMIUR",121,0)
 ;
"RTN","SAMIUR",122,0)
 ;
"RTN","SAMIUR",123,0)
WSREPORT(SAMIRTN,filter) ; generate report based on params in filter
"RTN","SAMIUR",124,0)
 ;
"RTN","SAMIUR",125,0)
 ;@called-by
"RTN","SAMIUR",126,0)
 ; WSVAPALS^SAMIHOM4
"RTN","SAMIUR",127,0)
 ; WSREPORT^SAMIUR1
"RTN","SAMIUR",128,0)
 ;@calls
"RTN","SAMIUR",129,0)
 ; GETHOME^SAMIHOM3
"RTN","SAMIUR",130,0)
 ; getThis^%wd
"RTN","SAMIUR",131,0)
 ; SELECT
"RTN","SAMIUR",132,0)
 ; LOAD^SAMIFORM
"RTN","SAMIUR",133,0)
 ; $$PNAME
"RTN","SAMIUR",134,0)
 ; findReplace^%ts
"RTN","SAMIUR",135,0)
 ; RPTTBL^SAMIUR2
"RTN","SAMIUR",136,0)
 ; NUHREF
"RTN","SAMIUR",137,0)
 ; SORT
"RTN","SAMIUR",138,0)
 ; @RPT(ir,"routine"): [from report def table from RPTTBL^SAMIUR2]
"RTN","SAMIUR",139,0)
 ;  format = $$<tag>^SAMIUR2, where tag =
"RTN","SAMIUR",140,0)
 ;  AGE       BLINEDT   CONTACT   CTPROT   DOB      FUDATE    GENDER
"RTN","SAMIUR",141,0)
 ;  IFORM     LASTEXM   MANPAT    MATCH    NAME     PACKYRS   POSSIBLE
"RTN","SAMIUR",142,0)
 ;  RECOM     RURAL     SID       SMHIS    SMKSTAT  SSN       STUDYDT
"RTN","SAMIUR",143,0)
 ;  STUDYTYP  VALS      WHEN      WORKPAT
"RTN","SAMIUR",144,0)
 ;
"RTN","SAMIUR",145,0)
 ; here are the user reports that are defined:
"RTN","SAMIUR",146,0)
 ;  1. followup
"RTN","SAMIUR",147,0)
 ;  2. activity
"RTN","SAMIUR",148,0)
 ;  3. missingct
"RTN","SAMIUR",149,0)
 ;  4. incomplete
"RTN","SAMIUR",150,0)
 ;  5. outreach
"RTN","SAMIUR",151,0)
 ;  6. enrollment
"RTN","SAMIUR",152,0)
 ;  7. worklist
"RTN","SAMIUR",153,0)
 ; the report to generate is passed in parameter samireporttype
"RTN","SAMIUR",154,0)
 ;
"RTN","SAMIUR",155,0)
 new debug set debug=0
"RTN","SAMIUR",156,0)
 if $get(filter("debug"))=1 set debug=1
"RTN","SAMIUR",157,0)
 if $get(filter("debug"))=1 set debug=1
"RTN","SAMIUR",158,0)
 kill SAMIRTN
"RTN","SAMIUR",159,0)
 set HTTPRSP("mime")="text/html"
"RTN","SAMIUR",160,0)
 ;
"RTN","SAMIUR",161,0)
 new type,temp,site
"RTN","SAMIUR",162,0)
 s site=$g(filter("siteid"))
"RTN","SAMIUR",163,0)
 i site="" s site=$g(filter("site"))
"RTN","SAMIUR",164,0)
 i site="" d  q  ; report site missing
"RTN","SAMIUR",165,0)
 . d GETHOME^SAMIHOM3(.SAMIRTN,.filter) ; send them to home
"RTN","SAMIUR",166,0)
 ;
"RTN","SAMIUR",167,0)
 set type=$get(filter("samireporttype"))
"RTN","SAMIUR",168,0)
 if type="" do  quit  ; report type missing
"RTN","SAMIUR",169,0)
 . do GETHOME^SAMIHOM3(.SAMIRTN,.filter) ; send them to home
"RTN","SAMIUR",170,0)
 . quit
"RTN","SAMIUR",171,0)
 ;
"RTN","SAMIUR",172,0)
 if type="unmatched" i $$GET1PARM^SAMIPARM("matchingReportEnabled",site)'="true" do  quit  ;
"RTN","SAMIUR",173,0)
 . d GETHOME^SAMIHOM3(.SAMIRTN,.filter) ; send them to home
"RTN","SAMIUR",174,0)
 ;
"RTN","SAMIUR",175,0)
 do getThis^%wd("temp","table.html") ; page template
"RTN","SAMIUR",176,0)
 quit:'$data(temp)
"RTN","SAMIUR",177,0)
 ;
"RTN","SAMIUR",178,0)
 new SAMIPATS
"RTN","SAMIUR",179,0)
 ; set pats=""
"RTN","SAMIUR",180,0)
 new datephrase
"RTN","SAMIUR",181,0)
 do SELECT(.SAMIPATS,type,.datephrase,.filter) ; select pats for report
"RTN","SAMIUR",182,0)
 ; quit:'$data(SAMIPATS)
"RTN","SAMIUR",183,0)
 ;
"RTN","SAMIUR",184,0)
 new ln,cnt,ii
"RTN","SAMIUR",185,0)
 set (ii,ln,cnt)=0
"RTN","SAMIUR",186,0)
 for  do  quit:'ii  quit:$get(temp(ii))["<thead"
"RTN","SAMIUR",187,0)
 . set ii=$order(temp(ii))
"RTN","SAMIUR",188,0)
 . quit:'ii
"RTN","SAMIUR",189,0)
 . quit:$get(temp(ii))["<thead"
"RTN","SAMIUR",190,0)
 . ;
"RTN","SAMIUR",191,0)
 . set cnt=cnt+1
"RTN","SAMIUR",192,0)
 . set ln=$get(temp(ii))
"RTN","SAMIUR",193,0)
 . new samikey,si
"RTN","SAMIUR",194,0)
 . set (samikey,si)=""
"RTN","SAMIUR",195,0)
 . do LOAD^SAMIFORM(.ln,samikey,si,.filter)
"RTN","SAMIUR",196,0)
 . ; if ln["PAGE NAME" do
"RTN","SAMIUR",197,0)
 . ; . do findReplace^%ts(.ln,"PAGE NAME",$$PNAME(type,datephrase))
"RTN","SAMIUR",198,0)
 . ; . quit
"RTN","SAMIUR",199,0)
 . if ln["PAGE NAME" do
"RTN","SAMIUR",200,0)
 . . do findReplace^%ts(.ln,"PAGE NAME",$$PNAME(type,""))
"RTN","SAMIUR",201,0)
 . . quit
"RTN","SAMIUR",202,0)
 . if ln["CRITERIA" do
"RTN","SAMIUR",203,0)
 . . do findReplace^%ts(.ln,"CRITERIA",datephrase)
"RTN","SAMIUR",204,0)
 . . quit
"RTN","SAMIUR",205,0)
 . if ln["@@REPORTTYPE@@" do
"RTN","SAMIUR",206,0)
 . . do findReplace^%ts(.ln,"@@REPORTTYPE@@",type)
"RTN","SAMIUR",207,0)
 . . quit
"RTN","SAMIUR",208,0)
 . ;
"RTN","SAMIUR",209,0)
 . if ln["name=""start-date""" do
"RTN","SAMIUR",210,0)
 . . do findReplace^%ts(.ln,"start-date""","start-date"" value="""_$g(filter("start-date"))_"""")
"RTN","SAMIUR",211,0)
 . . quit
"RTN","SAMIUR",212,0)
 . if ln["name=""end-date""" do
"RTN","SAMIUR",213,0)
 . . do findReplace^%ts(.ln,"end-date""","end-date"" value="""_$g(filter("end-date"))_"""")
"RTN","SAMIUR",214,0)
 . . quit
"RTN","SAMIUR",215,0)
 . ;
"RTN","SAMIUR",216,0)
 . set SAMIRTN(cnt)=ln
"RTN","SAMIUR",217,0)
 . quit
"RTN","SAMIUR",218,0)
 ;
"RTN","SAMIUR",219,0)
 new RPT,ik
"RTN","SAMIUR",220,0)
 do RPTTBL^SAMIUR2(.RPT,type,site) ; load report definition table
"RTN","SAMIUR",221,0)
 if '$data(RPT) do  quit  ; don't know about this report
"RTN","SAMIUR",222,0)
 . do GETHOME^SAMIHOM3(.SAMIRTN,.filter) ; send them to home
"RTN","SAMIUR",223,0)
 . quit
"RTN","SAMIUR",224,0)
 ;
"RTN","SAMIUR",225,0)
 ; output header
"RTN","SAMIUR",226,0)
 ;
"RTN","SAMIUR",227,0)
 set cnt=cnt+1 set SAMIRTN(cnt)="<thead><tr>"
"RTN","SAMIUR",228,0)
 set cnt=cnt+1
"RTN","SAMIUR",229,0)
 new totcnt set totcnt=cnt
"RTN","SAMIUR",230,0)
 ;
"RTN","SAMIUR",231,0)
 set ir=""
"RTN","SAMIUR",232,0)
 for  do  quit:ir=""  ;
"RTN","SAMIUR",233,0)
 . set ir=$order(RPT(ir))
"RTN","SAMIUR",234,0)
 . quit:ir=""
"RTN","SAMIUR",235,0)
 . set cnt=cnt+1
"RTN","SAMIUR",236,0)
 . set SAMIRTN(cnt)="<th>"_$get(RPT(ir,"header"))_"</th>"
"RTN","SAMIUR",237,0)
 . quit
"RTN","SAMIUR",238,0)
 ;
"RTN","SAMIUR",239,0)
 set cnt=cnt+1 set SAMIRTN(cnt)="</tr></thead>"
"RTN","SAMIUR",240,0)
 ;
"RTN","SAMIUR",241,0)
 set cnt=cnt+1 set SAMIRTN(cnt)="<tbody>"
"RTN","SAMIUR",242,0)
 ;
"RTN","SAMIUR",243,0)
 if type'="worklist" do  ;
"RTN","SAMIUR",244,0)
 . do NUHREF(.SAMIPATS) ; create the nuhref link for all patients
"RTN","SAMIUR",245,0)
 . quit
"RTN","SAMIUR",246,0)
 ;
"RTN","SAMIUR",247,0)
 new SRT set SRT=""
"RTN","SAMIUR",248,0)
 if $get(filter("sort"))="" set filter("sort")="name"
"RTN","SAMIUR",249,0)
 do SORT(.SRT,.SAMIPATS,.filter)
"RTN","SAMIUR",250,0)
 ; zwrite SRT
"RTN","SAMIUR",251,0)
 ;
"RTN","SAMIUR",252,0)
 ; set ij=0
"RTN","SAMIUR",253,0)
 ; for  do  quit:'ij  ;
"RTN","SAMIUR",254,0)
 ; . set ij=$order(SAMIPATS(ij))
"RTN","SAMIUR",255,0)
 ; . quit:'ij  
"RTN","SAMIUR",256,0)
 ; . new ij2 set ij2=0
"RTN","SAMIUR",257,0)
 ; . for  do  quit:'ij2  ;
"RTN","SAMIUR",258,0)
 ; . . set ij2=$order(SAMIPATS(ij,ij2))
"RTN","SAMIUR",259,0)
 ; . . quit:'ij2  
"RTN","SAMIUR",260,0)
 ; . . new dfn set dfn=ij2
"RTN","SAMIUR",261,0)
 ; . . quit
"RTN","SAMIUR",262,0)
 ; . quit
"RTN","SAMIUR",263,0)
 ;
"RTN","SAMIUR",264,0)
 new iz,ij,ij2,dfn,rows
"RTN","SAMIUR",265,0)
 set rows=0
"RTN","SAMIUR",266,0)
 set (iz,ij,ij2,dfn)=""
"RTN","SAMIUR",267,0)
 for  do  quit:iz=""  ;
"RTN","SAMIUR",268,0)
 . set iz=$order(SRT(iz))
"RTN","SAMIUR",269,0)
 . quit:iz=""
"RTN","SAMIUR",270,0)
 . set ij=$order(SRT(iz,""))
"RTN","SAMIUR",271,0)
 . set dfn=$order(SRT(iz,ij,""))
"RTN","SAMIUR",272,0)
 . do  ;
"RTN","SAMIUR",273,0)
 . . set cnt=cnt+1 set SAMIRTN(cnt)="<tr>"
"RTN","SAMIUR",274,0)
 . . set ir=""
"RTN","SAMIUR",275,0)
 . . for  do  quit:ir=""  ;
"RTN","SAMIUR",276,0)
 . . . set ir=$order(RPT(ir))
"RTN","SAMIUR",277,0)
 . . . quit:ir=""
"RTN","SAMIUR",278,0)
 . . . set cnt=cnt+1
"RTN","SAMIUR",279,0)
 . . . new XR,XRV
"RTN","SAMIUR",280,0)
 . . . ; set XR=$get(RPT(ir,"routine"))_"("_ij_",.SAMIPATS)"
"RTN","SAMIUR",281,0)
 . . . set XR="set XRV="_$get(RPT(ir,"routine"))_"("_ij_","_dfn_",.SAMIPATS)"
"RTN","SAMIUR",282,0)
 . . . ; set XRV=@XR
"RTN","SAMIUR",283,0)
 . . . xecute XR ; call report-field handlers in ^SAMIUR2
"RTN","SAMIUR",284,0)
 . . . set SAMIRTN(cnt)="<td>"_$get(XRV)_"</td>"
"RTN","SAMIUR",285,0)
 . . . quit
"RTN","SAMIUR",286,0)
 . . ;
"RTN","SAMIUR",287,0)
 . . set cnt=cnt+1
"RTN","SAMIUR",288,0)
 . . set SAMIRTN(cnt)="</tr>"
"RTN","SAMIUR",289,0)
 . . set rows=rows+1
"RTN","SAMIUR",290,0)
 . . quit
"RTN","SAMIUR",291,0)
 . quit
"RTN","SAMIUR",292,0)
 ;
"RTN","SAMIUR",293,0)
 set cnt=cnt+1
"RTN","SAMIUR",294,0)
 set SAMIRTN(cnt)="<tr><td>Total: "_rows_"</td></tr>"
"RTN","SAMIUR",295,0)
 set SAMIRTN(totcnt)="<td>Total: "_rows_"</td></tr><tr>"
"RTN","SAMIUR",296,0)
 ;
"RTN","SAMIUR",297,0)
 set cnt=cnt+1 set SAMIRTN(cnt)="</tbody>"
"RTN","SAMIUR",298,0)
 for  do  quit:temp(ii)["</tbody>"  ;
"RTN","SAMIUR",299,0)
 . set ii=$order(temp(ii))
"RTN","SAMIUR",300,0)
 . quit:temp(ii)["</tbody>"
"RTN","SAMIUR",301,0)
 . ; skip past template headers & blank body
"RTN","SAMIUR",302,0)
 . quit
"RTN","SAMIUR",303,0)
 ;
"RTN","SAMIUR",304,0)
 for  do  quit:'ii  ;
"RTN","SAMIUR",305,0)
 . set ii=$order(temp(ii))
"RTN","SAMIUR",306,0)
 . quit:'ii
"RTN","SAMIUR",307,0)
 . set cnt=cnt+1
"RTN","SAMIUR",308,0)
 . set ln=$get(temp(ii))
"RTN","SAMIUR",309,0)
 . new samikey,si
"RTN","SAMIUR",310,0)
 . set (samikey,si)=""
"RTN","SAMIUR",311,0)
 . do LOAD^SAMIFORM(.ln,samikey,si,.filter)
"RTN","SAMIUR",312,0)
 . set SAMIRTN(cnt)=ln
"RTN","SAMIUR",313,0)
 . quit
"RTN","SAMIUR",314,0)
 ;
"RTN","SAMIUR",315,0)
 quit  ; end of WSREPORT
"RTN","SAMIUR",316,0)
 ;
"RTN","SAMIUR",317,0)
 ;
"RTN","SAMIUR",318,0)
 ;
"RTN","SAMIUR",319,0)
SORT(SRTN,SAMIPATS,FILTER) ; sort patients by name
"RTN","SAMIUR",320,0)
 ;
"RTN","SAMIUR",321,0)
 ;@called-by
"RTN","SAMIUR",322,0)
 ; WSREPORT
"RTN","SAMIUR",323,0)
 ;@calls
"RTN","SAMIUR",324,0)
 ; $$UPCASE^XLFMSMT
"RTN","SAMIUR",325,0)
 ;
"RTN","SAMIUR",326,0)
 new typ set typ=$get(FILTER("sort"))
"RTN","SAMIUR",327,0)
 if typ="" set typ="name"
"RTN","SAMIUR",328,0)
 new iz,dt,dfn,nm
"RTN","SAMIUR",329,0)
 set (dt,dfn,nm)="" ; note: should dfn be initialized inside loop?
"RTN","SAMIUR",330,0)
 set iz=0
"RTN","SAMIUR",331,0)
 ;
"RTN","SAMIUR",332,0)
 new indx
"RTN","SAMIUR",333,0)
 for  do  quit:'dt  ;
"RTN","SAMIUR",334,0)
 . set dt=$order(SAMIPATS(dt))
"RTN","SAMIUR",335,0)
 . quit:'dt
"RTN","SAMIUR",336,0)
 . ; note: dfn not re-initialized to "" here; should it be?
"RTN","SAMIUR",337,0)
 . for  do  quit:'dfn  ;
"RTN","SAMIUR",338,0)
 . . set dfn=$order(SAMIPATS(dt,dfn))
"RTN","SAMIUR",339,0)
 . . quit:'dfn
"RTN","SAMIUR",340,0)
 . . if typ="name" do  ;
"RTN","SAMIUR",341,0)
 . . . set nm=$get(SAMIPATS(dt,dfn,"name"))
"RTN","SAMIUR",342,0)
 . . . set nm=$$UPCASE^XLFMSMT(nm)
"RTN","SAMIUR",343,0)
 . . . if nm="" set nm=" "
"RTN","SAMIUR",344,0)
 . . . set indx(nm,dt,dfn)=""
"RTN","SAMIUR",345,0)
 . . . quit
"RTN","SAMIUR",346,0)
 . . quit
"RTN","SAMIUR",347,0)
 . quit
"RTN","SAMIUR",348,0)
 ;
"RTN","SAMIUR",349,0)
 new iiz set iiz=""
"RTN","SAMIUR",350,0)
 set (dt,dfn)="" ; note: here, too, should inits be inside loops?
"RTN","SAMIUR",351,0)
 for  do  quit:iiz=""  ;
"RTN","SAMIUR",352,0)
 . set iiz=$order(indx(iiz))
"RTN","SAMIUR",353,0)
 . quit:iiz=""
"RTN","SAMIUR",354,0)
 . for  do  quit:dt=""  ;
"RTN","SAMIUR",355,0)
 . . set dt=$order(indx(iiz,dt))
"RTN","SAMIUR",356,0)
 . . quit:dt=""
"RTN","SAMIUR",357,0)
 . . for  do  quit:dfn=""  ;
"RTN","SAMIUR",358,0)
 . . . set dfn=$order(indx(iiz,dt,dfn))
"RTN","SAMIUR",359,0)
 . . . quit:dfn=""
"RTN","SAMIUR",360,0)
 . . . set iz=iz+1
"RTN","SAMIUR",361,0)
 . . . set SRTN(iz,dt,dfn)=iiz
"RTN","SAMIUR",362,0)
 . . . quit
"RTN","SAMIUR",363,0)
 . . quit
"RTN","SAMIUR",364,0)
 . quit
"RTN","SAMIUR",365,0)
 ;
"RTN","SAMIUR",366,0)
 quit  ; end of SORT
"RTN","SAMIUR",367,0)
 ;
"RTN","SAMIUR",368,0)
 ;
"RTN","SAMIUR",369,0)
 ;
"RTN","SAMIUR",370,0)
NUHREF(SAMIPATS) ; create nuhref link to casereview for all patients
"RTN","SAMIUR",371,0)
 ;
"RTN","SAMIUR",372,0)
 ;@called-by
"RTN","SAMIUR",373,0)
 ; WSREPORT
"RTN","SAMIUR",374,0)
 ;@calls
"RTN","SAMIUR",375,0)
 ; $$setroot^%wd
"RTN","SAMIUR",376,0)
 ; $$GETSSN^SAMIFORM
"RTN","SAMIUR",377,0)
 ;
"RTN","SAMIUR",378,0)
 new ij
"RTN","SAMIUR",379,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIUR",380,0)
 set ij=0
"RTN","SAMIUR",381,0)
 for  do  quit:'ij  ;
"RTN","SAMIUR",382,0)
 . set ij=$order(SAMIPATS(ij))
"RTN","SAMIUR",383,0)
 . quit:'ij
"RTN","SAMIUR",384,0)
 . new ij2 set ij2=0
"RTN","SAMIUR",385,0)
 . for  do  quit:'ij2  ;
"RTN","SAMIUR",386,0)
 . . set ij2=$order(SAMIPATS(ij,ij2))
"RTN","SAMIUR",387,0)
 . . quit:'ij2
"RTN","SAMIUR",388,0)
 . . ;
"RTN","SAMIUR",389,0)
 . . new dfn set dfn=ij2
"RTN","SAMIUR",390,0)
 . . set SAMIPATS(ij,dfn,"sid")=$get(@root@(dfn,"samistudyid"))
"RTN","SAMIUR",391,0)
 . . set SAMIPATS(ij,dfn,"name")=$get(@root@(dfn,"saminame"))
"RTN","SAMIUR",392,0)
 . . ;
"RTN","SAMIUR",393,0)
 . . new sid set sid=SAMIPATS(ij,dfn,"sid")
"RTN","SAMIUR",394,0)
 . . set SAMIPATS(ij,dfn,"ssn")=$$GETSSN^SAMIFORM(sid)
"RTN","SAMIUR",395,0)
 . . new name set name=SAMIPATS(ij,dfn,"name")
"RTN","SAMIUR",396,0)
 . . ;
"RTN","SAMIUR",397,0)
 . . new nuhref set nuhref="<form method=POST action=""/vapals"">"
"RTN","SAMIUR",398,0)
 . . set nuhref=nuhref_"<input type=hidden name=""samiroute"" value=""casereview"">"
"RTN","SAMIUR",399,0)
 . . set nuhref=nuhref_"<input type=hidden name=""studyid"" value="_sid_">"
"RTN","SAMIUR",400,0)
 . . set nuhref=nuhref_"<input value="""_name_""" class=""btn btn-link"" role=""link"" type=""submit""></form>"
"RTN","SAMIUR",401,0)
 . . set SAMIPATS(ij,dfn,"nuhref")=nuhref
"RTN","SAMIUR",402,0)
 . . quit
"RTN","SAMIUR",403,0)
 . quit
"RTN","SAMIUR",404,0)
 ;
"RTN","SAMIUR",405,0)
 quit  ; end of NUHREF
"RTN","SAMIUR",406,0)
 ;
"RTN","SAMIUR",407,0)
 ;
"RTN","SAMIUR",408,0)
 ;
"RTN","SAMIUR",409,0)
PNAME(type,phrase) ; page name for report
"RTN","SAMIUR",410,0)
 ;
"RTN","SAMIUR",411,0)
 ;@called-by
"RTN","SAMIUR",412,0)
 ; WSREPORT
"RTN","SAMIUR",413,0)
 ;@calls none
"RTN","SAMIUR",414,0)
 ;
"RTN","SAMIUR",415,0)
 ; extrinsic returns the PAGE NAME for the report
"RTN","SAMIUR",416,0)
 ;
"RTN","SAMIUR",417,0)
 ; if type="followup" quit "Followup next 30 days -"_$get(phrase)
"RTN","SAMIUR",418,0)
 if type="followup" quit "Followup "_$get(phrase)
"RTN","SAMIUR",419,0)
 ; if type="activity" quit "Activity last 30 days -"_$get(phrase)
"RTN","SAMIUR",420,0)
 if type="activity" quit "Activity "_$get(phrase)
"RTN","SAMIUR",421,0)
 if type="missingct" quit "Intake but no CT Evaluation"_$get(phrase)
"RTN","SAMIUR",422,0)
 if type="incomplete" quit "Incomplete Forms"_$get(phrase)
"RTN","SAMIUR",423,0)
 if type="outreach" quit "Outreach"_$get(phrase)
"RTN","SAMIUR",424,0)
 if type="enrollment" quit "Enrollment"_$get(phrase)
"RTN","SAMIUR",425,0)
 if type="inactive" quit "Inactive"_$get(phrase)
"RTN","SAMIUR",426,0)
 ;
"RTN","SAMIUR",427,0)
 quit "" ; end of $$PNAME
"RTN","SAMIUR",428,0)
 ;
"RTN","SAMIUR",429,0)
 ;
"RTN","SAMIUR",430,0)
 ;
"RTN","SAMIUR",431,0)
 ;@section 2 select subroutines
"RTN","SAMIUR",432,0)
 ;
"RTN","SAMIUR",433,0)
 ;
"RTN","SAMIUR",434,0)
 ;
"RTN","SAMIUR",435,0)
SELECT(SAMIPATS,ztype,datephrase,filter) ; select patients for report
"RTN","SAMIUR",436,0)
 ;
"RTN","SAMIUR",437,0)
 ;@called-by
"RTN","SAMIUR",438,0)
 ; WSREPORT
"RTN","SAMIUR",439,0)
 ;@calls
"RTN","SAMIUR",440,0)
 ; UNMAT
"RTN","SAMIUR",441,0)
 ; WKLIST
"RTN","SAMIUR",442,0)
 ; $$KEY2FM^SAMICASE
"RTN","SAMIUR",443,0)
 ; $$NOW^XLFDT
"RTN","SAMIUR",444,0)
 ; $$FMADD^XLFDT
"RTN","SAMIUR",445,0)
 ; $$VAPALSDT^SAMICASE
"RTN","SAMIUR",446,0)
 ; $$setroot^%wd
"RTN","SAMIUR",447,0)
 ; GETITEMS^SAMICASE
"RTN","SAMIUR",448,0)
 ;
"RTN","SAMIUR",449,0)
 ; merge ^gpl("select")=filter
"RTN","SAMIUR",450,0)
 new type set type=ztype
"RTN","SAMIUR",451,0)
 if type="unmatched" do  quit  ;
"RTN","SAMIUR",452,0)
 . do UNMAT(.SAMIPATS,ztype,.datephrase,.filter)
"RTN","SAMIUR",453,0)
 . quit
"RTN","SAMIUR",454,0)
 if type="worklist" do  quit  ;
"RTN","SAMIUR",455,0)
 . do WKLIST(.SAMIPATS,ztype,.datephrase,.filter)
"RTN","SAMIUR",456,0)
 . quit
"RTN","SAMIUR",457,0)
 if $get(type)="" set type="enrollment"
"RTN","SAMIUR",458,0)
 if type="cumpy" set type="enrollment"
"RTN","SAMIUR",459,0)
 new site set site=$get(filter("siteid"))
"RTN","SAMIUR",460,0)
 ;
"RTN","SAMIUR",461,0)
 new strdt,enddt,fmstrdt,fmenddt
"RTN","SAMIUR",462,0)
 set strdt=$get(filter("start-date"))
"RTN","SAMIUR",463,0)
 set fmstrdt=$$KEY2FM^SAMICASE(strdt)
"RTN","SAMIUR",464,0)
 if fmstrdt=-1 do  ;
"RTN","SAMIUR",465,0)
 . set fmstrdt=2000101
"RTN","SAMIUR",466,0)
 . if type="followup" set fmstrdt=$$NOW^XLFDT
"RTN","SAMIUR",467,0)
 . if type="activity" set fmstrdt=$$FMADD^XLFDT($$NOW^XLFDT,-31)
"RTN","SAMIUR",468,0)
 . quit
"RTN","SAMIUR",469,0)
 if strdt="" set filter("start-date")=$$VAPALSDT^SAMICASE(fmstrdt)
"RTN","SAMIUR",470,0)
 ;
"RTN","SAMIUR",471,0)
 set enddt=$get(filter("end-date"))
"RTN","SAMIUR",472,0)
 set fmenddt=$$KEY2FM^SAMICASE(enddt)
"RTN","SAMIUR",473,0)
 if fmenddt=-1 do  ;
"RTN","SAMIUR",474,0)
 . set fmenddt=$$NOW^XLFDT
"RTN","SAMIUR",475,0)
 . if type="followup" set fmenddt=$$FMADD^XLFDT($$NOW^XLFDT,31)
"RTN","SAMIUR",476,0)
 . quit
"RTN","SAMIUR",477,0)
 if enddt="" set filter("end-date")=$$VAPALSDT^SAMICASE(fmenddt)
"RTN","SAMIUR",478,0)
 ;
"RTN","SAMIUR",479,0)
 set datephrase=""
"RTN","SAMIUR",480,0)
 new zi set zi=0
"RTN","SAMIUR",481,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIUR",482,0)
 ;
"RTN","SAMIUR",483,0)
 for  do  quit:'zi  ;
"RTN","SAMIUR",484,0)
 . set zi=$order(@root@(zi))
"RTN","SAMIUR",485,0)
 . quit:'zi
"RTN","SAMIUR",486,0)
 . ;
"RTN","SAMIUR",487,0)
 . new sid set sid=$get(@root@(zi,"samistudyid"))
"RTN","SAMIUR",488,0)
 . quit:sid=""
"RTN","SAMIUR",489,0)
 . quit:$extract(sid,1,3)'=site
"RTN","SAMIUR",490,0)
 . ;
"RTN","SAMIUR",491,0)
 . new items set items=""
"RTN","SAMIUR",492,0)
 . do GETITEMS^SAMICASE("items",sid)
"RTN","SAMIUR",493,0)
 . quit:'$data(items)
"RTN","SAMIUR",494,0)
 . ;
"RTN","SAMIUR",495,0)
 . new efmdate,edate,siform,ceform,cefud,fmcefud,cedos,fmcedos
"RTN","SAMIUR",496,0)
 . set siform=$order(items("siform-"))
"RTN","SAMIUR",497,0)
 . new inactive set inactive=$get(@root@("graph",sid,siform,"sistatus"))
"RTN","SAMIUR",498,0)
 . if type="inactive",inactive'="inactive" quit  ; for inactive report
"RTN","SAMIUR",499,0)
 . if type'="inactive",inactive="inactive" quit  ; for other reports
"RTN","SAMIUR",500,0)
 . ;
"RTN","SAMIUR",501,0)
 . set ceform=$order(items("ceform-a"),-1)
"RTN","SAMIUR",502,0)
 . set (cefud,fmcefud,cedos,fmcedos)=""
"RTN","SAMIUR",503,0)
 . if ceform'="" do  ;
"RTN","SAMIUR",504,0)
 . . set cefud=$get(@root@("graph",sid,ceform,"cefud"))
"RTN","SAMIUR",505,0)
 . . if cefud'="" set fmcefud=$$KEY2FM^SAMICASE(cefud)
"RTN","SAMIUR",506,0)
 . . set cedos=$get(@root@("graph",sid,ceform,"cedos"))
"RTN","SAMIUR",507,0)
 . . if cedos'="" set fmcedos=$$KEY2FM^SAMICASE(cedos)
"RTN","SAMIUR",508,0)
 . . quit
"RTN","SAMIUR",509,0)
 . ;
"RTN","SAMIUR",510,0)
 . set edate=$get(@root@("graph",sid,siform,"sidc"))
"RTN","SAMIUR",511,0)
 . if edate="" set edate=$get(@root@("graph",sid,siform,"samicreatedate"))
"RTN","SAMIUR",512,0)
 . set efmdate=$$KEY2FM^SAMICASE(edate)
"RTN","SAMIUR",513,0)
 . set edate=$$VAPALSDT^SAMICASE(efmdate)
"RTN","SAMIUR",514,0)
 . ;
"RTN","SAMIUR",515,0)
 . if type="followup" do  ;
"RTN","SAMIUR",516,0)
 . . ; new nplus30 set nplus30=$$FMADD^XLFDT($$NOW^XLFDT,31)
"RTN","SAMIUR",517,0)
 . . if +fmcefud<fmstrdt quit  ; before start date
"RTN","SAMIUR",518,0)
 . . if +fmcefud<(fmenddt+1) do  ; before end date
"RTN","SAMIUR",519,0)
 . . . quit:ceform=""  ; no ct eval so no followup date
"RTN","SAMIUR",520,0)
 . . . set SAMIPATS(fmcefud,zi,"edate")=edate
"RTN","SAMIUR",521,0)
 . . . set SAMIPATS(fmcefud,zi)=""
"RTN","SAMIUR",522,0)
 . . . if ceform="" set cefud="baseline"
"RTN","SAMIUR",523,0)
 . . . set SAMIPATS(fmcefud,zi,"cefud")=cefud
"RTN","SAMIUR",524,0)
 . . . set SAMIPATS(fmcefud,zi,"cedos")=cedos
"RTN","SAMIUR",525,0)
 . . . set SAMIPATS(fmcefud,zi,"ceform")=ceform
"RTN","SAMIUR",526,0)
 . . . set SAMIPATS(fmcefud,zi,"ceform-vals")=$name(@root@("graph",sid,ceform))
"RTN","SAMIUR",527,0)
 . . . set SAMIPATS(fmcefud,zi,"siform")=siform
"RTN","SAMIUR",528,0)
 . . . set SAMIPATS(fmcefud,zi,"siform-vals")=$name(@root@("graph",sid,siform))
"RTN","SAMIUR",529,0)
 . . . merge SAMIPATS(fmcefud,zi,"items")=items
"RTN","SAMIUR",530,0)
 . . . quit
"RTN","SAMIUR",531,0)
 . . set datephrase=" before "_$$VAPALSDT^SAMICASE(fmenddt)
"RTN","SAMIUR",532,0)
 . . quit
"RTN","SAMIUR",533,0)
 . ;
"RTN","SAMIUR",534,0)
 . if type="activity" do  ;
"RTN","SAMIUR",535,0)
 . . ; new nminus30 set nminus30=$$FMADD^XLFDT($$NOW^XLFDT,-31)
"RTN","SAMIUR",536,0)
 . . new anyform set anyform=$order(items("sort",""),-1)
"RTN","SAMIUR",537,0)
 . . new fmanyform set fmanyform=$$KEY2FM^SAMICASE(anyform)
"RTN","SAMIUR",538,0)
 . . if fmanyform<fmstrdt quit  ; before the start date
"RTN","SAMIUR",539,0)
 . . ; if fmanyform<(fmenddt+1)!(efmdate>fmenddt) do  ; need any new form
"RTN","SAMIUR",540,0)
 . . if fmanyform<(fmenddt+1)  do  ;
"RTN","SAMIUR",541,0)
 . . . set SAMIPATS(efmdate,zi,"edate")=edate
"RTN","SAMIUR",542,0)
 . . . set SAMIPATS(efmdate,zi)=""
"RTN","SAMIUR",543,0)
 . . . if ceform="" set cefud="baseline"
"RTN","SAMIUR",544,0)
 . . . set SAMIPATS(efmdate,zi,"cefud")=cefud
"RTN","SAMIUR",545,0)
 . . . set SAMIPATS(efmdate,zi,"cedos")=cedos
"RTN","SAMIUR",546,0)
 . . . set SAMIPATS(efmdate,zi,"ceform")=ceform
"RTN","SAMIUR",547,0)
 . . . set SAMIPATS(efmdate,zi,"siform")=siform
"RTN","SAMIUR",548,0)
 . . . merge SAMIPATS(efmdate,zi,"items")=items
"RTN","SAMIUR",549,0)
 . . . quit
"RTN","SAMIUR",550,0)
 . . set datephrase=" after "_$$VAPALSDT^SAMICASE(fmstrdt)
"RTN","SAMIUR",551,0)
 . . quit
"RTN","SAMIUR",552,0)
 . ;
"RTN","SAMIUR",553,0)
 . ; date filter for all the rest of the reports
"RTN","SAMIUR",554,0)
 . ;
"RTN","SAMIUR",555,0)
 . quit:efmdate<fmstrdt  ; before the start date
"RTN","SAMIUR",556,0)
 . quit:efmdate>(fmenddt+1)  ; after the end date
"RTN","SAMIUR",557,0)
 . ;
"RTN","SAMIUR",558,0)
 . if type="incomplete" do  ;
"RTN","SAMIUR",559,0)
 . . new complete set complete=1
"RTN","SAMIUR",560,0)
 . . new zj set zj=""
"RTN","SAMIUR",561,0)
 . . new gr set gr=$name(@root@("graph",sid))
"RTN","SAMIUR",562,0)
 . . for  do  quit:zj=""  ;
"RTN","SAMIUR",563,0)
 . . . set zj=$order(@gr@(zj))
"RTN","SAMIUR",564,0)
 . . . quit:zj=""
"RTN","SAMIUR",565,0)
 . . . if $get(@gr@(zj,"samistatus"))="incomplete" do  ;
"RTN","SAMIUR",566,0)
 . . . . set complete=0
"RTN","SAMIUR",567,0)
 . . . . set SAMIPATS(efmdate,zi,"iform")=$get(SAMIPATS(efmdate,zi,"iform"))_" "_zj
"RTN","SAMIUR",568,0)
 . . . . quit
"RTN","SAMIUR",569,0)
 . . . quit
"RTN","SAMIUR",570,0)
 . . ;
"RTN","SAMIUR",571,0)
 . . if complete=0 do  ; has incomplete form(s) 
"RTN","SAMIUR",572,0)
 . . . set SAMIPATS(efmdate,zi,"edate")=edate
"RTN","SAMIUR",573,0)
 . . . set SAMIPATS(efmdate,zi)=""
"RTN","SAMIUR",574,0)
 . . . if ceform="" set cefud="baseline"
"RTN","SAMIUR",575,0)
 . . . set SAMIPATS(efmdate,zi,"cefud")=cefud
"RTN","SAMIUR",576,0)
 . . . set SAMIPATS(efmdate,zi,"ceform")=ceform
"RTN","SAMIUR",577,0)
 . . . set SAMIPATS(efmdate,zi,"siform")=siform
"RTN","SAMIUR",578,0)
 . . . merge SAMIPATS(efmdate,zi,"items")=items
"RTN","SAMIUR",579,0)
 . . . quit
"RTN","SAMIUR",580,0)
 . . set datephrase=""
"RTN","SAMIUR",581,0)
 . . quit
"RTN","SAMIUR",582,0)
 . ;
"RTN","SAMIUR",583,0)
 . if type="missingct" do  ;
"RTN","SAMIUR",584,0)
 . . if ceform="" do  ; has incomplete form(s) 
"RTN","SAMIUR",585,0)
 . . . set SAMIPATS(efmdate,zi,"edate")=edate
"RTN","SAMIUR",586,0)
 . . . set SAMIPATS(efmdate,zi)=""
"RTN","SAMIUR",587,0)
 . . . if ceform="" set cefud="baseline"
"RTN","SAMIUR",588,0)
 . . . set SAMIPATS(efmdate,zi,"cefud")=cefud
"RTN","SAMIUR",589,0)
 . . . set SAMIPATS(efmdate,zi,"ceform")=ceform
"RTN","SAMIUR",590,0)
 . . . set SAMIPATS(efmdate,zi,"siform")=siform
"RTN","SAMIUR",591,0)
 . . . merge SAMIPATS(efmdate,zi,"items")=items
"RTN","SAMIUR",592,0)
 . . . quit
"RTN","SAMIUR",593,0)
 . . set datephrase=""
"RTN","SAMIUR",594,0)
 . . quit
"RTN","SAMIUR",595,0)
 . ;
"RTN","SAMIUR",596,0)
 . if type="outreach" do  ; no-op; hook for future development?
"RTN","SAMIUR",597,0)
 . . quit
"RTN","SAMIUR",598,0)
 . ;
"RTN","SAMIUR",599,0)
 . if type="enrollment" do  ;
"RTN","SAMIUR",600,0)
 . . set SAMIPATS(efmdate,zi,"edate")=edate
"RTN","SAMIUR",601,0)
 . . set SAMIPATS(efmdate,zi)=""
"RTN","SAMIUR",602,0)
 . . set SAMIPATS(efmdate,zi,"cefud")=cefud
"RTN","SAMIUR",603,0)
 . . set SAMIPATS(efmdate,zi,"ceform")=ceform
"RTN","SAMIUR",604,0)
 . . set SAMIPATS(efmdate,zi,"cedos")=cedos
"RTN","SAMIUR",605,0)
 . . set SAMIPATS(efmdate,zi,"siform")=siform
"RTN","SAMIUR",606,0)
 . . merge SAMIPATS(efmdate,zi,"items")=items
"RTN","SAMIUR",607,0)
 . . quit
"RTN","SAMIUR",608,0)
 . ;
"RTN","SAMIUR",609,0)
 . if type="inactive" do  ;
"RTN","SAMIUR",610,0)
 . . set SAMIPATS(efmdate,zi,"edate")=edate
"RTN","SAMIUR",611,0)
 . . set SAMIPATS(efmdate,zi)=""
"RTN","SAMIUR",612,0)
 . . set SAMIPATS(efmdate,zi,"cefud")=cefud
"RTN","SAMIUR",613,0)
 . . set SAMIPATS(efmdate,zi,"ceform")=ceform
"RTN","SAMIUR",614,0)
 . . set SAMIPATS(efmdate,zi,"cedos")=cedos
"RTN","SAMIUR",615,0)
 . . set SAMIPATS(efmdate,zi,"siform")=siform
"RTN","SAMIUR",616,0)
 . . merge SAMIPATS(efmdate,zi,"items")=items
"RTN","SAMIUR",617,0)
 . . quit
"RTN","SAMIUR",618,0)
 . ;
"RTN","SAMIUR",619,0)
 . set datephrase=" as of "_$$VAPALSDT^SAMICASE($$NOW^XLFDT)
"RTN","SAMIUR",620,0)
 . quit
"RTN","SAMIUR",621,0)
 ;
"RTN","SAMIUR",622,0)
 quit  ; end of SELECT
"RTN","SAMIUR",623,0)
 ;
"RTN","SAMIUR",624,0)
 ;
"RTN","SAMIUR",625,0)
 ;
"RTN","SAMIUR",626,0)
UNMAT(SAMIPATS,ztype,datephrase,filter) ; build unmatched persons list
"RTN","SAMIUR",627,0)
 ;
"RTN","SAMIUR",628,0)
 ;@called-by
"RTN","SAMIUR",629,0)
 ; SELECT
"RTN","SAMIUR",630,0)
 ;@calls
"RTN","SAMIUR",631,0)
 ; $$setroot^%wd
"RTN","SAMIUR",632,0)
 ;
"RTN","SAMIUR",633,0)
 set datephrase="Unmatched Persons"
"RTN","SAMIUR",634,0)
 new lroot set lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIUR",635,0)
 new dfn set dfn=9000000
"RTN","SAMIUR",636,0)
 for  do  quit:'dfn  ;
"RTN","SAMIUR",637,0)
 . set dfn=$order(@lroot@("dfn",dfn))
"RTN","SAMIUR",638,0)
 . quit:'dfn
"RTN","SAMIUR",639,0)
 . ;
"RTN","SAMIUR",640,0)
 . new ien set ien=$order(@lroot@("dfn",dfn,""))
"RTN","SAMIUR",641,0)
 . quit:ien=""
"RTN","SAMIUR",642,0)
 . n ordern
"RTN","SAMIUR",643,0)
 . s ordern=$g(@lroot@(ien,"ORMORCordernumber"))
"RTN","SAMIUR",644,0)
 . i ordern="" s ordern=$g(@lroot@(ien,"ORM",1,"ordernumber"))
"RTN","SAMIUR",645,0)
 . i ordern'="" q  ;
"RTN","SAMIUR",646,0)
 . i $g(@lroot@(ien,"siteid"))'[site q  ;
"RTN","SAMIUR",647,0)
 . ;quit:$get(@lroot@(ien,"remotedfn"))'=""  ;
"RTN","SAMIUR",648,0)
 . ;
"RTN","SAMIUR",649,0)
 . merge SAMIPATS(ien,dfn)=@lroot@(ien)
"RTN","SAMIUR",650,0)
 . ;
"RTN","SAMIUR",651,0)
 . new name set name=$get(SAMIPATS(ien,dfn,"saminame"))
"RTN","SAMIUR",652,0)
 . ; new name set name=$get(SAMIPATS(ien,dfn,"sinamef"))
"RTN","SAMIUR",653,0)
 . ; set name=name_","_SAMIPATS(ien,dfn,"sinamel")
"RTN","SAMIUR",654,0)
 . new nuhref set nuhref="<form method=POST action=""/vapals"">"
"RTN","SAMIUR",655,0)
 . set nuhref=nuhref_"<input type=hidden name=""samiroute"" value=""editperson"">"
"RTN","SAMIUR",656,0)
 . set nuhref=nuhref_"<input type=hidden name=""dfn"" value="_dfn_">"
"RTN","SAMIUR",657,0)
 . set nuhref=nuhref_"<input value="""_name_""" class=""btn btn-link"" role=""link"" type=""submit""></form>"
"RTN","SAMIUR",658,0)
 . set SAMIPATS(ien,dfn,"editref")=nuhref
"RTN","SAMIUR",659,0)
 . quit
"RTN","SAMIUR",660,0)
 ;
"RTN","SAMIUR",661,0)
 quit  ; end of UNMAT
"RTN","SAMIUR",662,0)
 ;
"RTN","SAMIUR",663,0)
 ;
"RTN","SAMIUR",664,0)
 ;
"RTN","SAMIUR",665,0)
WKLIST(SAMIPATS,ztype,datephrase,filter) ; build work list
"RTN","SAMIUR",666,0)
 ;
"RTN","SAMIUR",667,0)
 ;@called-by
"RTN","SAMIUR",668,0)
 ; SELECT
"RTN","SAMIUR",669,0)
 ;@calls
"RTN","SAMIUR",670,0)
 ; $$setroot^%wd
"RTN","SAMIUR",671,0)
 ;
"RTN","SAMIUR",672,0)
 ; add site
"RTN","SAMIUR",673,0)
 ; add compare to vapals-patients
"RTN","SAMIUR",674,0)
 ; add navigation to enrollment
"RTN","SAMIUR",675,0)
 ;
"RTN","SAMIUR",676,0)
 kill ^gpl("worklist")
"RTN","SAMIUR",677,0)
 merge ^gpl("worklist")=filter
"RTN","SAMIUR",678,0)
 new site
"RTN","SAMIUR",679,0)
 set site=$get(filter("siteid"))
"RTN","SAMIUR",680,0)
 quit:site=""
"RTN","SAMIUR",681,0)
 set datephrase="Work List"
"RTN","SAMIUR",682,0)
 new lroot set lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIUR",683,0)
 new proot set proot=$$setroot^%wd("vapals-patients")
"RTN","SAMIUR",684,0)
 ;
"RTN","SAMIUR",685,0)
 new dfn set dfn=0
"RTN","SAMIUR",686,0)
 for  set dfn=$order(@lroot@("dfn",dfn)) quit:+dfn=0  do  ;
"RTN","SAMIUR",687,0)
 . quit:$order(@proot@("dfn",dfn,""))'=""
"RTN","SAMIUR",688,0)
 . new ien set ien=$order(@lroot@("dfn",dfn,""))
"RTN","SAMIUR",689,0)
 . quit:ien=""
"RTN","SAMIUR",690,0)
 . ;
"RTN","SAMIUR",691,0)
 . ; write !,"dfn= ",dfn
"RTN","SAMIUR",692,0)
 . ; zwrite @lroot@(ien,*)
"RTN","SAMIUR",693,0)
 . ;
"RTN","SAMIUR",694,0)
 . quit:$get(@lroot@(ien,"siteid"))'=site
"RTN","SAMIUR",695,0)
 . ;
"RTN","SAMIUR",696,0)
 . merge ^gpl("worklist","lroot",ien)=@lroot@(ien)
"RTN","SAMIUR",697,0)
 . merge SAMIPATS(ien,dfn)=@lroot@(ien)
"RTN","SAMIUR",698,0)
 . new name set name=$get(SAMIPATS(ien,dfn,"saminame"))
"RTN","SAMIUR",699,0)
 . ; new name set name=$get(SAMIPATS(ien,dfn,"sinamef"))
"RTN","SAMIUR",700,0)
 . ; set name=name_","_SAMIPATS(ien,dfn,"sinamel")
"RTN","SAMIUR",701,0)
 . new nuhref set nuhref="<form method=POST action=""/vapals"">"
"RTN","SAMIUR",702,0)
 . set nuhref=nuhref_"<input type=hidden name=""samiroute"" value=""newcase"">"
"RTN","SAMIUR",703,0)
 . set nuhref=nuhref_"<input type=hidden name=""dfn"" value="_dfn_">"
"RTN","SAMIUR",704,0)
 . set nuhref=nuhref_"<input type=hidden name=""siteid"" value="_site_">"
"RTN","SAMIUR",705,0)
 . set nuhref=nuhref_"<input value="""_name_""" class=""btn btn-link"" role=""link"" type=""submit""></form>"
"RTN","SAMIUR",706,0)
 . set SAMIPATS(ien,dfn,"workref")=nuhref
"RTN","SAMIUR",707,0)
 . quit
"RTN","SAMIUR",708,0)
 ;
"RTN","SAMIUR",709,0)
 merge ^gpl("worklist","pats")=SAMIPATS
"RTN","SAMIUR",710,0)
 ;
"RTN","SAMIUR",711,0)
 quit  ; end of WKLIST
"RTN","SAMIUR",712,0)
 ;
"RTN","SAMIUR",713,0)
 ;
"RTN","SAMIUR",714,0)
 ;
"RTN","SAMIUR",715,0)
EOR ; end of SAMIUR
"SEC","^DIC",311.12,311.12,0,"AUDIT")
@
"SEC","^DIC",311.12,311.12,0,"DD")
@
"SEC","^DIC",311.12,311.12,0,"DEL")
@
"SEC","^DIC",311.12,311.12,0,"LAYGO")
@
"SEC","^DIC",311.12,311.12,0,"RD")
@
"SEC","^DIC",311.12,311.12,0,"WR")
@
"SEC","^DIC",311.14,311.14,0,"AUDIT")
@
"SEC","^DIC",311.14,311.14,0,"DD")
@
"SEC","^DIC",311.14,311.14,0,"DEL")
@
"SEC","^DIC",311.14,311.14,0,"LAYGO")
@
"SEC","^DIC",311.14,311.14,0,"RD")
@
"SEC","^DIC",311.14,311.14,0,"WR")
@
"VER")
8.0^22.2
"^DD",311.12,311.12,0)
FIELD^^.04^5
"^DD",311.12,311.12,0,"DT")
3210530
"^DD",311.12,311.12,0,"ID","W.02")
W "   ",$P(^(0),U,2)
"^DD",311.12,311.12,0,"IX","B",311.12,.01)

"^DD",311.12,311.12,0,"NM","SAMI SITE")

"^DD",311.12,311.12,0,"VRPK")
SAMI
"^DD",311.12,311.12,.01,0)
SITE^RP4'^DIC(4,^0;1^Q
"^DD",311.12,311.12,.01,.1)
SAMI SITE
"^DD",311.12,311.12,.01,1,0)
^.1
"^DD",311.12,311.12,.01,1,1,0)
311.12^B
"^DD",311.12,311.12,.01,1,1,1)
S ^SAMI(311.12,"B",$E(X,1,30),DA)=""
"^DD",311.12,311.12,.01,1,1,2)
K ^SAMI(311.12,"B",$E(X,1,30),DA)
"^DD",311.12,311.12,.01,3)
NAME MUST BE 3-30 CHARACTERS, NOT NUMERIC OR STARTING WITH PUNCTUATION
"^DD",311.12,311.12,.01,"DT")
3200325
"^DD",311.12,311.12,.02,0)
SYMBOL^FJ3^^0;2^K:$L(X)>3!($L(X)<1) X
"^DD",311.12,311.12,.02,.1)
SITE SYMBOL
"^DD",311.12,311.12,.02,3)
Answer must be 1-3 characters in length.
"^DD",311.12,311.12,.02,"DT")
3200407
"^DD",311.12,311.12,.03,0)
ACTIVE^St11^^3;3^
"^DD",311.12,311.12,.03,.1)
IS THE SITE ACTIVE
"^DD",311.12,311.12,.03,"DT")
3200327
"^DD",311.12,311.12,.04,0)
DEFAULT PARAMETERS^P311.14'^SAMI(311.14,^5;1^Q
"^DD",311.12,311.12,.04,.1)
PARAMETER DEFAULT
"^DD",311.12,311.12,.04,"DT")
3210423
"^DD",311.12,311.12,1,0)
PARMS^311.121^^4;0
"^DD",311.12,311.121,0)
PARMS SUB-FIELD^^.02^2
"^DD",311.12,311.121,0,"DT")
3210419
"^DD",311.12,311.121,0,"IX","B",311.121,.01)

"^DD",311.12,311.121,0,"NM","PARMS")

"^DD",311.12,311.121,0,"UP")
311.12
"^DD",311.12,311.121,.01,0)
PARM^MFJ30^^0;1^K:$L(X)>30!($L(X)<1) X
"^DD",311.12,311.121,.01,.1)
PARAMETER
"^DD",311.12,311.121,.01,1,0)
^.1
"^DD",311.12,311.121,.01,1,1,0)
311.121^B
"^DD",311.12,311.121,.01,1,1,1)
S ^SAMI(311.12,DA(1),4,"B",$E(X,1,30),DA)=""
"^DD",311.12,311.121,.01,1,1,2)
K ^SAMI(311.12,DA(1),4,"B",$E(X,1,30),DA)
"^DD",311.12,311.121,.01,3)
Answer must be 1-30 characters in length.
"^DD",311.12,311.121,.01,"DT")
3210423
"^DD",311.12,311.121,.02,0)
VALUE^FJ180^^0;2^K:$L(X)>180!($L(X)<1) X
"^DD",311.12,311.121,.02,.1)
VALUE OF PARAMETER
"^DD",311.12,311.121,.02,3)
Answer must be 1-180 characters in length.
"^DD",311.12,311.121,.02,"DT")
3210423
"^DD",311.14,311.14,0)
FIELD^^1^2
"^DD",311.14,311.14,0,"DT")
3210530
"^DD",311.14,311.14,0,"IX","B",311.14,.01)

"^DD",311.14,311.14,0,"NM","SAMI PARAMETER DEFAULTS")

"^DD",311.14,311.14,0,"PT",311.12,.04)

"^DD",311.14,311.14,.01,0)
NAME^RFJ30^^0;1^K:$L(X)>30!($L(X)<3)!'(X'?1P.E) X
"^DD",311.14,311.14,.01,.1)
DEFAULT PARAMETER SET NAME
"^DD",311.14,311.14,.01,1,0)
^.1
"^DD",311.14,311.14,.01,1,1,0)
311.14^B
"^DD",311.14,311.14,.01,1,1,1)
S ^SAMI(311.14,"B",$E(X,1,30),DA)=""
"^DD",311.14,311.14,.01,1,1,2)
K ^SAMI(311.14,"B",$E(X,1,30),DA)
"^DD",311.14,311.14,.01,3)
Answer must be 3-30 characters in length.
"^DD",311.14,311.14,.01,"DT")
3210419
"^DD",311.14,311.14,1,0)
PARM^311.141^^1;0
"^DD",311.14,311.141,0)
PARM SUB-FIELD^^.02^2
"^DD",311.14,311.141,0,"DT")
3210419
"^DD",311.14,311.141,0,"IX","B",311.141,.01)

"^DD",311.14,311.141,0,"NM","PARM")

"^DD",311.14,311.141,0,"UP")
311.14
"^DD",311.14,311.141,.01,0)
PARM^MMFJ30^^0;1^K:$L(X)>30!($L(X)<1) X
"^DD",311.14,311.141,.01,.1)
PARAMETER NAME
"^DD",311.14,311.141,.01,1,0)
^.1
"^DD",311.14,311.141,.01,1,1,0)
311.141^B
"^DD",311.14,311.141,.01,1,1,1)
S ^SAMI(311.14,DA(1),1,"B",$E(X,1,30),DA)=""
"^DD",311.14,311.141,.01,1,1,2)
K ^SAMI(311.14,DA(1),1,"B",$E(X,1,30),DA)
"^DD",311.14,311.141,.01,3)
Answer must be 1-30 characters in length.
"^DD",311.14,311.141,.01,"DT")
3210420
"^DD",311.14,311.141,.02,0)
VALUE^FJ180^^0;2^K:$L(X)>180!($L(X)<1) X
"^DD",311.14,311.141,.02,.1)
PARAMETER VALUE
"^DD",311.14,311.141,.02,3)
Answer must be 1-180 characters in length.
"^DD",311.14,311.141,.02,"DT")
3210419
"^DIC",311.12,311.12,0)
SAMI SITE^311.12
"^DIC",311.12,311.12,0,"GL")
^SAMI(311.12,
"^DIC",311.12,311.12,"%",0)
^1.005^^0
"^DIC",311.12,"B","SAMI SITE",311.12)

"^DIC",311.14,311.14,0)
SAMI PARAMETER DEFAULTS^311.14
"^DIC",311.14,311.14,0,"GL")
^SAMI(311.14,
"^DIC",311.14,"B","SAMI PARAMETER DEFAULTS",311.14)

**END**
**END**
